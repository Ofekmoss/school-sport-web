define(["templates/admin","utils","dialog","consts","components/multiselect","generic/data-table"],function(e,u,t,n){function s(s,a){s.championships.splice(0,s.championships.length),Vue.http.get("/api/v2/admin/championships?season="+s.season).then(function(e){for(var t=0;t<e.body.length;t++)s.championships.push(e.body[t]);Vue.http.get("/api/v2/admin/championships?clubs=1&season="+s.season).then(function(e){for(var t=0;t<e.body.length;t++){var n=e.body[t];s.championships.findIndex(function(e){return e.id===n.id})<0&&s.championships.push(n)}Vue.http.get("/api/v2/admin/championships?league=1&season="+s.season).then(function(e){for(var t=0;t<e.body.length;t++){var n=e.body[t];s.championships.findIndex(function(e){return e.id===n.id})<0&&s.championships.push(n)}a()},function(e){a(e)})},function(e){a(e)})},function(e){a(e)})}function a(n,s){n.sports.splice(0,n.sports.length),Vue.http.get("/api/v2/admin/competitions?season="+n.season).then(function(e){for(var t=0;t<e.body.sports.length;t++)n.sports.push(e.body.sports[t]);s()},function(e){s(e)})}function l(e){return 0<=e&&e<10?"0"+e:e.toString()}function o(e,t){var n=e.split("T"),s=n[0].split("-"),a=n[1].split(":");a[2]=a[2].substring(0,2);var i=parseInt(s[0],10),o=parseInt(s[1],10)-1,r=parseInt(s[2],10),p=parseInt(a[0],10),h=parseInt(a[1],10),c=parseInt(a[2],10);return t.replace("DD",l(r)).replace("MM",l(o)).replace("YYYY",i).replace("HH",l(p)).replace("mm",l(h)).replace("ss",l(c))}function i(a,i){void 0!==i&&null!=i||(i=new Function);var e=[];a.season&&e.push("season="+a.season),a.championship?e.push("championship="+a.championship):(a.competitionType&&(1===parseInt(a.competitionType)?e.push("clubs=1"):e.push("league=1")),a.region&&e.push("region="+a.region),a.sport&&e.push("sport="+a.sport));var t="/api/v2/admin/players"+(0<e.length?"?"+e.join("&"):"");Vue.http.get(t).then(function(e){a.players=[];for(var t=0;t<e.body.length;t++){var n=e.body[t];if(null==n.approved&&(n.approved=0),n.TransferRequested&&(n.playerStatus=5),n.maxStudentAge){var s=new Date(n.maxStudentAge);new Date(n.student.birthDate)<s&&(n.highlighted=!0)}n.deletedAt&&(n.playerStatus=9,n.red=!0,n.highlighted=!1,n.tooltip="רישום הוסר בתאריך "+o(n.deletedAt,"DD/MM/YYYY")+" בשעה "+o(n.deletedAt,"HH:mm")),a.players.push(n)}u.readServerCache(["isf-overage","overage"],!0,function(e,t){if(e)console.log(e);else{var p=a.season,n=t["isf-overage"],s=t.overage,h=u.parseIsfOverageItems(n),c=u.parseIsfOverageItems(s),l=!1;a.players.forEach(function(e){if(e.championship&&e.championship.sport&&null!=e.student.birthDate&&0<e.student.birthDate.toString().length){var t=e.championship.sport.id,n=e.championship.category.category,s=h.find(function(e){return e.season==p&&e.sport==t&&e.category==n}),a=c.find(function(e){return e.season==p&&(0==e.sport||e.sport==t)&&e.category==n});if(null!=s){var i=u.parseDate(s.rangeStart),o=u.parseDate(s.rangeEnd),r=new Date(e.student.birthDate);e.isfOverage=i<=r&&r<=o,e.isfOverage&&(l=!0)}if(null!=a){o=u.parseDate(a.rangeEnd),r=new Date(e.student.birthDate);e.aboveMaxAge=r<o,e.aboveMaxAge&&(l=!0)}}}),l&&a.$forceUpdate()}i()})},function(e){a.players=[],console.log(e),i()})}function r(e){!function(n,s){n.seasons.splice(0,n.seasons.length),Vue.http.get("/api/v2/manage/seasons").then(function(e){for(var t=0;t<e.body.length;t++)n.seasons.push(e.body[t]);Vue.http.get("/api/v2/cache?key=season").then(function(e){var t=e.body.Value;null!=t?(n.season=t,s()):Vue.http.get("/api/v2/season").then(function(e){var t=e.body.season;t&&(n.season=t),s()},function(e){s(e)})},function(e){s(e)})},function(e){s(e)})}(e,function(){!function(n,s){n.regions.splice(0,n.regions.length),Vue.http.get("/api/v2/regions").then(function(e){for(var t=0;t<e.body.length;t++)n.regions.push(e.body[t]);s()},function(e){s(e)})}(e,function(){s(e,function(){a(e,function(){i(e,function(){})})})})})}return Vue.extend({template:e.players,props:{region:{},sport:{}},data:function(){var n={1:"רשום",2:"אושר",3:"לא אושר",5:"ממתין לאישור העברה",9:"רישום הוסר"},s={0:"א'",1:"ב'",2:"ג'",3:"ד'",4:"ה'",5:"ו'",6:"ז'",7:"ח'",8:"ט'",9:"י'",10:'י"א',11:'י"ב'};return{tabName:"שחקנים",caption:"שחקנים",competitionType:1,teams:[],players:[],columns:[{key:"student.firstName",name:"שם פרטי",active:!0},{key:"student.lastName",name:"שם משפחה",active:!0},{key:"student.birthDate",name:"תאריך לידה",type:"date",maxAge:!0,active:!0},{key:"student.grade",name:"כיתה",active:!0,lookup:s,getter:function(e){var t=e.student.grade;return null!=t&&s[t.toString()]||""},getSortValue:function(e){return e.student.grade||0}},{key:"student.idNumber",name:"מספר זהות",active:!0},{key:"createdAt",name:"תאריך הוספה",type:"date",active:!0},{key:"team.name",name:"שם קבוצה",active:!0},{key:"team.number",name:"קבוצה",active:!0},{key:"championship.region.name",name:"מחוז",active:!0},{key:"school.symbol",name:"סימול בית ספר",active:!0},{key:"championship.name",name:"אליפות",active:!0},{key:"championship.sport.name",name:"ענף ספורט",active:!1},{key:"championship.category.name",name:"קטגוריה",active:!1,type:""},{name:"סטטוס",key:"playerStatus",active:!0,type:"",tooltip:!0,lookup:n,getter:function(e){var t=e.playerStatus||0;return n[t.toString()]||""}},{name:"תמונה",key:"picture",active:!0,type:"imageLink"},{name:"בדיקה רפואית",key:"medicalApproval",active:!0,type:"imageLink"},{name:'ספח ת"ז',key:"idSlip",active:!0,type:"imageLink"}],championships:[],competitions:[],sports:[],regions:[],seasons:[],season:null,championship:null,searchText:"",isSelectAll:!1,selectedStatus:null,selectedPlayers:[]}},mounted:function(){r(this)},computed:{filteredChampionships:function(){for(var e=[],t=0;t<this.championships.length;t++){var n=this.championships[t];if(this.competitionType)if(1==this.competitionType){if(!n.clubs)continue}else if(2==this.competitionType&&!n.league)continue;null!=this.region&&""!==this.region&&n.region.id!==this.region||(null!=this.sport&&""!==this.sport&&n.sport.id!==this.sport||e.push(n))}return e}},watch:{competitionType:function(){i(this)},championship:function(){i(this)},sport:function(){this.updateCaption(),i(this)},region:function(){this.updateCaption(),i(this)},season:function(){var e=this;s(e,function(){a(e,function(){i(e)})})}},methods:{updateCaption:function(){var e="שחקנים";if(null!=this.region&&this.regions)for(var t=0;t<this.regions.length;t++){var n=this.regions[t];if(n.id==this.region){e+=" - "+n.name;break}}if(null!=this.sport&&this.sports)for(t=0;t<this.sports.length;t++){var s=this.sports[t];if(s.id==this.sport){e+=" - "+s.name;break}}this.caption=e},handleSelectionChange:function(){this.selectedPlayers.splice(0,this.selectedPlayers.length),this.selectedStatus=null;for(var e=0;e<this.players.length;e++){var t=this.players[e];t.selected&&(0===this.selectedPlayers.length?this.selectedStatus=t.playerStatus:this.selectedStatus!=t.playerStatus&&(this.selectedStatus=null),this.selectedPlayers.push(t))}},changeStatus:function(i){for(var o=this,e=[],t=0;t<o.selectedPlayers.length;){var n=o.selectedPlayers[t];n.player?(e.push({player:n.player}),t++):n.team.team&&n.id?(e.push({team:n.team.team,studentId:n.id}),t++):(n.selected=!1,o.selectedPlayers.splice(t,1))}Vue.http.post("/api/v2/admin/players/status",{players:e,status:i}).then(function(e){for(var t=0;t<e.body.length;t++)for(var n=e.body[t],s=0;s<o.selectedPlayers.length;s++){var a=o.selectedPlayers[s];if(a.id===n.studentId&&a.team.team===n.team){a.player=n.player;break}}o.selectedStatus=i;for(t=0;t<o.selectedPlayers.length;t++)o.selectedPlayers[t].playerStatus=i},function(e){console.log(e)})}}})});