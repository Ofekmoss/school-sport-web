define(["templates/admin","views","dialog","generic/data-table"],function(t,e,a){var i=[{id:1,name:"זוזו",link:"zuzu"},{id:2,name:'פכ"ל',link:"pcl"},{id:3,name:'פל"א',link:"pele"},{id:5,name:"שווים בספורט",link:"sportEqual"}];function s(o,a){void 0===a&&(a=null),o.project?Vue.http.get("/api/v2/admin/projects/"+o.project.id+"/registrations?season="+o.season).then(function(t){o.registrations.splice(0,o.registrations.length);for(var e=0;e<t.data.length;e++){var n=t.data[e];if(null!=n.city&&n.city.id&&o.cityMap){var i=o.cityMap[n.city.id];i&&(n.city.user=i.user)}o.registrations.push(n)}o.registrations.sort(function(t,e){return t.city.name.localeCompare(e.city.name)}),null!=a&&a()},function(t){console.log(t),null!=a&&a()}):(o.registrations.splice(0,o.registrations.length),null!=a&&a())}return Vue.extend({template:t.project,props:{id:{}},data:function(){return{tabName:"כללי",caption:"תכניות",updating:!1,projects:i,project:null,mounting:!0,columns:[{key:"city.name",name:"שם רשות",active:!0},{key:"region.name",name:"מחוז",active:!0},{key:"items",name:"ענפי ספורט",active:!0,width:20},{key:"schoolCount",name:"בתי ספר",active:!0},{key:"teamCount",name:"כיתות",active:!0},{key:"studentCount",name:"תלמידים",active:!0}],cities:[],registrations:[],seasons:[],season:null,enableAdd:!1,selectedRegistration:null,city:""}},mounted:function(){var t=this;if(t.id)for(var e=0;e<i.length;e++){var n=i[e];if(t.id==n.id){t.project=n;break}}this.updateCaption(),function(i,o){void 0===o&&(o=null),i.seasons=[],Vue.http.get("/api/v2/manage/seasons").then(function(t){for(var e=0;e<t.body.length;e++)i.seasons.push(t.body[e]);Vue.http.get("/api/v2/season").then(function(t){var e=t.body.season;e&&(i.season=e),Vue.http.get("/api/v2/cities?season="+i.season).then(function(t){i.cityMap={},i.cities.splice(0,i.cities.length);for(var e=0;e<t.data.length;e++){var n=t.data[e];i.cityMap[n.id]=n,i.cities.push(n)}i.cities.sort(function(t,e){return t.name.localeCompare(e.name)}),s(i,o)},function(t){console.log(t),null!=o&&o()})})})}(t,function(){t.mounting=!1})},methods:{updateCaption:function(){var t=this;t.project?t.caption="תכנית - "+t.project.name:t.caption="תכניות"},handleSelectionChange:function(t){this.selectedRegistration=t},selectProject:function(t){t?e.openView("admin/project",{id:t.id}):e.openView("admin/project")},goToCities:function(){e.openView("admin/cities")},goToGeneralSettings:function(){e.openView("admin/general-settings",{type:1})},goToProjectTeams:function(t){e.openView("project-supervisor/project-teams-approval?"+t.link)},removeRegistration:function(){var n=this;this.selectedRegistration&&a.open("general/message-box",{caption:"מחיקת רשות מתכנית",message:"האם למחוק רשות <strong>"+this.selectedRegistration.city.name+"</strong> מתכנית "+this.project.name+"?",alert:!0,confirmText:"כן",cancelText:"לא"},function(t,e){t||!0!==e||(n.updating=!0,Vue.http.delete("/api/v2/admin/projects/"+n.project.id+"/registrations/"+n.selectedRegistration.id).then(function(t){n.updating=!1;var e=n.registrations.indexOf(n.selectedRegistration);n.registrations.splice(e,1),n.selectedRegistration=null},function(t){n.updating=!1,console.log(t)}))})},updateProjectColumns:function(){for(var t,e,n,i=this,o=0;o<i.columns.length;o++){var a=i.columns[o];"items"===a.key?t=a:"teamCount"===a.key?e=a:"schoolCount"===a.key&&(n=a)}!i.project||"pele"!==i.project.link&&"sportEqual"!==i.project.link?(e.name="כיתות",t.name="ענפי ספורט",delete t.getter,Vue.set(n,"disabled",!1)):(e.name="קבוצות",t.name="נתוני אוכלוסיה",console.log(i.project),t.getter=function(t){if(t.items)try{var e=JSON.parse(t.items);return 5==i.project.id?"תושבים: "+(null==e.tp?"":e.tp)+",  עם מוגבלויות: "+(null==e.tmc?"":e.tmc):"תושבים: "+(null==e.tp?"":e.tp)+", יוצאי אתיופיה:"+(null==e.ep?"":e.ep)+"<br/>ילדים: "+(null==e.cp?"":e.cp)+", יוצאי אתיופיה: "+(null==e.ecp?"":e.ecp)}catch(t){}return null},Vue.set(n,"disabled",!0))},addRegistration:function(){for(var i=this,t={},e=0;e<this.registrations.length;e++){t[this.registrations[e].city.id]=!0}var n=[];for(e=0;e<this.cities.length;e++){var o=this.cities[e];t[o.id]||n.push(o)}a.open("admin/project/add-city",{cities:n},function(t,e){if(!t&&e&&null!=e.city){if(i.updating=!0,e.user){var n=i.cityMap[e.city];n&&(n.user=e.user)}Vue.http.post("/api/v2/admin/projects/"+i.project.id+"/registrations",{city:e.city}).then(function(t){i.updating=!1,i.registrations.push(t.data),i.registrations.sort(function(t,e){return t.city.name.localeCompare(e.city.name)}),i.city=""},function(t){i.updating=!1,console.log(t)})}})}},watch:{project:function(){this.updateProjectColumns(),s(this)},season:function(){this.mounting||(Vue.http.post("/api/v2/registration/season",{season:this.season}).then(function(t){},function(t){}),s(this))}}})});