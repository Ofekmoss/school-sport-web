define(["templates/admin","utils","dialog","consts","services/access","components/multiselect","generic/data-table"],function(e,a,t,s,i){function n(i,a){i.championships.splice(0,i.championships.length),Vue.http.get("/api/v2/admin/championships?season="+i.season).then(function(e){for(var t=0;t<e.body.length;t++)i.championships.push(e.body[t]);Vue.http.get("/api/v2/admin/championships?clubs=1&season="+i.season).then(function(e){for(var t=0;t<e.body.length;t++){var n=e.body[t];i.championships.findIndex(function(e){return e.id===n.id})<0&&i.championships.push(n)}Vue.http.get("/api/v2/admin/championships?league=1&season="+i.season).then(function(e){for(var t=0;t<e.body.length;t++){var n=e.body[t];i.championships.findIndex(function(e){return e.id===n.id})<0&&i.championships.push(n)}a()},function(e){a(e)})},function(e){a(e)})},function(e){a(e)})}function o(n,i){n.sports.splice(0,n.sports.length);var e="/api/v2/admin/competitions?season="+n.season;null!=n.region&&(e+="&region="+n.region),Vue.http.get(e).then(function(e){for(var t=0;t<e.body.sports.length;t++)n.sports.push(e.body.sports[t]);n.updateCaption(),i()},function(e){i(e)})}function c(e,t){for(var n=0;n<e.length;n++){var i=e[n];if(i.id===t)return i}return null}function r(i){var e=[];i.season&&e.push("season="+i.season),i.championship?e.push("championship="+i.championship):(i.competitionType&&(1===parseInt(i.competitionType)?e.push("clubs=1"):e.push("league=1")),null!=i.region&&e.push("region="+i.region),i.sport&&e.push("sport="+i.sport)),i.teams.splice(0,i.teams.length),Vue.http.get("/api/v2/admin/teams"+(0<e.length?"?"+e.join("&"):"")).then(function(e){i.teams=[];for(var t=0;t<e.body.length;t++){var n=e.body[t];n.sport=c(i.sports,n.sport),n.sport&&(n.category=c(n.sport.categories,n.competition)),n.category&&n.school.region&&(n.school.region=s.coordinators[n.school.region].areaName),n.activity&&(n.activity=a.getActivityText(n.activity)),2==n.teamStatus&&15==n.approved&&(n.green=!0),n.tokens&&n.tokens.principal&&(n.principalLoginLink="https://www.schoolsport.org.il/v2/#/login?token="+n.tokens.principal),n.tokens&&n.tokens.representative&&(n.representativeLoginLink="https://www.schoolsport.org.il/v2/#/login?token="+n.tokens.representative),i.teams.push(n)}i.teams.sort(function(e,t){return new Date(t.createdAt)-new Date(e.createdAt)})},function(e){console.log(e)})}function p(e){!function(n,i){n.seasons.splice(0,n.seasons.length),Vue.http.get("/api/v2/manage/seasons").then(function(e){for(var t=0;t<e.body.length;t++)n.seasons.push(e.body[t]);Vue.http.get("/api/v2/cache?key=season").then(function(e){var t=e.body.Value;null!=t?(n.season=t,i()):Vue.http.get("/api/v2/season").then(function(e){var t=e.body.season;t&&(n.season=t),i()},function(e){i(e)})},function(e){i(e)})},function(e){i(e)})}(e,function(){!function(n,i){n.regions.splice(0,n.regions.length),Vue.http.get("/api/v2/regions").then(function(e){for(var t=0;t<e.body.length;t++)n.regions.push(e.body[t]);n.updateCaption(),i()},function(e){i(e)})}(e,function(){n(e,function(){o(e,function(){r(e)})})})})}return Vue.extend({template:e.teams,props:{sport:{},region:{}},data:function(){return{tabName:"קבוצות",caption:"קבוצות",image:"img/icon-teams.svg",competitionType:1,teams:[],user:null,columns:[{key:"id",name:"זיהוי",active:!0},{key:"school.name",name:"בית ספר",active:!0},{key:"teamNumber",name:"קבוצה",active:!0},{key:"school.regionName",name:"מחוז",active:!0},{key:"school.symbol",name:"סימול בית ספר",active:!0},{key:"coach.name",name:"מאמן",active:!0},{key:"coach.email",name:"אימייל מאמן",active:!1},{key:"coach.phoneNumber",name:"טלפון מאמן",active:!0},{key:"coach.certification",name:"המאמן עבר השתלמות",lookup:{0:"לא",1:"כן"},active:!1},{key:"facility.name",name:"מתקן",active:!0},{key:"facility.address",name:"כתובת מתקן",active:!1},{key:"alternativeFacility.name",name:"מתקן חלופי",active:!1},{key:"alternativeFacility.address",name:"כתובת מתקן חלופי",active:!1},{key:"school.principal",name:"מנהל/ת",active:!1},{key:"teacher.name",name:"מורה אחראי",active:!1},{key:"teacher.phoneNumber",name:"טלפון מורה אחראי",active:!1},{key:"teacher.email",name:"מייל מורה אחראי",active:!1},{key:"activity",name:"יום ושעת משחק",active:!0},{key:"sport.name",name:"ענף ספורט",active:!0},{key:"category.name",name:"קטגוריה",active:!0},{key:"order",name:"דרישת תשלום",type:"documentNumber",active:!0},{name:"סטטוס",key:"teamStatus",active:!0,type:"",lookup:{1:"רשומה",2:"מאושרת"}},{key:"approved",name:"אישור נציג",type:"teamApproved",extras:{approved:4},active:!0},{key:"representativeLoginLink",name:"לינק התחברות נציג",type:"link",active:!0},{key:"approved",name:"אישור מנהל",type:"teamApproved",extras:{approved:2},active:!0},{key:"principalLoginLink",name:"לינק התחברות מנהל",type:"link",active:!0},{key:"approved",name:"אישור מפקח",type:"teamApproved",extras:{approved:8,notApproved:16},active:!0},{key:"principal.name",name:"מנהל",active:!1},{key:"principal.email",name:"אימייל מנהל",active:!1},{key:"principal.phoneNumber",name:"טלפון מנהל",active:!1},{key:"chairman.name",name:'יו"ר',active:!1},{key:"chairman.email",name:'אימייל יו"ר',active:!1},{key:"chairman.phoneNumber",name:'טלפון יו"ר',active:!1},{key:"coordinator.name",name:"רכז",active:!1},{key:"coordinator.email",name:"אימייל רכז",active:!1},{key:"coordinator.phoneNumber",name:"טלפון רכז",active:!1},{key:"representative.name",name:"נציג",active:!1},{key:"representative.email",name:"אימייל נציג",active:!1},{key:"representative.phoneNumber",name:"טלפון נציג",active:!1},{key:"createdAt",name:"תאריך הוספה",active:!1,type:"date"}],championships:[],competitions:[],sports:[],regions:[],seasons:[],season:null,championship:null,searchText:"",isSelectAll:!1,statuses:[{id:1,name:"אושר"},{id:2,name:"לא אושר"},{id:3,name:"ממתין לאישור"}],selectedStatus:null,selectedTeams:[],approveButtonDisabled:!0,approveButtonTitle:"יש לבחור לפחות קבוצה אחת",notAllConfirmations:!1}},mounted:function(){var n=this;i.get(function(e,t){n.user=t,p(n)})},computed:{filteredChampionships:function(){for(var e=[],t=0;t<this.championships.length;t++){var n=this.championships[t];if(this.competitionType)if(1==this.competitionType){if(!n.clubs)continue}else if(2==this.competitionType&&!n.league)continue;null!=this.region&&""!==this.region&&n.region.id!==this.region||(null!=this.sport&&""!==this.sport&&n.sport.id!==this.sport||e.push(n))}return e}},watch:{competitionType:function(){r(this)},championship:function(){r(this)},sport:function(){this.updateCaption(),r(this)},region:function(){var e=this;this.updateCaption(),o(e,function(){r(e)})},season:function(){var e=this;n(e,function(){o(e,function(){r(e)})})}},methods:{getTeamValue:function(e,t){return"number"==typeof e&&(e=this.teams[e]),this.$refs.teamsTable.getValue(e,this.columns[t])},updateCaption:function(){var e="קבוצות";if(null!=this.region&&this.regions)for(var t=0;t<this.regions.length;t++){var n=this.regions[t];if(n.id==this.region){e+=" - "+n.name;break}}if(null!=this.sport&&this.sports)for(t=0;t<this.sports.length;t++){var i=this.sports[t];if(i.id==this.sport){e+=" - "+i.name;break}}this.caption=e},handleSelectionChange:function(){this.selectedTeams.splice(0,this.selectedTeams.length),this.selectedStatus=null;for(var e=0;e<this.teams.length;e++){var t=this.teams[e];t.selected&&(0===this.selectedTeams.length?this.selectedStatus=t.teamStatus:this.selectedStatus!=t.teamStatus&&(this.selectedStatus=null),this.selectedTeams.push(t))}if(this.notAllConfirmations=!1,0===this.selectedTeams.length)this.approveButtonDisabled=!0,this.approveButtonTitle="יש לבחור לפחות קבוצה אחת";else{this.approveButtonDisabled=!1;var n=this,i=this.selectedTeams.filter(function(e){return"מאושר"==n.getTeamValue(e,20)&&"מאושר"==n.getTeamValue(e,21)&&"מאושר"==n.getTeamValue(e,22)});this.notAllConfirmations=i.length!==this.selectedTeams.length}},changeStatus:function(s){var o=this;Vue.http.post("/api/v2/admin/teams/status",{teams:o.selectedTeams.map(function(e){return null==e.team?{id:e.id}:{team:e.team}}),status:s}).then(function(e){for(var t=0;t<e.body.length;t++)for(var n=e.body[t],i=0;i<o.selectedTeams.length;i++){var a=o.selectedTeams[i];if(a.id===n.id){a.team=n.team;break}}o.selectedStatus=s,o.selectedTeams.forEach(function(e){e.teamStatus=s,2==e.teamStatus&&15==e.approved&&(e.green=!0)})},function(e){console.log(e)})}}})});