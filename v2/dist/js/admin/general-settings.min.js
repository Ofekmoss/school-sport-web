define(["templates/admin","dialog","generic/data-table","utils"],function(e,t,a,s){function n(t,a,e,n){void 0!==n&&null!=n||(n=new Function),t.updateStatus[a].loading=!0,Vue.http.post("/api/v2/cache",{key:a,value:e,global:1}).then(function(e){t.updateStatus[a].loading=!1,function(e,t){e.updateStatus[t].success=!0,window.setTimeout(function(){e.updateStatus[t].success=!1},5e3)}(t,a),n()},function(e){t.updateStatus[a].loading=!1,function(e,t){e.updateStatus[t].failed=!0,window.setTimeout(function(){e.updateStatus[t].failed=!1},5e3)}(t,a),n()})}function i(e){return""!==e&&null!=e}function o(e,n){return void 0!==n&&null!=n||(n=!1),e.map(function(e){var t=n?"01/01/2000":s.formatDate(s.parseDate(e.rangeStart,""),"dd/MM/yyyy"),a=s.formatDate(s.parseDate(e.rangeEnd,""),"dd/MM/yyyy");return[e.season,e.sport,e.category,t,a].join(",")}).join("|")}function r(e){var t=o(e.isfOverAgeItems.filter(function(e){return 0<e.season&&0<e.sport&&0<e.category&&function(e){var t=s.parseDate(e.rangeStart,""),a=s.parseDate(e.rangeEnd,"");return i(t)&&i(a)&&t<a}(e)}));t!=e.originalIsfOverageData&&n(e,"isf-overage",t,function(){e.originalIsfOverageData=t})}return Vue.extend({template:e["general-settings"],props:{type:{}},data:function(){return{tabName:"כללי",caption:"הגדרות כלליות",image:"img/settings.svg",updating:!1,types:[{value:0,caption:"כל הסוגים"},{value:1,caption:'פל"א'},{value:2,caption:"רישום"},{value:3,caption:"הורדות"}],filters:{seasons:[],season:-1},seasons:[],sports:[],categories:[],peleTeamRegistration:!1,schoolsSeasonAuthorization:"",isfOverAgeItems:[],isfOverAgeTimer:0,originalIsfOverageData:"",overAgeItems:[],overAgeTimer:0,originalOverageData:"",downloadsVisible:!1,downloadLinks:[],updateStatus:{"pele-team-registration":{loading:!1,success:!1,failed:!1,authorized:!1,authorizing:!1,password:""},"schools-season-authorization":{loading:!1,success:!1,failed:!1},"isf-overage":{loading:!1,success:!1,failed:!1,authorized:!1,authorizing:!1,password:""},overage:{loading:!1,success:!1,failed:!1,authorized:!1,authorizing:!1,password:""}}}},watch:{type:function(){this.updateCaption()},isfOverAgeItems:{deep:!0,handler:function(){var e=this;e.isfOverAgeItems.forEach(function(e){var t=s.parseDate(e.rangeStart,""),a=s.parseDate(e.rangeEnd,""),n="";null==t||null==a?n="פורמט תאריכים הוא dd/MM/yyyy":a<t&&(n="תאריך התחלה גדול מתאריך סיום"),e.error=n}),window.clearTimeout(e.isfOverAgeTimer),e.isfOverAgeTimer=window.setTimeout(function(){r(e)},5e3)}},overAgeItems:{deep:!0,handler:function(){var e=this;e.overAgeItems.forEach(function(e){var t="";null==s.parseDate(e.rangeEnd,"")&&(t="פורמט תאריכים הוא dd/MM/yyyy"),e.error=t}),window.clearTimeout(e.overAgeTimer),e.overAgeTimer=window.setTimeout(function(){!function(e){var t=o(e.overAgeItems.filter(function(e){return 0<e.season&&0<=e.sport&&0<e.category&&i(e.rangeEnd)}),!0);t!=e.originalOverageData&&n(e,"overage",t,function(){e.originalOverageData=t})}(e)},5e3)}}},mounted:function(){var n=this;void 0!==n.type&&null!=n.type||(n.type=0),s.readServerCache("pele-team-registration",!0,function(e,t){e||(n.peleTeamRegistration=s.isTrue(t)),s.readServerCache("schools-season-authorization",!0,function(e,t){e||(n.schoolsSeasonAuthorization=t,s.readServerCache("isf-overage",!0,function(e,a){e||s.readServerCache("overage",!0,function(e,t){e||function(n,s){void 0!==s&&null!=s||(s=new Function),n.seasons=[{id:-1,name:"עונה..."}],n.filters.seasons=[{id:-1,name:"כל העונות"}],n.sports=[{Id:-1,Name:"ענף ספורט..."}],n.categories=[{Category:-1,Name:"קטגוריית אליפות..."}],Vue.http.get("/api/v2/seasons",{}).then(function(e){for(var t=0;t<e.body.length;t++){var a=e.body[t];n.seasons.push(a),n.filters.seasons.push(a)}Vue.http.get("/api/v2/manage/sports",{}).then(function(e){for(var t=0;t<e.body.length;t++)n.sports.push(e.body[t]);Vue.http.get("/api/v2/manage/categories?championship=-1",{}).then(function(e){for(var t=0;t<e.body.length;t++)n.categories.push(e.body[t]);Vue.http.get("/api/v2/general-data",{}).then(function(e){var t=e.body.SportsmanLatestVersion;if(null!=t&&t.Link&&t.Version){var a="הורדת גרסה "+t.Version+" של תוכנת ספורטסמן";n.downloadLinks.push({url:t.Link,text:a})}s()})})})})}(n,function(){n.originalOverageData=t,n.originalIsfOverageData=a,function(e,t){e.isfOverAgeItems=s.parseIsfOverageItems(t)}(n,a),function(e,t){e.overAgeItems=s.parseIsfOverageItems(t)}(n,t),n.addIsfOverageItem(),n.addOverageItem()})})}))})})},methods:{isfOveragePasswordChange:function(){"ISF2021"===this.updateStatus["isf-overage"].password&&(this.updateStatus["isf-overage"].authorizing=!1,this.updateStatus["isf-overage"].authorized=!0)},overagePasswordChange:function(){"ISF2021"===this.updateStatus.overage.password&&(this.updateStatus.overage.authorizing=!1,this.updateStatus.overage.authorized=!0)},pelePasswordChange:function(){"pele2021"===this.updateStatus["pele-team-registration"].password.toLowerCase()&&(this.updateStatus["pele-team-registration"].authorizing=!1,this.updateStatus["pele-team-registration"].authorized=!0)},toggleDownloadsPanel:function(){this.downloadsVisible=!this.downloadsVisible},addIsfOverageItem:function(){this.isfOverAgeItems.push({season:-1,sport:-1,category:-1,rangeStart:"",rangeEnd:"",error:""})},addOverageItem:function(){this.overAgeItems.push({season:-1,sport:-1,category:-1,rangeStart:"",rangeEnd:"",error:""})},removeIsfOverageItem:function(e){0<=e&&e<this.isfOverAgeItems.length-1&&this.isfOverAgeItems.splice(e,1)},removeOverageItem:function(e){0<=e&&e<this.overAgeItems.length-1&&this.overAgeItems.splice(e,1)},updateCaption:function(){var e="הגדרות כלליות",t=this;if(null!=t.type&&0<t.type){var a=t.types.find(function(e){return e.value==t.type});null!=a&&(e+=" - "+a.caption)}t.caption=e},peleTeamRegistrationChanged:function(){n(this,"pele-team-registration",this.peleTeamRegistration)},schoolsSeasonAuthorizationChanged:function(){var e=this.schoolsSeasonAuthorization,t="";if(0<e.length){for(;0<=e.indexOf(", ");)e=e.replace(", ",",");t=e.split(",").map(function(e){return parseInt(e,10)}).filter(function(e){return!isNaN(e)&&0<e}).join(",")}n(this,"schools-season-authorization",t)},isItemVisible:function(e){return!(e.hasOwnProperty("season")&&0<this.filters.season)||e.season==this.filters.season}}})});