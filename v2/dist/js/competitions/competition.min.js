define(["templates/competitions","views","services/competitions","services/venues","dialog","utils"],function(e,t,p,s,f,d){var n={R:"position",S:"score",G:"games",P:"points",C:"pointsAgainst",T:"smallPoints",Y:"smallPointsAgainst",W:"wins",L:"losses",E:"technicalWins",F:"technicalLosses",D:"ties"};function i(e){var t=n[e];return t?function(e){return e[t]}:""}function v(e,t){if(e.length!==t.length)return!1;for(var n=0;n<e.length-1;n++)if(e[n]!==t[n])return!1;return!0}var a={"TEAM-ALREADY-IN-GROUP":"הקבוצה כבר קיימת בבית"};function c(e,t,n){f.open("general/message-box",{caption:e,message:t,alert:!0,confirmText:"כן",cancelText:"לא"},n)}function T(e,t,n){void 0!==n&&null!=n||(n=new Function);var i="";t.status&&200<t.status?t.body.code?(i=a[t.body.code])||(i=t.body.message):i=t.bodyText||t.body:"string"==typeof t&&(i=t),i||(i="הפעולה נכשלה"),f.open("general/message-box",{caption:e,message:i,alert:!0,confirmText:"אישור"},n)}var h={number:{caption:"#",size:4},opponentA:{caption:"קבוצה א",size:25},opponentB:{caption:"קבוצה ב",size:25},time:{caption:"תאריך",size:13},venue:{caption:"מתקן",size:13},score:{caption:"תוצאה",size:16}};return Vue.extend({template:e.competition,props:{id:{}},data:function(){return{tabName:"אליפויות",caption:"אליפות",alterViews:null,updating:!1,season:null,meeting:null,competition:null,building:!1,event:null,phase:null,group:null,groupsFull:!0,insertPanel:null,teamsPanelState:!1,draggedTeam:null,originalPositions:null,contentMode:"games",phaseTeams:null,teamForAssignment:null,teamAssignSelect:null,teamSearch:"",teamSortByPosition:"1"===localStorage["team-sort-by-position"],groupTeam:null,rankTeam:null,venues:{},rankingTables:[],selectedRankingTable:null,matchSelection:null,matchColumns:[{id:"number",caption:"#",size:4,show:!0},{id:"opponentA",caption:"קבוצה א",size:25,show:!0},{id:"opponentB",caption:"קבוצה ב",size:25,show:!0},{id:"time",caption:"תאריך",size:13,show:!0},{id:"venue",caption:"מתקן",size:13,show:!0},{id:"score",caption:"תוצאה",size:16,show:!0}],totalMatchColumnsSize:96,visibleMatchColumns:6,functionaries:{},dragging:null}},mounted:function(){var r=this;Vue.http.get("/api/v2/functionaries?full=1").then(function(e){for(var t=0;t<e.body.length;t++){var n=e.body[t];r.functionaries[n.id]=n}}),p.open(this.id,function(e,t){if(e)console.log(e);else{for(var n in p.season(t.season,function(e,t){if(!e){(r.season=t)&&0<t.meetings.length&&(r.meeting=t.meetings[0]);for(var n=[],i=0;i<t.competitions.length;i++){var s=t.competitions[i];n.push({caption:"אליפות - "+s.name+" ("+p.getCategoryName(s.category)+")",link:"competitions/competition?id="+encodeURIComponent(s.id)})}r.alterViews=n}}),r.competition=t,r.caption="אליפות - "+t.name+" ("+p.getCategoryName(t.category)+")",t.events){r.event=t.events[n],0<r.event.phases.length?(r.phase=r.event.phases[0],r.phase.groups&&0<r.phase.groups.length&&(r.group=r.phase.groups[0])):(r.building=!0,r.insertPhase());break}for(var i=(localStorage.getItem("matchColumns")||"number,opponentA,opponentB,time,venue,score").split(","),s={},a=0;a<i.length;a++){var o=i[a];"-"===o[0]?s[o.slice(1)]=-(a+1):s[o]=a+1}r.setMatchColumns(s),r.updateRankingTables()}})},methods:{updateView:function(e){var i=this;if(e.id&&this.season)for(var t=0;t<this.season.competitions.length;t++){var n=this.season.competitions[t];if(n.id==e.id)return this.id=n.id,this.competition=null,this.building=!1,this.event=null,this.phase=null,this.group=null,p.open(this.id,function(e,t){for(var n in i.competition=t,i.caption="אליפות - "+t.name+" ("+p.getCategoryName(t.category)+")",t.events){i.event=t.events[n],0<i.event.phases.length?(i.phase=i.event.phases[0],i.phase.groups&&0<i.phase.groups.length&&(i.group=i.phase.groups[0])):i.building=!0;break}i.updateRankingTables()}),!0}},updateRankingTables:function(){this.rankingTables.splice(0,this.rankingTables.length);var e=this.competition?this.competition.rules.RankingTables:null;if(e)for(var t=0;t<e.length;t++){var n=e[t];this.rankingTables.push({name:n.name,fields:n.fields.map(function(e){return{title:e.title,formatter:d.formatter(e.value,i)}})})}0<this.rankingTables.length?this.selectedRankingTable=this.rankingTables[0]:this.selectedRankingTable=null},setMatchColumns:function(e){this.matchColumns.splice(0,this.matchColumns.length);var t=0,n=0;for(var i in e){var s=e[i],a=!1;s<0?s=-s:a=!0;var o={id:i,caption:null,size:20,show:a},r=h[i];if(r&&(o.caption=r.caption,o.size=r.size),"func"===i.slice(0,4)&&(o.functionary=parseInt(i.slice(4)),this.competition.rules.Functionaries))for(var u=0;u<this.competition.rules.Functionaries.length;u++){var l=this.competition.rules.Functionaries[u];l.type===o.functionary&&(o.caption=l.description)}this.matchColumns.push(o),a&&(t+=o.size,n++)}this.totalMatchColumnsSize=t,this.visibleMatchColumns=n,this.matchColumns.sort(function(e,t){return e.order-t.order})},getTeamFieldValue:function(e,t){return t.formatter.evaluate(e)},newGameDisabledReason:function(){return null==this.group?"לא נבחר בית":!this.group.teams||this.group.teams.length<2?"פחות משתי קבוצות בבית":""},getMatchTeamName:function(e,t){for(var n=t.slice(1),i=0;i<e.matches.length;i++){var s=e.matches[i];if(s.id==n)return"W"===t[0]?"מנצחת משחק "+(s.number+1):"מפסידת משחק "+(s.number+1)}return""},getGroupTeamName:function(e,t){if(null!=t){if(e.teams.length<=t)return"קבוצה "+(t+1);e=e.teams[t]}var n=e.getTeam();return n?n.name:null},getOpponentName:function(e,t,n){return 1===n?t.matchReferenceA?this.getMatchTeamName(e,t.matchReferenceA):this.getGroupTeamName(e,t.opponentA):t.matchReferenceB?this.getMatchTeamName(e,t.matchReferenceB):this.getGroupTeamName(e,t.opponentB)},getEntrantNumber:function(e){var t=e.getParticipant();return t?t.number:"?"},getEntrantName:function(e){var t=e.getParticipant();return t?t.name:null},getEntrantTeamName:function(e){var t=e.getParticipant();if(t){var n=t.getTeam();if(n)return n.name}return null},getFunctionaryName:function(e){if(e){var t=this.functionaries[e];if(t)return t.name}return""},getVenueName:function(n){if(null==n)return"";var e=n.toString().indexOf("/");0<e&&(n=n.toString().slice(0,e));var t=this.venues[n];if(t)return t.name;var i=this;return s.getVenue(n,function(e,t){e||Vue.set(i.venues,n,t)}),"..."},toggleBuilding:function(){this.building=!this.building},toggleForAssignment:function(e){this.groupTeam=null,this.teamForAssignment=e===this.teamForAssignment?null:e,this.teamAssignSelect=null},teamAssignEnter:function(e,t){if(this.building&&!this.teamForAssignment){var n=e.currentTarget.parentElement,i=n.parentElement.parentElement.parentElement.getBoundingClientRect(),s=n.getBoundingClientRect();this.teamAssignSelect={team:t,top:s.top-i.top,right:i.right-s.left-6,group:null}}},teamAssignLeave:function(e,t){if(this.teamAssignSelect&&this.teamAssignSelect.team===t){var n=e.toElement||e.relatedTarget;if(null!=n)for(;n;){if(n.classList.contains("team-assign-popup"))return;n=n.parentElement}this.teamAssignSelect=null}},toggleGroupTeam:function(e){if(e.teamReference)for(var t=0;t<this.teamsList.length;t++){var n=this.teamsList[t];if(n.reference===e.teamReference)return void this.toggleForAssignment(n)}this.teamForAssignment=null,this.groupTeam=e===this.groupTeam?null:e},openRuleset:function(){t.openView("competitions/ruleset",{id:this.competition.ruleset})},assignTeam:function(n,e,t){var i,s=!1,a=null;if(this.teamForAssignment||this.teamAssignSelect||this.groupTeam){var o=this;i={placement:e,replace:t},this.teamForAssignment?(a=this.teamForAssignment,this.teamForAssignment.placement&&this.teamForAssignment.placement.group!==n&&(s=this.teamForAssignment.placement.group),i.reference=this.teamForAssignment.reference):this.teamAssignSelect?(a=this.teamAssignSelect.team,this.teamAssignSelect.team.placement&&this.teamAssignSelect.team.placement.group!==n&&(s=this.teamAssignSelect.team.placement.group),i.reference=this.teamAssignSelect.team.reference,this.teamAssignSelect=null):this.groupTeam.group===n?(a=this.groupTeam,i.reference=this.groupTeam.teamReference):(a=this.groupTeam,i.group=this.groupTeam.group.id,i.replace=this.groupTeam.group.teams.indexOf(this.groupTeam))}else i={};i&&(s?c("שיבוץ קבוצה לבית","האם להעביר קבוצה "+a.name+" מבית '"+s.name+"' לבית '"+n.formatName()+"'?",function(e,t){!0===t&&(i.move=!0,n.assignTeam(i,function(e,t){e?T("שיבוץ קבוצה לבית",e):(o.groupTeam=null,o.teamForAssignment=null)}))}):n.assignTeam(i,function(e,t){e?T("שיבוץ קבוצה לבית",e):(o.groupTeam=null,o.teamForAssignment=null)}))},listTeamsByPosition:function(e){if(e&&e.teams){var t=e.teams.slice();return t.sort(function(e,t){return e.position-t.position}),t}return[]},listEntrantsByPosition:function(e){var t=e.entrants.slice();return t.sort(function(e,t){return e.position-t.position}),t},selectContentMode:function(e){this.contentMode=e},selectPhase:function(e){this.phase!==e&&(this.teamForAssignment=null,this.phase=e,this.group=null)},selectGroup:function(e){this.group=e===this.group?null:e,this.group&&this.matchSelection&&this.group!=this.matchSelection.group&&(this.matchSelection=null)},selectEvent:function(e){this.event!==e&&(this.teamForAssignment=null,this.event=e,this.phase=0<e.phases.length?e.phases[0]:null,this.group=null)},newEvent:function(){},buildFromBoard:function(){var n=this;f.open("competitions/board-build",{participants:n.group.teams.map(function(e){return n.getGroupTeamName(e)}),boardId:n.group.gameBoard,disableClickOutside:!0},function(e,t){e?console.log(e):t&&(n.updating=!0,n.group.buildFromBoard(t,function(e){n.updating=!1,e&&T("בניית משחקים מלוח",e)}))})},editOrganizationLevels:function(n){var i=this;f.open("competitions/organization-levels",{phase:n},function(e,t){e?console.log(e):t&&(i.updating=!0,n.update({levels:t},function(e){i.updating=!1,e&&T("עדכון סידור משחקים",e)}))})},newGame:function(){var t=this;0<t.newGameDisabledReason().length||function(e,t,n,u){for(var l=[],i=0;i<t.teams.length;i++){var s=t.teams[i];l.push({placement:i,name:e.getGroupTeamName(s)})}var a=-1,o=-1;if(t.matches)for(var r=0;r<t.matches.length;r++){var c=t.matches[r];c!=n&&(l.push({reference:"W"+c.id,name:"מנצחת משחק "+(c.number+1)}),l.push({reference:"L"+c.id,name:"מפסידת משחק "+(c.number+1)}))}if(null!=n){if(null!=n.matchReferenceA){for(var h=t.teams.length;h<l.length;h++)if(l[h].reference===n.matchReferenceA){a=h;break}}else n.opponentA<t.teams.length&&(a=n.opponentA);if(null!=n.matchReferenceB){for(h=t.teams.length;h<l.length;h++)if(l[h].reference===n.matchReferenceB){o=h;break}}else n.opponentB<t.teams.length&&(o=n.opponentB)}var g=null!=n,m={teams:l,teamA:a,teamB:o,groupName:e.group.name,edit:g,setCount:0,functionaryData:[{type:1,caption:"אחראי/ת משחק",functionary:null},{type:2,caption:"שופט/ת",functionary:null}]};g&&(n.time&&(m.date=d.parseCompetitionTime(n.time)),n.venue&&(m.facility=n.venue),null!=n.functionaries&&n.functionaries.forEach(function(t){var e=m.functionaryData.find(function(e){return e.type==t.type});null!=e&&(e.functionary=t.functionary)}),d.assignNonEmptyValues(n,m,["scoreA|resultA","scoreB|resultB","technicalWinA","technicalWinB","setsA","setsB"])),f.open("competitions/match-details",m,function(e,t){if(e)T("נתוני משחק",e),u(null);else{if(null!=t){var n=null,i=null;if(t.result)if(t.result.technicalWinA)n=p.Outcome.TechnicalA;else if(t.result.technicalWinB)n=p.Outcome.TechnicalB;else if(i={scoreA:t.result.scoreA,scoreB:t.result.scoreB},t.result.setsA&&t.result.setsB){i.sets=[];for(var s=0;s<t.result.setsA.length;s++)i.sets.push({a:t.result.setsA[s],b:t.result.setsA[s]})}var a={time:t.time,venue:t.facility,outcome:n,result:i,functionaries:t.functionaries},o=l[t.teamA];null!=o.placement?(a.opponentA=o.placement,a.matchReferenceA=null):(a.opponentA=null,a.matchReferenceA=o.reference);var r=l[t.teamB];null!=r.placement?(a.opponentB=r.placement,a.matchReferenceB=null):(a.opponentB=null,a.matchReferenceB=r.reference)}u(a)}})}(t,t.group,null,function(e){null!=e&&t.group.insertMatch(e,function(e,t){e&&T("הוספת משחק חדש",e)})})},updatePosition:function(e,t){e.update({position:t},function(){})},insertGroup:function(){var n=this;this.phase.insertGroup("בית %%",null,function(e,t){e||(n.group=t)})},insertPhase:function(){var n=this,e="שלב "+(this.event.phases.length+1);this.event.insertPhase(e,null,function(e,t){e||(n.phase=t,n.group=null)})},changePosition:function(e,t){if(null!=e.position&&null!=e.group&&e.group.teams){var n=d.ensureRange(e.position+t,0,e.group.teams.length),i=e.group.teams.find(function(e){return e.position==n});null!=i&&(i.position=e.position),e.position=n,e.group.teams.sort(function(e,t){return e.position-t.position})}},nextPhase:function(){this.event&&this.event.nextPhase(function(e,t){})},previousPhase:function(){if(this.event){var n=this.event,e=n.phases[n.phase];if(e){for(var t=!1,i=0;!t&&i<e.groups.length;i++)for(var s=e.groups[i],a=0;!t&&s.matches&&a<s.matches.length;a++)t=null!=s.matches[a].outcome;t?c("חזרת שלב","חזרה לשלב קודם ימחק את כל תוצאות המשחקים, האם להמשיך?",function(e,t){t&&n.previousPhase(!0,function(e,t){})}):n.previousPhase(!1,function(e,t){})}}},dropTeam:function(e,t,n){var i,s=this;i=null==t?e.dataTransfer.getData("team"):t.id;var a;t=this.competition.teams[i];a=e?e.currentTarget.id.split("-")[1]:n;(n=this.phase?this.phase.groups[a]:null).teams&&n.teams.find(function(e){return(e.id||e.team)==t.id});if(e){""==e.target.id?e.target.parentElement.id:e.target.id}var o=n.phase.groups.find(function(e){return!!e.teams&&null!=e.teams.find(function(e){return e.team==t.id})});null!=o?o.id==n.id?null!=s.draggedTeam&&s.draggedTeam.group&&s.draggedTeam.group.id==n.id?s.draggedTeam=null:T("הוספת קבוצה לבית","קבוצה כבר קיימת בבית זה, לא ניתן להוסיף"):(T("הוספת קבוצה לבית","קבוצה זו כבר משוייכת לבית "+o.formatName()+", לא ניתן להוסיף"),s.group=o):n.insertTeam(t,function(e,t){e&&T("הוספת קבוצה לבית",e)})},setData:function(e,t){var n=this;e.dataTransfer.setData("team",t.id||t.team),e.dataTransfer.dropEffect="move",t.group&&t.group.teams&&(n.draggedTeam=t,n.originalPositions={},t.group.teams.forEach(function(e){n.originalPositions[e.team.toString()]=e.position}))},dragEnded:function(e,t){var n=this;null!=n.draggedTeam&&null!=n.originalPositions&&(n.draggedTeam.group.teams.forEach(function(e){e.position=n.originalPositions[e.team.toString()]}),n.draggedTeam.group.teams.sort(function(e,t){return e.position-t.position}),n.draggedTeam=null)},dragOver:function(e,t){var n=this;if(null!=t&&null!=n.draggedTeam&&n.draggedTeam.team&&n.draggedTeam.team!=t.team&&null!=n.draggedTeam.position){var i=t.position;t.position=n.draggedTeam.position,n.draggedTeam.position=i,t.group.teams.sort(function(e,t){return e.position-t.position})}},deleteTeam:function(e){c("מחיקת קבוצה","האם למחוק את הקבוצה?",function(e,t){})},removeTeamFromGroup:function(n){var i=this;c("הסרת קבוצה מבית","האם להסיר את הקבוצה <strong>"+i.getGroupTeamName(n)+"</strong> מ<strong>"+n.group.formatName()+"</strong>?",function(e,t){t&&n.remove(function(e,t){e?T("הסרת קבוצה מבית",e):(i.groupTeam=null,i.teamForAssignment=null)})})},isMatchSelected:function(e){return null!=this.matchSelection&&(this.matchSelection.group===e.group&&0<=this.matchSelection.matches.indexOf(e))},areAllGroupMatchesSelected:function(e){if(null==this.matchSelection||this.matchSelection.group!==e||0===e.matches.length)return!1;for(var t=0;t<e.matches.length;t++)if(this.matchSelection.matches.indexOf(e.matches[t])<0)return!1;return!0},areAllRoundMatchesSelected:function(e){if(0===e.matches.length)return!1;if(null==this.matchSelection||this.matchSelection.group!==e.matches[0].group)return!1;for(var t=0;t<e.matches.length;t++)if(this.matchSelection.matches.indexOf(e.matches[t])<0)return!1;return!0},toggleMatchSelected:function(e){null!=this.matchSelection&&this.matchSelection.group===e.group||(this.matchSelection={group:e.group,matches:[]});var t=this.matchSelection.matches.indexOf(e);0<=t?this.matchSelection.matches.splice(t,1):this.matchSelection.matches.push(e)},toggleAllGroupMatchesSelected:function(e){if(this.areAllGroupMatchesSelected(e))this.matchSelection=null;else{this.matchSelection={group:e,matches:[]};for(var t=0;t<e.matches.length;t++)this.matchSelection.matches.push(e.matches[t])}},toggleAllRoundMatchesSelected:function(e){if(0<e.matches.length)if(this.matchSelection&&this.areAllRoundMatchesSelected(e))for(var t=0;t<e.matches.length;t++){var n=e.matches[t],i=this.matchSelection.matches.indexOf(n);0<=i&&this.matchSelection.matches.splice(i,1)}else if(this.matchSelection&&this.matchSelection.group===e.matches[0].group)for(t=0;t<e.matches.length;t++){n=e.matches[t];this.matchSelection.matches.indexOf(n)<0&&this.matchSelection.matches.push(n)}else this.matchSelection={group:e.matches[0].group,matches:e.matches.slice()}},selectColumns:function(){for(var n=this,e={},t=0;t<this.matchColumns.length;t++){var i=this.matchColumns[t];i.show?e[i.id]=t+1:e[i.id]=-(t+1)}f.open("competitions/select-columns",{setColumns:e,functionaries:this.competition.rules.Functionaries},function(e,t){t&&(n.setMatchColumns(t),localStorage.setItem("matchColumns",n.matchColumns.map(function(e){return e.show?e.id:"-"+e.id}).join(",")))})},editSelectedMatches:function(){if(null!=this.matchSelection){null==this.group&&(this.group=this.matchSelection.group),this.openMatchesEdit(this.season&&this.season.program?this.season.program.region:0,this.matchSelection.group,this.matchSelection.matches)}},deleteSelectedMatches:function(){if(!(null==this.matchSelection&&0<this.matchSelection.matches.length)){c("מחיקת משחקים",1===this.matchSelection.matches.length?"האם למחוק את המשחק שנבחר?":"האם למחוק את "+this.matchSelection.matches.length+" המשחקים שנבחרו?",function(e,t){})}},onEditMatch:function(e,t){null==this.group&&(this.group=this.phase.groups.find(function(e){return t.group.id==e.id})),this.openMatchesEdit(this.season&&this.season.program?this.season.program.region:0,e,[t])},openMatchesEdit:function(e,n,t){t.sort(function(e,t){for(var n=0,i=0;!n&&i<e.sequence.length&&i<t.sequence.length;)n=e.sequence[i]-t.sequence[i],i++;return n||(n=e.sequence.length-t.sequence.length),n}),f.open("competitions/edit-match",{region:e,group:n,matches:t,disableClickOutside:!0},function(e,t){t&&n.phase.event.competition.updateMatches(t,function(e){})})},onDeleteMatch:function(e,n){var i=this;c("מחיקת משחק","האם למחוק את משחק מספר "+(n.number+1)+" בין "+i.getOpponentName(e,n,1)+" לבין "+i.getOpponentName(e,n,2)+"?",function(e,t){t&&n.delete(function(e,t){e&&(T("מחיקת משחק","שגיאה בעת מחיקת משחק, נא לנסות שוב מאוחר יותר"),console.log(e)),i.matchSelection=null})})},setMatchResult:function(n){var e=n.group.phase;e&&e.event.currentPhase()===e&&f.open("competitions/match-result",{gameStructure:this.competition.rules.GameStructure,teamA:this.getGroupTeamName(n.group.teams[n.opponentA]),teamB:this.getGroupTeamName(n.group.teams[n.opponentB]),scoreA:n.scoreA,scoreB:n.scoreB,sets:n.result?n.result.sets:null,outcome:n.outcome,disableClickOutside:!0},function(e,t){t&&n.update(t,function(e,t){e&&T("עדכון תוצאה",e)})})},onEditPhase:function(e,t){var s=this;t.stopPropagation();var a=s.event.phases[e],o=a.name;f.open("competitions/edit-item",{name:o,title:"עריכת שלב",caption:"שם השלב",deleteCaption:"מחיקת שלב",disableClickOutside:!0},function(e,t){if(t&&t.action&&"delete"===t.action)s.deletePhase(a);else{var n=t?t.trim():"";if(0===n.length||n==o)return;var i=function(e,t){return e.event&&e.event.phases?e.event.phases.find(function(e){return e.name.trim()===t}):null}(s,n);null!=i?(T("עריכת שלב","שלב בעל שם זהה כבר קיים, לא ניתן לשנות שם"),s.phase=i):a.update({name:n},function(e,t){e?(console.log("error updating phase"),console.log(e)):a.name=n})}})},editRound:function(i,s){f.open("competitions/edit-item",{name:i.name||"",defaultName:this.formatRoundName(s,i.sequence),title:"עריכת חלק",caption:"שם החלק",showDelete:!1,disableClickOutside:!0},function(e,t){if(t)if("string"==typeof t)(n={})[i.sequence.join(":")]=t,s.updateRounds(n);else if("default"===t.action){var n;(n={})[i.sequence.join(":")]=null,s.updateRounds(n)}})},moveGroup:function(e,t,n){n.stopPropagation(),e.update({number:t},function(e){e&&T("הזזת בית",e)})},deleteGroup:function(i,e){var n=this;function s(e){i.delete(e,function(e,t){e?(console.log("error deleting group"),console.log(e),T("מחיקת בית",e)):0<n.phase.groups.length?n.selectGroup(n.phase.groups[0]):n.group=null})}c("מחיקת בית","האם למחוק את הבית?",function(e,t){if(t){var n=null;i.teams&&0<i.teams.length&&(n="הקבוצות"),i.matches&&0<i.matches.length&&(n=null!=i.matches.find(function(e){return null!=e.outcome})?(null==n?"":n+", ")+"המשחקים והתוצאות":null==n?"המשחקים":n+" והמשחקים"),null!=n?c("מחיקת בית",n+" ימחקו. האם להמשיך?",function(e,t){t&&s(!0)}):s()}})},deletePhase:function(u){var n=this;function l(e){u.delete(e,function(e,t){e?(console.log("error deleting phase"),console.log(e)):n.selectPhase(n.event.phases[0])})}c("מחיקת שלב","האם למחוק את השלב?",function(e,t){if(t){var n=!1,i=!1,s=!1,a=[];if(0<u.groups.length){a.push("הבתים");for(var o=0;o<u.groups.length;o++){var r=u.groups[o];if(n||(n=r.teams&&0<r.teams.length,a.push("הקבוצות")),!s&&r.matches&&0<r.matches.length&&(i||(i=!0,a.push("המשחקים")),null!=r.matches.find(function(e){return null!=e.outcome}))){s=!0,a.push("התוצאות");break}}}if(0<a.length)c("מחיקת שלב",(1===a.length?a[0]:a.slice(0,a.length-1).join(", ")+" ו"+a[a.length-1])+" ימחקו. האם להמשיך?",function(e,t){t&&l(!0)});else l()}})},onEditGroup:function(s,e){var a=this;e.stopPropagation();var o=this.phase?this.phase.groups[s].name:"",r=a.phase&&a.phase.groups?a.phase.groups[s]:null;null!=r&&f.open("competitions/edit-item",{name:o,title:"עריכת בית",caption:"שם הבית",deleteCaption:"מחיקת בית",defaultName:"בית "+p.hebNumber(s+1),disableClickOutside:!0},function(e,t){if(t&&t.action&&"delete"===t.action)a.deleteGroup(r,s);else if(t&&"default"===t.action)r.update({name:"בית %%"},function(e,t){e?(console.log("error updating group"),console.log(e)):r.name="בית %%"});else{var n=t?t.trim():"";if(0===n.length||n==o)return;var i=function(e,t){return e.phase&&e.phase.groups?e.phase.groups.find(function(e){return e.formatName().trim()===t}):null}(a,n);null!=i?(T("עריכת בית","בית בעל שם זהה כבר קיים, לא ניתן לשנות לשם זה"),a.group=i):r.update({name:n},function(e,t){e?(console.log("error updating group"),console.log(e)):r.name=n})}})},toggleTeams:function(){this.teamsPanelState=!this.teamsPanelState},startDragMatch:function(e,t,n){e.preventDefault();var i=this;i.dragging={group:t,match:n,round:1<n.sequence.length?n.sequence.slice(0,n.sequence.length-1).join(":"):"",groupContent:this.$el.querySelector("#group-content")},document.onmouseup=function(){i.completeDrag()},document.onblur=function(){i.completeDrag()}},completeDrag:function(){this.dragging&&(this.dragging=null,document.onmouseup=null,document.onmousemove=null)},scrollGroupContent:function(){if(this.dragging&&this.dragging.groupContent){var e=this.dragging.groupContent.getBoundingClientRect(),t=!1;this.dragging.pos-e.top<20?(t=!0,this.dragging.groupContent.scrollTop=Math.max(0,this.dragging.groupContent.scrollTop+Math.min(-16,(this.dragging.pos-e.top)/2))):-20<this.dragging.pos-e.bottom&&(t=!0,this.dragging.groupContent.scrollTop=Math.min(this.dragging.groupContent.scrollHeight,this.dragging.groupContent.scrollTop+Math.max(16,(this.dragging.pos-e.bottom)/2))),t&&setTimeout((n=this,function(){n.scrollGroupContent()}),100)}var n},mouseMove:function(e){if(this.dragging&&!this.dragging.updating){for(var t=e.srcElement,n=null,i=null;null==n&&t;)t.id&&(t.id.startsWith("match")?(n=t.id.slice(5),i="match"):t.id.startsWith("round")&&(n=t.id.slice(5),i="round")),t=t.parentElement;if(this.dragging.pos=e.pageY,this.scrollGroupContent(),n)if("match"===i){if((c=n.split("."))[0]===this.dragging.group.id&&c[1]!==this.dragging.match.id){for(var s=null,a=0,o=0;o<this.dragging.group.matches.length;o++){if((f=this.dragging.group.matches[o]).id===c[1]){s=f,a=o;break}}var r=s.sequence.join(":");if(this.dragging.sequence!==r){var u=this;this.dragging.sequence=r,this.dragging.updating=!0;var l=[{match:this.dragging.match.id,sequence:s.sequence}];if(v(s.sequence,this.dragging.match.sequence))l.push({match:s.id,sequence:this.dragging.match.sequence});else{if(0<=(g=this.dragging.group.matches.indexOf(this.dragging.match)))for(g++;g<this.dragging.group.matches.length;){if(!v((f=this.dragging.group.matches[g]).sequence,this.dragging.match.sequence))break;(r=f.sequence.slice())[r.length-1]=r[r.length-1]-1,l.push({match:f.id,sequence:r}),g++}for(g=a;g<this.dragging.group.matches.length;){if((f=this.dragging.group.matches[g])!==s&&!v(f.sequence,s.sequence))break;(r=f.sequence.slice())[r.length-1]=r[r.length-1]+1,l.push({match:f.id,sequence:r}),g++}}this.competition.updateMatches(l,function(e){u.dragging.updating=!1})}}}else if("round"===i){var c;if((c=n.split("."))[0]===this.dragging.group.id&&this.dragging.round!==c[1]){var h=c[1].localeCompare(this.dragging.round);if(0!==h){l=[];var g=this.dragging.group.matches.indexOf(this.dragging.match),m=c[1].split(":").map(function(e){return parseInt(e)});if(m.push(0),h<0){var p=!1;for(o=0;g<this.dragging.group.matches.length;){var f=this.dragging.group.matches[g];if(p){if(v(f.sequence,m))(m=f.sequence.slice())[m.length-1]=m[m.length-1]+1;else if(v(f.sequence,this.dragging.match.sequence)){(r=f.sequence.slice())[r.length-1]=r[r.length-1]-1,l.push({match:f.id,sequence:r})}}else v(f.sequence,m)&&(p=!0,(m=f.sequence.slice())[m.length-1]=m[m.length-1]+1);g++}l.push({match:this.dragging.match.id,sequence:m})}else if(0<h){p=!1;for(g++;g<this.dragging.group.matches.length;){if(!v((f=this.dragging.group.matches[g]).sequence,this.dragging.match.sequence))break;(r=f.sequence.slice())[r.length-1]=r[r.length-1]-1,l.push({match:f.id,sequence:r}),g++}for(l.splice(0,0,{match:this.dragging.match.id,sequence:m});g<this.dragging.group.matches.length;){if(v((f=this.dragging.group.matches[g]).sequence,m))p=!0,(r=f.sequence.slice())[r.length-1]=r[r.length-1]+1,l.splice(0,0,{match:f.id,sequence:r});else if(p)break;g++}}r=m.join(":");if(this.dragging.sequence!==r){u=this;this.dragging.sequence=r,this.dragging.updating=!0,this.competition.updateMatches(l,function(e){u.dragging.updating=!1})}}}}}},getGroupRounds:function(e){var t={},n=[];if(e.rounds)for(var i in e.rounds){var s={sequence:o=i.split(":").map(function(e){return parseInt(e)}),name:e.rounds[i],matches:[]};t[i]=s,n.push(s)}for(var a=0;a<e.matches.length;a++){var o,r=e.matches[a];(s=t[i=(o=1<r.sequence.length?r.sequence.slice(0,r.sequence.length-1):[]).join(":")])||(t[i]=s={sequence:o,name:null,matches:[]},n.push(s)),s.matches.push(r)}return n.sort(function(e,t){for(var n=0,i=0;i<e.sequence.length&&i<t.sequence.length;i++)if(n=e.sequence[i]-t.sequence[i])return n;return t.sequence.length-e.sequence.length}),n},checkLevelChange:function(e,t){if(!e.phase.levels)return!1;if(0===t)return 0<e.phase.levels.length;for(var n=e.matches[t],i=e.matches[t-1],s=0;s<e.phase.levels.length;s++)if(n.sequence[s]!==i.sequence[s])return!0;return!1},toggleTeamSortByPosition:function(){this.teamSortByPosition=!this.teamSortByPosition,localStorage["team-sort-by-position"]=this.teamSortByPosition?"1":"0"},formatRoundName:function(e,t){for(var n="",i=0;i<t.length;i++){var s=(t[i]||0)+1;0<n.length&&(n+=" - "),i<e.phase.levels.length?n+=e.phase.levels[i].name+" "+s:n+=s}return n},test:function(e){console.log(e)}},watch:{phase:function(){this.phaseTeams&&(!this.phase||this.phase.number<=this.phaseTeams.number)&&(this.phaseTeams=null)}},computed:{teamsList:function(){var e=this.teamSearch.trim(),t=[],n={};if(this.phase){for(var i=0;i<this.phase.groups.length;i++){if((a=this.phase.groups[i]).teams)for(var s=0;s<a.teams.length;s++){n[a.teams[s].teamReference]={group:a,groupNumber:i,placement:s,name:a.formatName()+" - "+(s+1)}}}if(this.phaseTeams){for(i=0;i<this.phaseTeams.groups.length;i++){var a;if((a=this.phaseTeams.groups[i]).teams)for(s=0;s<a.teams.length;s++){var o="G"+a.id+"R"+s,r=a.formatName()+" - מיקום "+(s+1);0<e.length&&r.indexOf(e)<0||t.push({reference:o,name:r,placement:n[o]})}}return t}}for(var u in this.competition.teams){var l=this.competition.teams[u];if(!(0<e.length&&l.name.indexOf(e)<0)){o="C"+l.id;t.push({reference:o,name:l.name,placement:n[o]})}}return this.teamSortByPosition?t.sort(function(e,t){if(null==e.placement)return null!=t.placement?-1:e.name.localeCompare(t.name);if(null==t.placement)return 1;var n=e.placement.groupNumber-t.placement.groupNumber;return 0===n&&(n=e.placement.placement-t.placement.placement),0===n&&(n=e.name.localeCompare(t.name)),n}):t.sort(function(e,t){return e.name.localeCompare(t.name)}),t},meetingEvents:function(){var e=[],t=this.meeting?this.meeting.id:null;if(this.competition&&this.season)for(var n in this.competition.events)for(var i=this.competition.events[n],s=0;s<i.phases.length;s++){if(i.phases[s].meeting==t){e.push(i);break}}return e}}})});