define(["templates/competitions","services/competitions","utils"],function(n,u,s){function r(n){var t="";if(-1===n.teamA||-1===n.teamB?t="יש לבחור קבוצות":n.teamA==n.teamB&&(t="לא ניתן לבחור אותה קבוצה"),0===t.length&&n.date&&(null!=n.matchTime.hour||null!=n.matchTime.minute)){var e=parseInt(n.matchTime.hour,10),i=parseInt(n.matchTime.minute,10);(isNaN(e)||isNaN(i)||e<0||i<0||23<e||59<i)&&(t="זמן שגוי. ניתן גם להשאיר ריק")}return t}function l(e,i){void 0!==i&&null!=i||(i=new Function);var n=e.facilityRegion;if(e.facilities=[],e.facility=-1,0<=n){var t="/api/v2/facilities?region="+n;Vue.http.get(t).then(function(n){e.facilities=[],e.facilities.push({id:-1,name:"מתקן..."});for(var t=0;t<n.body.length;t++)e.facilities.push(n.body[t]);i()})}else i()}function i(n){if(null!=n.matchTime.minute){var t=parseInt(n.matchTime.minute,10);!isNaN(t)&&0<=t&&t<10&&(n.matchTime.minute="0"+t)}}function c(n){var i=null,a=0;return null!=n&&(i=[],n.forEach(function(n){var t=n.score;if(null!=t){var e=parseInt(t,10);!isNaN(e)&&0<=e&&e<100?(t=e,a++):t=null}i.push(t)})),0===a&&(i=null),i}function t(n,t,e){var i=n[t];n[t]=n[e],n[e]=i}function a(n,t){if(void 0===t&&(t=!1),0<n.setCount)if(t&&null!=n.setsA&&null!=n.setsB&&n.setsA.length===n.setsB.length){for(var e=0;e<n.setsA.length;e++)n.setsA[e]={score:n.setsA[e]},n.setsB[e]={score:n.setsB[e]};n.expandableObjects.sets=!0}else{n.setsA=[],n.setsB=[];for(e=1;e<=n.setCount;e++)n.setsA.push({score:null}),n.setsB.push({score:null});n.expandableObjects.sets=!1}}function o(n){n.error=r(n)}return Vue.extend({template:n["match-details"],data:function(){return{teams:[],teamA:null,teamB:null,groupName:"",error:"",date:null,matchTime:{hour:null,minute:null},edit:null,expandableObjects:{facility:!1,result:!1,sets:!1,functionaries:!1},regions:[],facilityRegions:[],facilityRegion:-1,facilities:[],facility:-1,resultA:null,resultB:null,technicalWinA:!1,technicalWinB:!1,originalResultA:null,originalResultB:null,originalExpandSets:!1,setCount:0,setsA:null,setsB:null,functionaryData:null,functionaryTypes:[]}},watch:{},methods:{getTeamName:function(n){return"??"},teamChanged:function(){o(this)},resultChanged:function(){var n=this;""===n.resultA&&(n.resultA=null),""===n.resultB&&(n.resultB=null),null==n.resultA&&null==n.resultB&&(n.expandableObjects.sets=!1),o(n)},dateChanged:function(n){this.date=n},timeChanged:function(){var n=this;null==n.matchTime.hour||null!=n.matchTime.minute&&""!=n.matchTime.minute||(n.matchTime.minute="0"),i(n),o(n)},facilityRegionChanged:function(){l(this,null)},technicalWinChanged:function(n){var t=this,e="technicalWin"+n,i="technicalWin"+("A"===n?"B":"A");t[e]&&(t[i]&&(t[i]=!1),null==t.originalResultA&&null==t.originalResultB&&(t.originalResultA=t.resultA,t.originalResultB=t.resultB,t.originalExpandSets=t.expandableObjects.sets,t.resultA=null,t.resultB=null,t.expandableObjects.sets=!1)),t[e]||t[i]||(t.resultA=t.originalResultA,t.resultB=t.originalResultB,t.expandableObjects.sets=t.originalExpandSets,t.originalResultA=null,t.originalResultB=null,t.originalExpandSets=!1)},setScoreChanged:function(n,t){var e=this,i="sets"+t,a="sets"+("A"===t?"B":"A"),l=e[i][n].score,u=parseInt(l,10);isNaN(u)||u<0||99<u?e[i][n].score=null:(e[i][n].score=u.toString(),null==e[a][n].score&&(e[a][n].score=0))},clearDate:function(){$(".vdp-datepicker").find('input[type="text"]').val(""),this.date=null},clearTime:function(){this.matchTime.hour=null,this.matchTime.minute=null},switchTeams:function(){var n=this;t(n,"teamA","teamB"),t(n,"resultA","resultB"),(n.technicalWinA||n.technicalWinB)&&(t(n,"technicalWinA","technicalWinB"),n.technicalWinChanged("A"),n.technicalWinChanged("B")),t(n,"originalResultA","originalResultB"),t(n,"setsA","setsB")},resetScore:function(){var n=this;n.resultA=null,n.resultB=null,n.technicalWinA=!1,n.technicalWinB=!1,n.originalResultA=null,n.originalResultB=null,n.originalExpandSets=!1,a(n)},resetFacility:function(){this.facility=-1,this.facilityRegion=-1},resetFunctionaries:function(){this.functionaryTypes.forEach(function(n){n.functionary=-1,n.region=-1}),this.$forceUpdate()},toggleExpanded:function(n){if("string"==typeof n){var t=n;this.expandableObjects[t]=!this.expandableObjects[t]}else null!=n&&(n.expanded=!n.expanded)},isExpanded:function(n){return!0===this.expandableObjects[n]},addSet:function(){this.setsA.push({score:null}),this.setsB.push({score:null})},removeSet:function(n){n>=this.setCount&&(this.setsA.splice(n,1),this.setsB.splice(n,1))},isOverTime:function(n){return n>=this.setCount},confirm:function(){var n=this,t=r(n);if(0<t.length)n.error=t;else{var e=function(n){if(n.date){if(null==n.matchTime.hour||null==n.matchTime.minute)return u.time(n.date.getFullYear(),n.date.getMonth()+1,n.date.getDate());var t=parseInt(n.matchTime.hour,10),e=parseInt(n.matchTime.minute,10);if(!isNaN(t)&&!isNaN(e)&&0<=t&&0<=e&&t<24&&e<60)return n.date.setHours(t),n.date.setMinutes(e),u.time(n.date)}return null}(n),i=function(n){var t=n.technicalWinA||n.technicalWinB;if(t||null!=n.resultA&&null!=n.resultB){var e=null,i=null;return t||(e=parseInt(n.resultA,10),i=parseInt(n.resultB,10)),{scoreA:e,scoreB:i,technicalWinA:n.technicalWinA,technicalWinB:n.technicalWinB,setsA:c(n.setsA),setsB:c(n.setsB)}}return null}(n);if(null==i||s.verifyIntRange(i.scoreA,0,1e3)&&s.verifyIntRange(i.scoreB,0,1e3)){var a=function(n){var t=n.functionaryTypes.map(function(n){var t=0<n.functionary?n.functionary:null;return{type:n.type,functionary:t}}).filter(function(n){return null!=n.functionary});return 0<t.length?t:null}(n),l={teamA:n.teamA,teamB:n.teamB,time:e,facility:0<n.facility?n.facility:null,result:i,functionaries:a};this.$emit("close",l)}else n.error="תוצאה שגויה"}},cancel:function(){this.$emit("close")}},mounted:function(){var e=this;if(null==e.teamA&&(e.teamA=-1),null==e.teamB&&(e.teamB=-1),null==e.date)window.setTimeout(function(){$(".vdp-datepicker input[type='text']").val("")},200);else{var n=e.date.getHours(),t=e.date.getMinutes();(0<n||0<t)&&(e.matchTime.hour=n,e.matchTime.minute=t,i(e))}null==e.technicalWinA&&(e.technicalWinA=!1),null==e.technicalWinB&&(e.technicalWinB=!1),!0===e.technicalWinA&&!0===e.technicalWinB&&(e.technicalWinA=!1,e.technicalWinB=!1),!0===e.technicalWinA?e.technicalWinChanged("A"):!0===e.technicalWinB&&e.technicalWinChanged("B"),null==e.resultA&&null==e.resultB||(e.expandableObjects.result=!0),function(e,i){void 0===i&&(i=new Function),Vue.http.get("/api/v2/regions").then(function(n){e.regions=[];for(var t=0;t<n.body.length;t++)e.regions.push(n.body[t]);i()})}(e,function(){e.facilityRegions=[{id:-1,name:"מחוז..."}];for(var n=0;n<e.regions.length;n++)e.facilityRegions.push({id:e.regions[n].id,name:e.regions[n].name});0<e.facility&&function(i,a){if(0<i.facility){var n="/api/v2/facilities?id="+i.facility;Vue.http.get(n).then(function(n){var t=n.body.region,e=n.body.id;null!=t&&null!=e&&(i.facilityRegion=t,l(i,function(){i.facility=e,i.expandableObjects.facility=!0})),a&&a()})}else a&&a()}(e,function(){}),function(s,l){if(void 0===l&&(l=new Function),null!=s.functionaryData&&0<s.functionaryData.length){var n="/api/v2/functionaries?types="+s.functionaryData.map(function(n){return n.type}).join(",");Vue.http.get(n).then(function(n){for(var e={},t=0;t<n.body.length;t++){var i=n.body[t],a=i.type.toString();e[a]||(e[a]=[]),e[a].push(i)}var u={};s.regions.forEach(function(n){u[n.id.toString()]=n.name}),s.functionaryTypes=[],s.functionaryData.forEach(function(i){var n=e[i.type.toString()]||[],a=[],l=-1;n.sort(function(n,t){return n.name.localeCompare(t.name)}),n.forEach(function(t){var n=null!=t.region?u[t.region.toString()]:null;if(null!=n){var e=a.find(function(n){return n.id==t.region});null==e&&(e={id:t.region,name:n,functionaries:[{id:-1,name:i.caption+"..."}]},a.push(e)),e.functionaries.push(t),null!=i.functionary&&i.functionary==t.id&&(l=t.region)}}),n.splice(0,0,{id:-1,name:i.caption+"..."}),a.sort(function(n,t){return n.name.localeCompare(t.name)}),a.splice(0,0,{id:-1,name:"כל המחוזות",functionaries:[]});var t={type:i.type,caption:i.caption,functionaries:n,regions:a,region:l,functionary:i.functionary||-1};s.functionaryTypes.push(t)}),l()})}else l()}(e,function(){e.functionaryTypes.forEach(function(t){t.region<0&&0<t.functionary&&(t.functionary=-1),t.getFunctionaries=function(){if(t.region<0)return t.functionaries;var n=t.regions.find(function(n){return n.id==t.region});return null!=n?n.functionaries:[]},window.setInterval(function(){0<t.region&&(null==t.getFunctionaries().find(function(n){return n.id==t.functionary})&&(t.functionary=-1,e.$forceUpdate()))},1e3)})})}),a(e,!0),o(e)}})});