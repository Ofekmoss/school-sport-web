define(["templates/competitions","services/competitions","utils","components/edit-select"],function(e,t,B){var F=null;function f(e){if(e.date)if(null==e.hours)e.time=1e4*e.date.getFullYear()+100*(e.date.getMonth()+1)+e.date.getDate();else{var t=new Date(e.date);t.setHours(e.hours,e.minutes,0,0),e.time=Math.floor(t.getTime()/1e3)}else e.time=null}function M(e,t){if(null!=t){var i=B.parseCompetitionTime(t);i&&(e.date=new Date(i),e.date.setHours(0,0,0,0),1e8<t?(e.hours=i.getHours(),e.minutes=i.getMinutes(),e.timeText=e.hours+":"+("0"+e.minutes).slice(-2)):(e.hours=null,e.minutes=null,e.timeText=""))}else e.time=null,e.date=null,e.hours=null,e.minutes=null,e.timeText=""}function i(e){var t=[];if(!(e&&0<e.length))return{hours:null,minutes:null};if(2===(t=e.split(":")).length&&0<t[0].length&&t[0].length<3&&2===t[1].length){var i=parseInt(t[0]),n=parseInt(t[1]);if(null!=i&&0<=i&&i<24&&null!=n&&0<=n&&n<60)return{hours:i,minutes:n}}return null}return Vue.extend({template:e["edit-match"],data:function(){return{group:null,region:null,sweeping:!1,selectedMatch:null,matches:[],teams:[],winners:[],losers:[],matchesEdit:[],venueRegion:null,functionarySearch:null,generalVenue:null,generalTime:{date:null,timeText:null,timeInvalid:!1,hours:null,minutes:null,diffText:null,diffInvalid:null},regions:[],regionFacilities:{},teamFacilities:{},facilities:[]}},mounted:function(){for(var o=this,e=[],t=0;t<this.group.teams.length;t++){var i=this.group.teams[t].getTeam();i.id&&e.push(i.id),this.updateTeamFacilities(i.id),this.teams.push({placement:t,id:i.id,name:i?i.name:"?",school:null,region:null,city:null})}for(var h={},n=0;n<this.group.matches.length;n++){var a=null,s=null;1===(d=this.group.matches[n]).outcome||3===d.outcome?(null!=d.opponentA&&(a=this.group.teams[d.opponentA]),null!=d.opponentB&&(s=this.group.teams[d.opponentB])):2!==d.outcome&&4!==d.outcome||(null!=d.opponentB&&(a=this.group.teams[d.opponentB]),null!=d.opponentA&&(s=this.group.teams[d.opponentA]));var r=a?a.getTeam():null,l={reference:"W"+d.id,id:r?r.id:null,name:"משחק "+(d.number+1)+(r?" - "+r.name:"")};h[l.reference]=l,this.winners.push(l);var u=s?s.getTeam():null;l={reference:"L"+d.id,id:u?u.id:null,name:"משחק "+(d.number+1)+(u?" - "+u.name:"")};h[l.reference]=l,this.losers.push(l)}this.teams.push({placement:-1,name:"מנצחת משחק"}),this.teams.push({placement:-2,name:"מפסידת משחק"});for(var c={},m=null,f=null,p=null,g=0;g<this.matches.length;g++){var d;null!=(d=this.matches[g]).venue&&(c[d.venue]=!0),!1!==m&&(null==d.time?m=!1:null==m?m=d.time:d.time<1e8||f<1e8?m!==d.time&&(m=!1):d.time>=f?null==p?p=d.time-f:p!==d.time-f&&(m=!1):m=!1,f=d.time)}m&&(this.generalTime.date=B.parseCompetitionTime(m),1e8<m&&(this.generalTime.hours=this.generalTime.date.getHours(),this.generalTime.minutes=this.generalTime.date.getMinutes(),this.generalTime.timeText=("0"+this.generalTime.hours).slice(-2)+":"+("0"+this.generalTime.minutes).slice(-2),p&&(86400<p&&(p=Math.floor(p/1e3)),this.generalTime.diffText=Math.floor(p/60))));var v=this.group.phase.event.competition.rules.Functionaries,T=0;function y(){if(0<T)T--;else{for(var e=0;e<o.matches.length;e++){var t=o.matches[e],i={match:t,venue:null!=t.venue&&c[t.venue]||null};if(M(i,t.time),null!=t.matchReferenceA?"L"===t.matchReferenceA[0]?(i.opponentA=o.teams[o.teams.length-1],i.matchLoserA=h[t.matchReferenceA]):(i.opponentA=o.teams[o.teams.length-2],i.matchWinnerA=h[t.matchReferenceA]):i.opponentA=o.teams[t.opponentA],null!=t.matchReferenceB?"L"===t.matchReferenceB[0]?(i.opponentB=o.teams[o.teams.length-1],i.matchLoserB=h[t.matchReferenceB]):(i.opponentB=o.teams[o.teams.length-2],i.matchWinnerB=h[t.matchReferenceB]):i.opponentB=o.teams[t.opponentB],i.functionaries=[],v)for(var n=0;n<v.length;n++){var a=v[n],s=null;if(t.functionaries){var r=t.functionaries[a.type];s=F[r]||null}var l={type:a.type,typeName:a.description,functionary:s};i.functionaries.push(l)}o.matchesEdit.push(i)}1<o.matchesEdit.length?o.showSweeping():o.showDetails()}}T++,Vue.http.get("/api/v2/regions").then(function(e){for(var t=0;t<e.body.length;t++){var i=e.body[t];o.regions.push(i),i.id==o.region&&(o.venueRegion=i)}y()}),null==F&&(T++,Vue.http.get("/api/v2/functionaries?full=1").then(function(e){F={};for(var t=0;t<e.body.length;t++){var i=e.body[t];F[i.id]=i}y()})),0<e.length&&(T++,Vue.http.get("/api/v2/competitions/ext/teams?"+e.map(function(e){return"id="+encodeURIComponent(e)}).join("&")).then(function(e){for(var t=0;t<e.body.length;t++)for(var i=e.body[t],n=0;n<o.teams.length;n++){var a=o.teams[n];a.id==i.id&&(a.region=i.region,a.school=i.school,a.city=i.city)}y()}));var A=Object.keys(c);0<A.length&&(T++,Vue.http.get("/api/v2/facilities?"+A.map(function(e){return"id="+e}).join("&")).then(function(e){for(var t=Array.isArray(e.body)?e.body:[e.body],i=0;i<t.length;i++){var n=t[i];c[n.id]=n}y()})),y()},methods:{showSweeping:function(){this.sweeping=!0},showDetails:function(){this.sweeping=!1,this.selectedMatch||(this.selectedMatch=this.matchesEdit[0])},getOpponentName:function(e,t,i){var n=e.name;return-1===e.placement&&t?n+="<br/>"+t.name:-2===e.placement&&i&&(n+="<br/>"+i.name),n},getOpponentTeamId:function(e,t,i){var n=e.id;return-1===e.placement&&t?n=t.id:-2===e.placement&&i&&(n=i.id),n},switchOpponents:function(e){var t=e.opponentA,i=e.matchWinnerA,n=e.matchLoserA;e.opponentA=e.opponentB,e.matchWinnerA=e.matchWinnerB,e.matchLoserA=e.matchLoserB,e.opponentB=t,e.matchWinnerB=i,e.matchLoserB=n},updateTeamFacilities:function(n){var a;if(!this.teamFacilities[n]){this.teamFacilities[n]={};var e="/api/v2/facilities?team="+n;Vue.http.get(e).then((a=this,function(e){for(var t=a.teamFacilities[n],i=0;i<e.body.length;i++)t[e.body[i].id]=!0}))}},updateFacilities:function(){if(this.venueRegion){var e=this.regionFacilities[this.venueRegion.id];if(!e){this.regionFacilities[this.venueRegion.id]=e=[];var t="/api/v2/facilities?region="+this.venueRegion.id;Vue.http.get(t).then((a=(n=this).venueRegion.id,function(e){for(var t=n.regionFacilities[a],i=0;i<e.body.length;i++)e.body[i].name&&t.push(e.body[i])}))}this.facilities=e}else this.facilities=[];var n,a},updateVenue:function(){if(this.sweeping){if(this.generalVenue)for(var e=0;e<this.matchesEdit.length;e++)this.matchesEdit[e].venue=this.generalVenue}else{var t=this.matchesEdit[0].venue;if(null!=t)for(e=1;e<this.matchesEdit.length;e++){var i=this.matchesEdit[e];if(null==i.venue||i.venue.id!==t.id){t=null;break}}this.generalVenue=t}},onVenueSearch:function(e,t,i){if(this.venueRegion&&e){e=e.trim().toLowerCase();var n=this.regionFacilities[this.venueRegion.id];if(n&&""!==e){t.splice(0,t.length);for(var a=0;a<n.length;a++){var s=n[a];0<=s.name.toLowerCase().indexOf(e)&&t.push(s)}}}},generateMatchesTime:function(){if(null!=this.generalTime.date&&!this.generalTime.diffInvalid&&!this.generalTime.timeInvalid){if(f(this.generalTime),null==this.generalTime.time)return;if(null!=this.generalTime.diffHours)for(var e=60*this.generalTime.diffHours+this.generalTime.diffMinutes,t=B.parseCompetitionTime(this.generalTime.time),i=0;i<this.matchesEdit.length;i++)M(this.matchesEdit[i],Math.floor(t.getTime()/1e3)),t.setMinutes(t.getMinutes()+e);else for(i=0;i<this.matchesEdit.length;i++)M(this.matchesEdit[i],this.generalTime.time)}},onGeneralDateInput:function(){this.generateMatchesTime()},onTimeDiffInput:function(){var e=null;if(0<=this.generalTime.diffText.indexOf(":"))e=i(this.generalTime.diffText);else if(0<this.generalTime.diffText.length){var t=parseInt(this.generalTime.diffText);isFinite(t)&&0<=t&&(e={hours:Math.floor(t/60),minutes:t%60})}else e={hours:0,minutes:0};null!=e?(this.generalTime.diffHours=e.hours,this.generalTime.diffMinutes=e.minutes,Vue.delete(this.generalTime,"diffInvalid"),this.generateMatchesTime()):Vue.set(this.generalTime,"diffInvalid",!0)},onTimeInput:function(){var e=this.sweeping?this.generalTime:this.selectedMatch,t=i(e.timeText);null!=t?(e.hours=t.hours,e.minutes=t.minutes,f(e),Vue.delete(e,"timeInvalid"),this.sweeping&&this.generateMatchesTime()):(Vue.set(e,"time",null),Vue.set(e,"timeInvalid",!0))},getMatchFacilityTeam:function(e,t){if(null==e.facilities){e.facilities={};var i,n=this.getOpponentTeamId(e.opponentB,e.matchWinnerB,e.matchLoserB);if(null!=n)if(i=this.teamFacilities[n])for(var a in i)e.facilities[a]=1;if(null!=(n=this.getOpponentTeamId(e.opponentA,e.matchWinnerA,e.matchLoserA)))if(i=this.teamFacilities[n])for(var a in i)e.facilities[a]=2}return e.facilities[t.id]||0},getFacilityTeam:function(e){if(this.sweeping){for(var t=0,i=0;i<this.matchesEdit.length;i++){var n=this.matchesEdit[i],a=this.getMatchFacilityTeam(n,e);if(0<a&&1===(t=a))break}return t}return this.selectedMatch?this.getMatchFacilityTeam(this.selectedMatch,e):0},getFacilityDisplay:function(e,t){return null==e.id?"<i class='muted'>"+e.name+"</i>":this.getFacilityTeam(e)?"<strong>"+e.name+"</strong>":t},onFunctionarySearch:function(e,t,i){this.functionarySearch=e?e.trim().toLowerCase():""},getFunctionaryDisplay:function(e,t){var i=null;return e.school?i=e.school.name:e.city&&(i=e.city.name),i?"<span>"+t+" <i class='muted'>"+i+"</i></span>":"<span>"+t+"</span>"},getTeamAInfo:function(e){var t=null;if(e.matchWinnerA)t=e.matchWinnerA.id;else{if(!e.matchLoserA)return e.opponentA;t=e.matchLoserA.id}if(t)for(var i=0;i<this.teams.length;i++){var n=this.teams[i];if(n.id==t)return n}return null},getTeamBInfo:function(e){var t=null;if(e.matchWinnerB)t=e.matchWinnerB.id;else{if(!e.matchLoserB)return e.opponentB;t=e.matchLoserB.id}if(t)for(var i=0;i<this.teams.length;i++){var n=this.teams[i];if(n.id==t)return n}return null},getFunctionaries:function(e){var t=[];if(this.selectedMatch){var i=this.getTeamAInfo(this.selectedMatch)||{},n=this.getTeamBInfo(this.selectedMatch)||{};for(var a in F){var s=F[a];s.type==e&&(this.functionarySearch&&0<this.functionarySearch.length&&s.name.toLowerCase().indexOf(this.functionarySearch)<0||s.region&&(i.region&&i.region.id==s.region.id||n.region&&n.region.id==s.region.id)&&t.push(s))}function r(e){if(e.school){if(i.school&&i.school.id==e.school.id)return 0;if(n.school&&n.school.id==e.school.id)return 1}if(e.city){if(i.city&&i.city.id==e.city.id)return 2;if(n.city&&n.city.id==e.city.id)return 3}return 4}t.sort(function(e,t){var i=r(e)-r(t);return 0===i&&(i=e.name.localeCompare(t.name)),i})}return t},getTeams:function(e){if(null==e)return this.teams;for(var t=[],i=0;i<this.teams.length;i++){var n=this.teams[i];(n.placement<0||n!==e)&&t.push(n)}return t},getWinners:function(e){if(null==e)return this.winners;for(var t=[],i=0;i<this.winners.length;i++){var n=this.winners[i];n!==e&&t.push(n)}return t},getLosers:function(e){if(null==e)return this.losers;for(var t=[],i=0;i<this.losers.length;i++){var n=this.losers[i];n!==e&&t.push(n)}return t},cancel:function(){this.$emit("close")},confirm:function(){if(!this.hasInvalidTime){for(var e=[],t=0;t<this.matchesEdit.length;t++){var i=this.matchesEdit[t],n=null,a=null,s=null;-2===i.opponentA.placement?s=i.matchLoserA.reference:-1===i.opponentA.placement?s=i.matchWinnerA.reference:a=i.opponentA.placement,s?s!==i.match.matchReferenceA&&(n={match:i.match.id,matchReferenceA:s}):a!==i.match.opponentA&&(n={match:i.match.id,opponentA:a,matchReferenceA:null});var r=null,l=null;-2===i.opponentB.placement?l=i.matchLoserB.reference:-1===i.opponentB.placement?l=i.matchWinnerB.reference:r=i.opponentB.placement,l?l!==i.match.matchReferenceB&&(n||(n={match:i.match.id}),n.matchReferenceB=l):r!==i.match.opponentB&&(n||(n={match:i.match.id}),n.opponentB=r,n.matchReferenceB=null);var o=i.venue?i.venue.id:null;o!==i.match.venue&&(n||(n={match:i.match.id}),n.venue=o),f(i),i.time!==i.match.time&&(n||(n={match:i.match.id}),n.time=i.time);for(var h={},u=!1,c=0;c<i.functionaries.length;c++){var m=i.functionaries[c];m.functionary?i.match.functionaries&&i.match.functionaries[m.type]===m.functionary.id||(h[m.type]=m.functionary.id,u=!0):i.match.functionaries&&i.match.functionaries[m.type]&&(u=!(h[m.type]=null))}u&&(n||(n={match:i.match.id}),n.functionaries=h),n&&e.push(n)}this.$emit("close",e)}}},computed:{sortedFacilities:function(){var n=this,e=this.facilities.slice();return e.sort(function(e,t){var i=n.getFacilityTeam(t)-n.getFacilityTeam(e);return i||(i=e.name.localeCompare(t.name)),i}),e.splice(0,0,{id:null,name:"ללא"}),e},hasInvalidTime:function(){for(var e=0;e<this.matchesEdit.length;e++)if(this.matchesEdit[e].timeInvalid)return!0;return!1}},watch:{venueRegion:function(){this.updateFacilities()}}})});