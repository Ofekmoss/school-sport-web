define(["templates/generic","utils","dialog","services/access","components/multiselect"],function(e,i,n,r){function a(e){for(var t=function(o){return o.searchText&&0<o.searchText.length?function(e){for(var t=0;t<o.columns.length;t++){var n=s(e,o.columns[t]);if(null!=n&&("string"!=typeof n&&(n=n.toString()),0<=n.indexOf(o.searchText)))return!0}return!1}:function(){return!0}}(e),n=function(n){return n instanceof Function?n:"object"==typeof n?function(e){for(var t in n)if(l(e,t)!=n[t])return!1;return!0}:function(){return!0}}(e.filter),o=0;o<e.records.length;o++){var i=e.records[o];i.__show=n(i)&&t(i)}}function t(e){e.changingSelection||(e.records=[]);e.searchText&&e.searchText.length;if(e.data&&e.data.constructor===Array){if(20<e.data.length&&(e.changingSelection||(e.loading=!0,window.setTimeout(function(){e.loading=!1},500))),!e.changingSelection)for(var t=0;t<e.data.length;t++){var n=e.data[t];n.__show=!1,n.selected=!1,e.records.push(n)}a(e)}e.changingSelection=!1}function o(e){if(e.columns){for(var t=e.totalWidth=0;t<e.columns.length;t++){var n=e.columns[t];null==n.width&&(n.width=10),n.active&&!n.disabled&&(e.totalWidth+=n.width)}0===e.totalWidth&&(e.totalWidth=10)}}function l(e,t){"string"==typeof t&&(t=t.split("."));for(var n=e,o=0;o<t.length&&null!=n;o++){var i=t[o];n=n.constructor===Array?n.map(function(e){return e[i]}):n[i]}return n}function s(e,t){if(t.getter instanceof Function)return t.getter(e);"string"==typeof t.key&&(t.key=t.key.split("."));for(var n=e,o=0;o<t.key.length&&null!=n;o++){var i=t.key[o];n=n.constructor===Array?n.map(function(e){return e[i]}):n[i]}if(null!=n&&n.constructor===Array)return t.lookup&&(n=n.map(function(e){return t.lookup[e]})),n.map(function(e){return null==e?"":e.toString()}).join(", ");if(t.lookup)n=t.lookup[n];else if("teamApproved"==t.type&&t.extras){var r=t.extras.approved,a=t.extras.notApproved;n=r&&0!=(e[t.key]&r)?"מאושר":a&&0!=(e[t.key]&a)?"לא מאושר":"ממתין לאישור"}return"NIS"===t.type&&null!=n&&(n+=" ₪"),n}function c(e,t){return e.visiblePasswords?e.visiblePasswords[t.name]:null}var d=Vue.extend({template:e["data-table"],props:["columns","data","filter","enableExport","selection","title","clickToTick","showMoreInfo","disableSelection","disableAbsolutePosition","hideToolbar","disableSort","slimTable","newEntityCaption"],data:function(){return{records:[],totalWidth:10,searchText:"",selectionType:2,isSelectAll:!1,loading:!1,changingSelection:!1}},mounted:function(){var e=this;window.setTimeout(function(){20<e.records.length&&(e.loading=!0,window.setTimeout(function(){e.loading=!1},1500))},500),"single"===this.selection?this.selectionType=1:"none"===this.selection&&(this.selectionType=0),o(this),t(this),this.dataTableScroll=this.$el.querySelector(".data-table-scroll"),this.dataTableFloatingHeader=this.$el.querySelector("#data-table-floating-header"),this.dataTableScroll&&this.dataTableFloatingHeader&&this.dataTableScroll.addEventListener("scroll",this.handleScroll)},methods:{rowClicked:function(e){this.clickToTick&&(e.selected=!e.selected,this.$forceUpdate(),this.handleSelectionChange(e))},moreInfo:function(e,t){e.stopPropagation(),this.$emit("record-more-info",t)},update:function(){t(this)},isPasswordVisible:function(e,t){var n=c(e,t);return null!=n&&n.active},getPasswordExpireTime:function(e,t){var n=c(e,t);return n?n.expires:0},getPassword:function(e,t){var n=c(e,t);return n?n.password:""},showPassword:function(e,t){var n=this;e.visiblePasswords||(e.visiblePasswords={}),e.visiblePasswords[t.name]={active:!0,password:s(e,t),expires:10,interval:null},n.$forceUpdate(),e.visiblePasswords[t.name].interval=window.setInterval(function(){e.visiblePasswords[t.name].expires<=0?(e.visiblePasswords[t.name].active=!1,window.clearInterval(e.visiblePasswords[t.name].interval)):e.visiblePasswords[t.name].expires--,n.$forceUpdate()},1e3)},handleSelectionChange:function(e){if(this.changingSelection=!0,this.selectionType)if(1===this.selectionType){for(var t=0;t<this.records.length;t++){var n=this.records[t];n.selected&&n!==e&&(n.selected=!1)}this.$emit("selection-change",e.selected?e:null)}else this.$emit("selection-change")},sort:function(n){this.columns.forEach(function(e){e!=n&&(e.sort=null)}),"a"==n.sort?(n.sort="d",this.records.sort(function(e,t){return"function"==typeof n.getSortValue?n.getSortValue(e)<n.getSortValue(t)?1:-1:s(e,n)<s(t,n)?1:-1})):(n.sort="a",this.records.sort(function(e,t){return"function"==typeof n.getSortValue?n.getSortValue(e)<n.getSortValue(t)?-1:1:s(e,n)<s(t,n)?-1:1}))},toggleColumn:function(e){this.columns[e].active=!this.columns[e].active,console.log("toggle"),o(this)},handleColumnChange:function(){o(this)},selectAll:function(){if(2===this.selectionType){var t=this;t.records.forEach(function(e){e.selected=t.isSelectAll}),t.records=this.records.slice(),this.handleSelectionChange()}},getValue:function(e,t){return s(e,t)},exportExcel:function(){var e=(this.title||"report")+" - "+(new Date).getTime()+".xls";$(".tooltip").each(function(){var e=$(this),t=e.html();e.data("html",t),e.html(""),e.next().css("color","red")}),i.excelReport(e,null,".headerTable:visible"),window.setTimeout(function(){$(".tooltip").each(function(){var e=$(this),t=e.data("html");e.html(t),e.next().css("color","inherit")})},1500)},downloadDocument:function(e,t){if(t.key&&0<t.key.length){var n=t.key[0];if("order"===n||"payment"===n){var o=s(e,t);i.downloadPayment(o)}}},viewDocument:function(e,t){if(t.key&&0<t.key.length){var n="string"==typeof t.key?t.key:t.key[0];if("order"===n||"payment"===n){var o=s(e,t);window.open(i.getPaymentUrl(o),"_blank")}}},handleScroll:function(e){0<this.dataTableScroll.scrollTop?"block"!=this.dataTableFloatingHeader.style.display&&(this.dataTableFloatingHeader.style.left=this.dataTableScroll.firstChild.offsetLeft+"px",this.dataTableFloatingHeader.style.display="block"):"none"!=this.dataTableFloatingHeader.style.display&&(this.dataTableFloatingHeader.style.display="none")},newEntityClicked:function(){this.$emit("new-entity")},loginClicked:function(e){var o=e.user;if(null!=i.intOrDefault(o)){var t="האם להתחבר בתור בית ספר "+e.name+"?";n.open("general/message-box",{caption:"התחברות בתור בית ספר",message:t,alert:!0,confirmText:"אישור",cancelText:"ביטול"},function(e,t){if(t){var n={userid:o,delegatedUser:{id:r.user.id,name:r.user.name.split(" ")[0]}};Vue.http.post("/api/v2/login",n).then(function(e){r.user=e.data,r.$emit("login",r.user)},function(e){console.log("error"),console.log(e)})}})}else console.log("school "+e.id+" has no user")}},destroyed:function(){this.dataTableScroll&&this.dataTableFloatingHeader&&this.dataTableScroll.removeEventListener("scroll",this.handleScroll)},watch:{data:function(){t(this)},filter:function(){a(this)},searchText:function(){a(this);var o=this;o.records.forEach(function(e){for(var t=0;t<o.columns.length;t++){var n=s(e,o.columns[t]);if(null!=n){if("string"!=typeof n&&(n=n.toString()),0<=n.indexOf(o.searchText)){e.__show=!0;break}e.__show=!1}else e.__show=!1}}),this.$emit("search-change")},records:{deep:!0,handler:function(){this.$emit("records-change")}}}});return Vue.component("data-table",d),d});