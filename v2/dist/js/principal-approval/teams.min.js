define(["templates/principal-approval","services/access","services/products","dialog","utils"],function(t,e,o,r,i){var n=["א'","ב'","ג'","ד'","ה'","ו'","ש'"];function a(t){var e=t%60;return("0"+(t-e)/60).slice(-2)+":"+("0"+e).slice(-2)}function s(t,e){for(var n=0;n<t.length;n++){var o=t[n];if(o.id===e)return o}return null}function c(r){!function(o,i){Vue.http.get("/api/v2/registration/league/competitions").then(function(t){for(var e=0;e<t.body.sports.length;e++){var n=t.body.sports[e];n.league=!0,o.sports.push(n)}Vue.http.get("/api/v2/registration/club/competitions").then(function(t){for(var e=0;e<t.body.sports.length;e++){var n=t.body.sports[e];n.club=!0,o.sports.push(n)}i()},function(t){i(t)})},function(t){i(t)})}(r,function(t){t||Vue.http.get("/api/v2/registration/team-confirmations").then(function(t){var i={};if(t.body)for(var e=0;e<t.body.length;e++){var n=t.body[e];i[n.Id.toString()]=n}Vue.http.get("/api/v2/registration/league/teams").then(function(t){for(var e=r.approveCount=0;e<t.body.length;e++){var n=t.body[e];if(n.approved){n.selected=r.selectAll,n.active&&0==(2&n.approved)&&r.approveCount++;var o=r.sports.find(function(t){return t.id==n.sport&&1==t.league});o&&(n.sport=o,n.category=s(n.sport.categories,n.competition),n.category&&r.teams.push(n),n.price||(n.price=r.teamPrice))}}Vue.http.get("/api/v2/registration/club/teams").then(function(t){for(var e=0;e<t.body.length;e++){var n=t.body[e];n.active=!0,n.selected=r.selectAll,0==(2&n.approved)&&r.approveCount++;var o=r.sports.find(function(t){return t.id==n.sport&&1==t.club});o&&(n.sport=o,n.category=s(n.sport.categories,n.competition),n.category&&r.teams.push(n))}r.teams.forEach(function(t){var e=i[t.id.toString()];e&&(t.DateConfirmed=new Date(e.DateConfirmed))}),r.teams.sort(function(t,e){return new Date(e.createdAt)-new Date(t.createdAt)})},function(t){console.log(t)})},function(t){console.log(t)})},function(t){console.log(t)})})}return Vue.extend({template:t.teams,data:function(){return{user:e.user,confirmation:!1,approveCount:0,facilities:[],sports:[],teams:[],selectAll:!0,confirmedAt:null,selectionCount:function(){return this.teams.filter(function(t){return!0===t.selected}).length}}},mounted:function(){!function(n){Vue.http.get("/api/v2/facilities/-").then(function(t){for(var e=0;e<t.body.length;e++)n.facilities.push(t.body[e])},function(t){console.log(t)})}(this);var n=this;!function(n,o){Vue.http.get("/api/v2/registration/confirmations").then(function(t){n.confirmedAt=null;var e=t.body["principal-teams"];e&&(n.confirmedAt=i.parseRawDate(e)),o()},function(t){n.confirmedAt=null,o(t)})}(n,function(t){o.getById(200,function(t,e){n.teamPrice=e.price,c(n)})})},watch:{selectAll:function(){var e=this;e.teams.forEach(function(t){t.selected=e.selectAll})},teams:{handler:function(t){0<this.teams.length&&0===this.selectionCount()&&!0===this.selectAll?this.selectAll=!1:0<this.teams.length&&this.selectionCount()===this.teams.length&&!1===this.selectAll&&(this.selectAll=!0)},deep:!0}},methods:{isApproved:function(t){return!(!t.active||!t.approved)&&0!=(2&t.approved)},getFacilityName:function(t){for(var e=0;e<this.facilities.length;e++){var n=this.facilities[e];if(n.id===t)return n.name}return null},getActivityText:function(t){return t.map(function(t){return null!=t.day?n[t.day]+(null!=t.startTime?" "+a(t.startTime):"")+(null!=t.endTime?"-"+a(t.endTime):""):""}).join("; ")},logout:function(){e.logout()},confirm:function(){var n=this,o=n.teams.filter(function(t){return!0===t.selected}),i=o.map(function(t){return t.id});Vue.http.post("/api/v2/registration/league/teams/approve/principal",i).then(function(t){Vue.http.post("/api/v2/registration/club/teams/approve/principal",i).then(function(t){o.forEach(function(t){t.active&&(t.approved|=2,n.approveCount--,t.selected=!1,t.DateConfirmed||(t.DateConfirmed=new Date))});var e={Approval:1,Teams:i};Vue.http.post("/api/v2/registration/confirmation",e).then(function(t){console.log("confirmed")},function(t){console.log(t)})},function(t){r.open("general/error-message",{caption:"פעולה נכשלה",message:"string"==typeof t.body?t.body:"כשלון בעדכון נתונים"})})},function(t){r.open("general/error-message",{caption:"פעולה נכשלה",message:"string"==typeof t.body?t.body:"כשלון בעדכון נתונים"})})}}})});