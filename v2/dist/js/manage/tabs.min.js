define(["templates/manage","utils","dialog","services/access","consts","manage/dal","manage/new-team","manage/filters-teams","manage/filters-players","components/multiselect","components/multiselect-search"],function(e,r,t,n,i,o){function s(e){var t=[];e.forEach(function(e){0!==e.type&&t.push({title:e.title,type:e.type,filters:e.activeFilters})}),localStorage.setItem(i.stateStr,JSON.stringify(t))}function a(e){}function c(e){return o.getTeams(e).then(function(e){for(var t=[],n=0;n<e.body.length;n++){var i=e.body[n];2==i.teamStatus&&15==i.approved&&(i.green=!0),t.push(i)}return t.sort(function(e,t){return new Date(t.createdAt)-new Date(e.createdAt)}),t})}function l(e){return Vue.http.get("/api/v2/admin/players").then(function(e){for(var t=[],n=0;n<e.body.length;n++){var i=e.body[n];if(null==i.approved&&(i.approved=0),i.TransferRequested&&(i.playerStatus=5),i.maxStudentAge){var r=new Date(i.maxStudentAge);new Date(i.student.birthDate)<r&&(i.highlighted=!0)}return i.deletedAt&&(i.playerStatus=9,i.red=!0,i.highlighted=!1,i.tooltip="רישום הוסר בתאריך "+ParseDateTime(i.deletedAt,"DD/MM/YYYY")+" בשעה "+ParseDateTime(i.deletedAt,"HH:mm")),t.push(i),t}})}function u(e){}function d(e){}function f(e,t){var n;return e===i.tabTypes.DASHBOARD?(console.log("get dashboard data"),n=a):e===i.tabTypes.TEAMS?(console.log("get teams data"),n=c):e===i.tabTypes.PLAYERS?(console.log("get players data"),n=l):e===i.tabTypes.SCHOOLS?(console.log("get schools data"),n=u):e===i.tabTypes.CHAMPIONSHIPS&&(console.log("get championships data"),n=d),n(t).then(function(e){return e=e.map(function(e){return e.__show=!0,e})})}return Vue.extend({template:e.tabs,data:function(){return{user:n.user,tabs:i.tabDefinitions.slice(0,1),selectedTab:0,isShowAddOptions:!1,newTabTypes:i.tabDefinitions,drawerState:!0,regions:[],championships:[],competitions:[],newEmptyRecord:null}},mounted:function(){var t=this;this.regions=Vue.http.get("/api/v2/regions").then(function(e){for(var t=[],n=0;n<e.body.length;n++)t.push(e.body[n]);return t}).then(function(e){t.regions=e}),this.schools=Vue.http.get("/api/v2/admin/schools?region="+n.user.region).then(function(e){for(var t=[],n=0;n<e.body.length;n++)t.push(e.body[n]);return t}).then(function(e){t.schools=e});var e=function(){var e=localStorage.getItem(i.stateStr);return JSON.parse(e)}();e&&e.forEach(function(e){t.openTab(e.type,e.filters)})},computed:{},watch:{},methods:{logout:function(){n.logout()},selectTab:function(e){this.selectedTab=e},openNewTabDialog:function(){var n=this;t.open("manage/new-tab-dialog",{types:this.newTabTypes.filter(function(e){return 1==e.canInstantiate})},function(e,t){void 0!==t&&n.openTab(t)})},openTab:function(e,t){var n=this;this.selectedTab++,this.getTab(e,t).then(function(e){e.initFilters=t,n.tabs.push(e)})},getTab:function(t,e){var n=this,r=Object.assign({},i.tabDefinitions.find(function(e){return e.type==t}));return r.columns=r.columns.map(function(e){return e.activeField=e.active,e}),r.records.splice(),e&&e[r.minimumFilter]?f(r.type,e).then(function(e){return r.allRecords=e,r.records=e.slice(),r.columns.forEach(function(t){var i=[];r.records.forEach(function(e){i.push({title:n.getValue(e,t),value:!1,isActive:!0})}),i=i.filter(function(e,t){for(var n=0;n<i.length;n++)if(i[n].title===e.title)return n==t}),t.textFilterOptions=i}),r}):(r.allRecords=[],r.records=[],Promise.resolve(r))},refreshData:function(e){var n=this;if(!e[this.tabs[this.selectedTab].minimumFilter])return n.tabs[n.selectedTab].allRecords=[],void(n.tabs[n.selectedTab].records=[]);this.tabs[this.selectedTab].activeFilters=e,s(this.tabs),f(this.tabs[this.selectedTab].type,e).then(function(e){n.tabs[n.selectedTab].allRecords=e,n.tabs[n.selectedTab].records=e.slice(),n.tabs[n.selectedTab].columns.forEach(function(t){var i=[];n.tabs[n.selectedTab].records.forEach(function(e){i.push({title:n.getValue(e,t),value:!1,isActive:!0})}),i=i.filter(function(e,t){for(var n=0;n<i.length;n++)if(i[n].title===e.title)return n==t}),t.textFilterOptions=i})})},toggleDrawer:function(){this.drawerState=!this.drawerState},selectAll:function(t){2==t.selectionType&&(t.records.forEach(function(e){e.selected=t.isSelectAll}),t.records=t.records.slice())},sort:function(e,n){if(getValue=this.getValue,e.columns.forEach(function(e){e!=n&&(e.sort=null)}),"a"==n.sort){if(n.sort="d",e.columns=e.columns.slice(),!e.records)return;e.records.sort(function(e,t){getValue(e,n),getValue(t,n)})}else{if(n.sort="a",e.columns=e.columns.slice(),!e.records)return;e.records.sort(function(e,t){return getValue(e,n)>getValue(t,n)?-1:1})}},exportExcel:function(){r.excelReport("download","headerTable")},closeTab:function(e){var t;this.selectedTab>e?(t=this.tabs.splice(e,1),this.selectedTab--):t=(this.selectedTab<e||(this.selectedTab=0),this.tabs.splice(e,1)),this.resetTab(t[0]),s(this.tabs)},resetTab:function(e){e.columns.forEach(function(e){delete e.sort})},handleColumnChange:function(e){!function(e){if(e.columns){for(var t=e.totalWidth=0;t<e.columns.length;t++){var n=e.columns[t];null==n.width&&(n.width=10),n.active&&(e.totalWidth+=n.width)}0===e.totalWidth&&(e.totalWidth=10)}}(e)},getValue:function(t,n){"string"==typeof n.key&&(n.key=n.key.split("."));for(var i=t,e=0;e<n.key.length&&null!=i;e++){var r=n.key[e];i=i.constructor===Array?i.map(function(e){return e[r]}):i[r]}if(null!=i&&i.constructor===Array)return n.lookup&&(i=i.map(function(e){return n.lookup[e]})),"activity"===n.type?i.map(function(e){return e.Day+" "+e.StartTime+" - "+e.EndTime}).join(", "):i.map(function(e){return e.toString()}).join(", ");if("select"==n.type)return n.extras?this[n.options].find(function(e){return e.id==t[n.extras.key]})[n.extras.options].find(function(e){return e.id==i}).name:this[n.options].find(function(e){return e.id==i}).name;if(n.lookup)i=n.lookup[i];else if("teamApproved"==n.type&&n.extras){var o=n.extras.approved,s=n.extras.notApproved;i=o&&0!=(t[n.key]&o)?"מאושר":s&&0!=(t[n.key]&s)?"לא מאושר":"ממתין לאישור"}return i},toggleRecordSelect:function(e,t){this.tabs[this.selectedTab].type;e.records=e.records.map(function(e,t){return e.__id=t,e.selected=!1,e.__editedRecord=r.mergeDeep({},e),e}),t&&(t.selected=!t.selected),e.selectedRecords=e.records.filter(function(e){return e.selected}),this.newEmptyRecord=null,e.records=e.records.slice()},filter:function(e,t){t.openFilter||e.columns.forEach(function(e){e.openFilter=!1}),t.openFilter=!t.openFilter,e.columns=e.columns.slice()},filterRecords:function(t,e){var n=this.getValue;e.isFilterActive=e.textFilterOptions.reduce(function(e,t){return e||t.value},!1);var i=[];t.columns.reduce(function(e,t){return e||t.isFilterActive},!1)?t.allRecords.forEach(function(e){(function(i,r,e){var t=e.filter(function(e){return e.isFilterActive});return t=t.reduce(function(e,n){var t=n.textFilterOptions.reduce(function(e,t){return e||t.value&&i(r,n)==t.title},!1);return e&&t},!0)})(n,e,t.columns)&&i.push(e)}):i=t.allRecords.slice(),t.records=i,t.columns=t.columns.slice()},onFilterSearch:function(e,t){t.searchText?t.textFilterOptions.forEach(function(e){e.title.indexOf(t.searchText)<0?e.isActive=!1:e.isActive=!0}):t.textFilterOptions=t.textFilterOptions.map(function(e){return e.isActive=!0,e}),e.columns=e.columns.slice()},saveRecord:function(){for(var e=r.mergeDeep({},this.tabs[this.selectedTab].selectedRecords[0].__editedRecord),t=function(e){for(var t={},n=0;n<e.length;n++)for(var i=t,r=0;r<e[n].key.length;r++)r===e[n].key.length-1?i[e[n].key[r]]="":(i[e[n].key[r]]||(i[e[n].key[r]]={}),i=i[e[n].key[r]]);return t}(this.tabs[this.selectedTab].columns),n=this.tabs[this.selectedTab].records,i=0;i<n.length;i++)if(n[i].__id==e.__id){this.tabs[this.selectedTab].records[i]=e,this.tabs[this.selectedTab].records[i].__editedRecord=t;break}!function(e){Vue.http.put("/api/v2/admin/teams/"+encodeURIComponent(e.id),{sport:e.sport,competition:e.competition,teamNumber:e.teamNumber,coach:e.coach,facility:e.facility,activity:e.activity}).then(function(){}).catch(function(){})}(e),this.tabs[this.selectedTab].records=this.tabs[this.selectedTab].records.slice()},updateTab:function(e){e.columns=e.columns.slice()},getOptions:function(e,t,n){return Array.isArray(e)?e:e&&!t?this[e]:t(this[e],n)},getModelFromKey:function(e,t){for(var n=t.key,i=e,r=0;r<n.length-1;r++)i=i[n[r]];return i},onColumnClick:function(e,t){t.linkToTab&&this.openTab(t.linkToTab,e[t.linkParams])},newRecord:function(e){var t=this.tabs[this.selectedTab];this.toggleRecordSelect(t),this.tabs[this.selectedTab].type===i.tabTypes.TEAMS&&(this.newEmptyRecord=e||{Coach:{},School:{},Facility:{},Championship:{},Category:{},AlternativeFacility:{},Manager:{},Sport:{},Activity:[{}]})}}})});