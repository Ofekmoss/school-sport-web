define(["templates/manage","manage/dal","utils","dialog","manage/filters-teams","manage/new-team","manage/data-table2","components/multiselect"],function(e,s,c,l){var m=1,t=2,p=4;function u(a,e,n){var t={teams:[{id:e}],status:2};Vue.http.post("/api/v2/admin/teams/status",t).then(function(e){if(0<e.body.length){var t=e.body[0];n.TeamId=t.team,n.AdminStatus=2}a.refresh(a.latestFilters)},function(e){console.log(e)})}var a=[{key:"School.SYMBOL",name:"סמל בית ספר",filter:!0,active:!0,type:"text"},{key:"School.SCHOOL_NAME",name:"שם בית ספר",filter:!0,active:!0,type:"text"},{key:"Region.Name",name:"מחוז",active:!0,filter:!0,type:"text"},{key:"CityData.Name",name:"רשות",active:!1,filter:!0,type:"text"},{key:"Sport.Name",name:"ענף ספורט",active:!0,filter:!0,type:"text",options:"sports"},{key:"Championship.Name",name:"אליפות",filter:!0,active:!0,type:"text"},{key:"Category.Name",name:"קטגוריה",filter:!0,active:!0,type:"text"},{key:"TeamNumberDisplay",name:"קבוצה",active:!0,type:"text"},{key:"PlayerCount",name:"מספר שחקנים",active:!1,type:"text",openTab:{route:"manage/players",params:{region:"Region.Id",sport:"Sport.Id",championship:"Championship.Id",category:"Category.Id",team:"Id"}}},{key:"Payment.Order",name:"דרישת תשלום",type:"documentNumber",active:!0},{key:"AdminStatus",name:"סטטוס",filter:!0,active:!0,type:"",lookup:{1:"רשומה",2:"מאושרת"}},{id:"Approved1",key:"Approved",name:"אישור נציג",active:!0,type:"func",func:function(e){for(var t=Number(e).toString(2);t.length<4;)t="0"+t;return 1==t[t.length-3]?"נציג אישר":"נציג לא אישר"},link:function(e){return e.RepresentativeLoginLink||null}},{id:"Approved2",key:"Approved",name:"אישור מנהל",active:!0,type:"func",func:function(e){for(var t=Number(e).toString(2);t.length<4;)t="0"+t;return 1==t[t.length-2]?"מנהל אישר":"מנהל לא אישר"},link:function(e){return e.PrincipalLoginLink||null}},{id:"Approved3",key:"Approved",name:"אישור מפקח",active:!0,type:"func",func:function(e){for(var t=Number(e).toString(2);t.length<4;)t="0"+t;return 1==t[t.length-4]?"מפקח אישר":"מפקח לא אישר"}},{key:"Coach.Email",name:"אימייל מאמן",active:!1,type:"text"},{key:"Coach.PhoneNumber",name:"טלפון מאמן",active:!1,type:"text"},{key:"Coach.Name",name:"שם מאמן",filter:!0,active:!1,type:"text"},{key:"Coach.certification",name:"הסמכה",active:!1,filter:!0,type:"text"},{key:"Facility.Name",name:"מתקן",filter:!1,active:!1},{key:"Facility.Id",name:"מזהה מתקן",active:!1,type:"text"},{key:"AlternativeFacility.Name",name:"מתקן חלופי",active:!1,type:"text"},{key:"AlternativeFacility.Address",name:"כתובת מתקן חלופי",active:!1,type:"text"},{key:"Teacher.Name",name:"מורה אחראי",filter:!0,active:!1,type:"text"},{key:"Teacher.PhoneNumber",name:"טלפון מורה אחראי",active:!1,type:"text"},{key:"Teacher.Email",name:"מייל מורה אחראי",active:!1,type:"text"},{key:"ActivityTimes",name:"ימים ושעות פעילות",active:!1,type:"activity"},{key:"HostingHours",name:"ימים ושעות אירוח",active:!1,type:"activity"},{key:"Manager.Name",name:"מנהל מקצועי",active:!1,filter:!0,type:"text"},{key:"Manager.Email",name:"אימייל מנהל מקצועי",active:!1,type:"text"},{key:"Manager.PhoneNumber",name:"טלפון מנהל מקצועי",active:!1,type:"text"},{key:"Principal.Name",name:'מנהל בי"ס',active:!1,filter:!0,type:"text"},{key:"Principal.Email",name:'אימייל מנהל בי"ס',active:!1,type:"text"},{key:"Principal.PhoneNumber",name:'טלפון מנהל בי"ס',active:!1,type:"text"},{key:"Representative.Name",name:"נציג רשות מקומית",active:!1,filter:!0,type:"text"},{key:"Representative.Email",name:"אימייל נציג רשות",active:!1,type:"text"},{key:"Representative.PhoneNumber",name:"טלפון נציג רשות",active:!1,type:"text"},{key:"CreatedAt",name:"תאריך הקמה",active:!1,type:"date",format:"dd/MM/yyyy"},{key:"RegistrationDate",name:"תאריך רישום",active:!1,type:"date",format:"dd/MM/yyyy"},{key:"ConfirmationDate",name:"תאריך אישור",active:!1,type:"date",format:"dd/MM/yyyy"},{key:"PlayerNumberFrom",name:"מספר חולצה מינימום",active:!1,type:"text"},{key:"PlayerNumberTo",name:"מספר חולצה מקסימום",active:!1,type:"text"}];function n(o,r){l.open("manage/approve-teams-dialog",{teams:o.selectedTeams,status:r},function(e,t){if(!e&&t){var a={teams:o.selectedTeams.map(function(e){return null==e.TeamId?{id:e.Id}:{team:e.TeamId}}),status:r};Vue.http.post("/api/v2/admin/teams/status",a).then(function(e){for(var t=0;t<e.body.length;t++)for(var a=e.body[t],n=0;n<o.selectedTeams.length;n++){var i=o.selectedTeams[n];if(i.Id===a.id){i.TeamId=a.team;break}}o.selectedTeams.forEach(function(e){2===(e.AdminStatus=r)?null==e.ConfirmationDate&&(e.ConfirmationDate=new Date,e.confirmationDate=s.getDateText(e.ConfirmationDate)):(e.ConfirmationDate=null,e.confirmationDate=null)})},function(e){console.log(e)})}})}return Vue.extend({template:e.teams,data:function(){return{tabName:"קבוצות",caption:"קבוצות",image:"img/icon-teams.svg",records:[],columns:a,selectedTeams:[],initFilters:{},title:"12",state:null,loading:!1,latestFilters:null}},props:{sport:{},region:{},championship:{},category:{}},mounted:function(){var t=this;t.sport=t.sport?parseInt(t.sport):"",t.region=t.region?parseInt(t.region):"",t.championship=t.championship?parseInt(t.championship):"",t.category=t.category?parseInt(t.category):"",t.initFilters={sport:t.sport,region:t.region,championship:t.championship,category:t.category},Vue.http.get("/api/v2/cache?key=manage-teams-columns").then(function(e){if(e&&e.body&&e.body.Value){var a=e.body.Value.split(",");0<a.length&&t.columns.forEach(function(e){var t=(e.id||e.key).replace(",",".");e.originalActive=e.active,e.active=0<=a.indexOf(t)})}})},methods:{updateCaption:function(e){this.caption=e},updateNewTeam:function(e){this.refresh()},refresh:function(e){var t=this;(t.latestFilters=e)&&(t.updateCaption(e.description),t.championship=e.championship?e.championship.id:"",t.category=e.category?e.category.id:"",t.region=e.region?e.region.id:"",t.sport=e.sport?e.sport.id:"");var a={championship:t.championship,region:t.region,sport:t.sport,category:t.category};t.loading=!0,s.getTeams(a).then(function(e){e.forEach(function(e){e.Tokens&&e.Tokens.Principal&&(e.PrincipalLoginLink="https://www.schoolsport.org.il/v2/#/login?token="+e.Tokens.Principal),e.Tokens&&e.Tokens.Representative&&(e.RepresentativeLoginLink="https://www.schoolsport.org.il/v2/#/login?token="+e.Tokens.Representative)}),e.forEach(function(e){e.TeamNumberDisplay=e.TeamNumber,null!=e.AdditionalTeamNumber&&0<e.AdditionalTeamNumber.length&&(e.TeamNumberDisplay+=" ("+e.AdditionalTeamNumber+")")}),t.records=e,t.loading=!1})},onEditTeam:function(t){void 0!==t&&null!=t||(t=!1);var n=this,e=t?"duplicate":"edit";if(null!=n.selectedTeams&&1===n.selectedTeams.length){var i=n.selectedTeams[0],a=n.records.filter(function(e){return!(null!=i.Id&&i.Id===e.Id||null!=i.TeamId&&i.TeamId===e.TeamId)&&e.Category.Id===i.Category.Id&&e.School.School===i.School.School}).map(function(e){return e.TeamNumber||""}),o=i.AdminStatus,r=t?p:m;l.open("manage/new-team",{record:c.deepClone(i),region:n.region,state:r,disableClickOutside:!0,teamNumbersInUse:a},function(e,a){null!=a&&(t?l.open("general/message-box",{caption:"שכפול קבוצה",message:"האם לאשר את הקבוצה החדשה?",alert:!0,confirmText:"כן",cancelText:"לא"},function(e,t){!0===t?u(n,a.Id,i):n.refresh(n.latestFilters)}):2!=o&&2==a.AdminStatus?u(n,i.Id,i):n.refresh(n.latestFilters))})}else console.log("Can "+e+" a team only with one row selected")},duplicateTeam:function(){this.onEditTeam(!0)},onRecordSelect:function(e){this.selectedTeams=e},newTeam:function(){var a=this;if(null!=a.latestFilters&&null!=a.latestFilters.championship&&null!=a.latestFilters.category){var e=a.latestFilters.championship.name+" "+a.latestFilters.category.name;l.open("manage/new-team",{record:{school:null,championship:null,status:null,teamNumber:null,supervisor:null,registrationDate:null,shirtNumberFrom:null,shirtNumberTo:null},region:a.latestFilters.region?a.latestFilters.region.id:null,championship:a.latestFilters.championship?a.latestFilters.championship.id:null,category:a.latestFilters.category?a.latestFilters.category.id:null,state:t,description:e,disableClickOutside:!0},function(e,t){null!=t&&a.refresh(a.latestFilters)})}else console.log("can't add team without a selected championship and category")},removeTeam:function(){var n=this,e="נא לאשר את מחיקת ";e+=1===n.selectedTeams.length?"הקבוצה הבאה:":n.selectedTeams.length+" הקבוצות הבאות:",e+="<br />"+n.selectedTeams.map(function(e){return e.School.SCHOOL_NAME+" "+e.Sport.Name+" "+e.Category.Name+" "+e.TeamNumber}).join("<br />"),l.open("general/message-box",{caption:"מחיקת קבוצה",message:e,alert:!0,confirmText:"אישור",cancelText:"ביטול"},function(e,t){if(t){var a=[];n.selectedTeams.forEach(function(e){var t={TeamId:e.TeamId,Id:e.Id};a.push(s.deleteTeam(t))}),c.promiseAll(a).then(function(e){n.refresh()}).catch(function(e){if(0<e.body.indexOf("יש להסיר")){var t=1===n.selectedTeams.length?"לקבוצה זו יש שחקנים רשומים":"לאחת או יותר מהקבוצות יש שחקנים רשומים";t+=", האם למחוק בכל זאת? שחקנים יימחקו גם כן",l.open("general/message-box",{caption:"מחיקת קבוצה",message:t,alert:!0,confirmText:"אישור",cancelText:"ביטול"},function(e,t){t&&(a=[],n.selectedTeams.forEach(function(e){var t={TeamId:e.TeamId,Id:e.Id,confirmed:1};a.push(s.deleteTeam(t))}),c.promiseAll(a).then(function(e){n.refresh()}).catch(function(e){l.open("general/message-box",{caption:"שגיאה",message:e.body,alert:!0})}))})}else l.open("general/message-box",{caption:"שגיאה",message:e.body,alert:!0})})}})},onActiveColumns:function(){var a=this,e=a.columns.map(function(e){return Object.assign({},e)});l.open("manage/columns-select-dialog",{columns:e,max:15,key:"manage-teams"},function(e,t){t&&(a.columns=t.map(function(e){return Object.assign({},e)}))})},onExport:function(){this.columns.map(function(e){return Object.assign({},e)});c.excelReport("data","headerTable")},approveTeams:function(){n(this,2)},disApproveTeams:function(){n(this,1)},resetSelection:function(){var e=this;e.records.forEach(function(e){e.selected=!1}),e.selectedTeams=[],e.records=e.records.slice(),e.$forceUpdate()}}})});