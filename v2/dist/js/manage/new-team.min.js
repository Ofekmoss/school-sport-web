define(["templates/manage","manage/dal","dialog","utils"],function(e,n,t,a){function o(t){var e={};0<=t.region&&(e.region=t.region),n.getSchools(e).then(function(e){t.schools=e.map(function(e){return e.label=e.name+" "+e.Symbol,e}),t.record.School=null})}function c(e,t){var i=(t||"").replace("'","");return!(null!=e.teamNumbersInUse&&0<e.teamNumbersInUse.length)||-1===e.teamNumbersInUse.map(function(e){return e.replace("'","")}).indexOf(i)}return Vue.extend({template:e["new-team"],data:function(){return{schools:[],facilities:[],schoolId:{},isValid:!1,states:{edit:1,new:2,view:3,duplicate:4},roles:[{id:2,name:"מנהל"},{id:4,name:"נציג רשות"},{id:8,name:"מפקח"}],adminStatuses:[{Id:0,Name:"[ללא סטטוס]"},{Id:1,Name:"רשומה"},{Id:2,Name:"מאושרת"}],record:{},region:-1,regions:[],chargeSeason:-1,chargeSeasons:[],state:0,teamInfoOpen:!0,rolesInfoOpen:!1,facilityOpen:!1,changed:!1,teamNumbersInUse:[],description:"",category:0,existingTeamNumbers:[],generalErrorMessage:"",schoolData:null,schoolPanelOpen:!0,activityTimesPanelOpen:!1,hostingHoursPanelOpen:!1,startHours:a.getStartHours(),activityEndHours:a.getEndHours(),hostingEndHours:a.getEndHours(),facilityRegion:-1,facilityCities:[],facilityCity:-1,regionFacilities:[],teamFacility:null,maxTeams:4,overMaxTeams:!1,addingNewFacility:!1,newFacility:{Name:"",Address:""}}},mounted:function(){var t=this;if(n.getSeasons().then(function(e){t.chargeSeasons=e,a.sortByName(t.chargeSeasons),n.getRegions().then(function(e){t.regions=e,a.sortByName(t.regions)})}),o(t),t.record.School=t.record.School||{},t.schoolId={value:t.record.School.School,key:"Id"},t.record.City=t.record.City||{},t.record.Region=t.record.Region||{},t.record.Championship=t.record.Championship||{},t.record.Coach=t.record.Coach||{},t.record.CoachHelper=t.record.CoachHelper||{},t.record.Manager=t.record.Manager||{},t.record.Teacher=t.record.Teacher||{},t.record.Facility=t.record.Facility||{},t.record.AlternativeFacility=t.record.AlternativeFacility||"",t.state===t.states.new?t.record.AdminStatus=t.adminStatuses[2].Id:t.record.isAthletics=t.isAthletics(),t.state===t.states.duplicate&&(t.record.AdminStatus=t.adminStatuses[0].Id),null!=t.record.RegistrationDate&&t.record.RegistrationDate.getFullYear()<2e3&&(t.record.RegistrationDate=null),t.state!==t.states.new&&null==t.record.TeamId&&(t.adminStatuses=t.adminStatuses.filter(function(e){return 2===e.Id})),t.schoolData={representativeLoginLink:t.record.RepresentativeLoginLink,principalLoginLink:t.record.PrincipalLoginLink,gotData:!1},t.schoolData.gotData=null!=t.schoolData.representativeLoginLink||null!=t.schoolData.principalLoginLink,t.record&&t.record.School&&t.record.IsClub&&n.getSchoolRegistrationData(t.record.School.School).then(function(e){t.schoolData.registration=e,null!=t.schoolData.registration&&(t.schoolData.registration.coordinatorDisplay="",null!=t.schoolData.registration.Coordinator&&(t.schoolData.registration.coordinatorDisplay=[t.schoolData.registration.Coordinator.Name,t.schoolData.registration.Coordinator.PhoneNumber,t.schoolData.registration.Coordinator.Email].join(", "),t.schoolData.gotData=!0,t.$forceUpdate()))}),null!=t.record.ActivityTimes&&t.record.ActivityTimes.length||(t.record.ActivityTimes=[{}]),null!=t.record.HostingHours&&t.record.HostingHours.length||(t.record.HostingHours=[{}]),a.activityMethods.computeEndTime(t.record.ActivityTimes),a.activityMethods.computeEndTime(t.record.HostingHours),t.teamFacility=t.record.Facility?t.record.Facility.Id:null,null!=t.record.Region){var e=t.record.Region.Id;t.facilityRegion=e,t.facilityRegionChanged(function(){t.facilityCity=t.record.City,t.facilityCityChanged(function(){null!=t.record.Facility&&(t.record.Facility.Id=t.teamFacility)})})}if(t.overMaxTeams=null!=t.teamNumbersInUse&&t.state==t.states.duplicate&&t.teamNumbersInUse.length>=t.maxTeams,t.state==t.states.duplicate){for(var i=null==t.record.TeamNumber||0===t.record.TeamNumber.length?"א":t.record.TeamNumber,r=String.fromCharCode(i.charCodeAt(0)+1);!c(t,r);)r=String.fromCharCode(r.charCodeAt(0)+1);t.record.TeamNumber=r,t.record.RegistrationDate=new Date,t.record.AdminStatus=t.adminStatuses[2].Id}},methods:{activityMethods:function(){return a.activityMethods},toggleTeamInfo:function(){this.teamInfoOpen=!this.teamInfoOpen},toggleSchoolPanel:function(){this.schoolPanelOpen=!this.schoolPanelOpen},toggleActivityTimesPanel:function(){this.activityTimesPanelOpen=!this.activityTimesPanelOpen},toggleHostingHoursPanel:function(){this.hostingHoursPanelOpen=!this.hostingHoursPanelOpen},resetChargeSeason:function(){this.chargeSeason=-1},invalidFormReason:function(){var e=this,t=null;if(e.state===e.states.new)if(null!=e.record&&null!=e.record.School&&e.record.School.Id){if(null!=e.existingTeamNumbers&&0<e.existingTeamNumbers.length){var i=(e.record.TeamNumber||"").replace("'","");0<=e.existingTeamNumbers.indexOf(i)&&(t=0<i.length?"מספר קבוצה כבר בשימוש נא להזין מספר אחר":"קיימות קבוצות נוספות, יש להזין מספר קבוצה ייחודי")}}else t="יש לבחור בית ספר";return t},isValidTeamNumber:function(){return c(this,this.record.TeamNumber)},toggleRoles:function(){this.rolesInfoOpen=!this.rolesInfoOpen},toggleFacility:function(){this.facilityOpen=!this.facilityOpen},validateTeam:function(){this.isValid=null!==this.record.School&&null!==this.record.Championship&&(!this.record.isAthletics||this.record.isAthletics&&function(e,t){return null===e||null===t||""===e||""===t||e<t}(this.record.PlayerNumberFrom,this.record.PlayerNumberTo))},saveRecord:function(){var t=this;if(t.generalErrorMessage="",t.record.ChargeSeason=t.chargeSeason,t.state==t.states.duplicate)null==t.record.School&&null!=t.schoolId&&(t.record.School=t.schoolId.value),n.addTeam(t.record).then(function(e){t.record.Id=e.body.newTeamId,t.confirm()},function(e){t.generalErrorMessage=e.bodyText||e.body||"",window.setTimeout(function(){t.resetGeneralErrorMessage(),t.$forceUpdate()},1e4)});else if(t.state==t.states.edit)t.record.addingNewFacility=t.addingNewFacility,t.record.newFacility=t.newFacility,n.editTeam(t.record).then(function(e){t.confirm()},function(e){t.generalErrorMessage=e.bodyText||e.body||e||"",window.setTimeout(function(){t.resetGeneralErrorMessage(),t.$forceUpdate()},1e4)});else{var e={TeamNumber:t.record.TeamNumber,ChargeSeason:t.chargeSeason,School:t.record.School.Id,Category:{Id:t.category},AdminStatus:t.record.AdminStatus};n.addTeam(e).then(function(e){t.confirm()},function(e){t.generalErrorMessage=e.bodyText||e.body||"",window.setTimeout(function(){t.resetGeneralErrorMessage(),t.$forceUpdate()},1e4)})}},setRegistrationDate:function(e){this.changed=!0,this.record.RegistrationDate=e},setRoleApproval:function(){var t=1;this.roles.forEach(function(e){e.value&&(t|=e.id)}),this.record.Approved=t},setRoleOptions:function(){if(this.record.Approved){for(var e=this.record.Approved.toString(2);e.length<4;)e="0"+e;1==e[e.length-2]&&(this.roles[0].value=!0),1==e[e.length-3]&&(this.roles[1].value=!0),1==e[e.length-4]&&(this.roles[2].value=!0)}},cancel:function(){this.$emit("close")},confirm:function(){this.$emit("close",this.record)},isAthletics:function(){return 0<=[82,86,24].indexOf(this.record.Sport.Id)},handleRecordChange:function(){this.validateTeam(),this.changed=!0,this.record.Id&&this.setRoleOptions()},teamNumberChanged:function(){this.changed=!0,this.$forceUpdate()},teamStatusChanged:function(){this.changed=!0},setSchool:function(e){var o=this;o.existingTeamNumbers=[],o.record=Object.assign(o.record,{}),null!=o.record&&null!=o.record.School&&o.record.School.Id&&n.getTeamNumbers(o.category,o.record.School.Id).then(function(e){if(o.existingTeamNumbers=e,null!=o.existingTeamNumbers&&0<o.existingTeamNumbers.length)for(var t=["א","ב","ג","ד"],i=0;i<t.length;i++){var r=t[i];if(o.existingTeamNumbers.indexOf(r)<0){o.record.TeamNumber=r;break}}o.$forceUpdate()}),void 0!==e&&o.handleRecordChange()},regionChanged:function(){o(this)},facilityRegionChanged:function(r){void 0!==r&&null!=r||(r=new Function);var o=this,e=o.facilityRegion;null!=e?n.getFacilities({region:e}).then(function(e){var t=e.slice(0);o.regionFacilities=e.slice(0),a.sortByName(t),o.facilities=t;var i=a.distinctArray(t.map(function(e){return e.City||{}}).filter(function(e){return null!=e.Id&&0<e.Id}),"Id");a.sortByName(i),o.facilityCities=[{Id:-1,Name:"כל הרשויות"}],o.facilityCity=-1,i.forEach(function(e){o.facilityCities.push(e)}),null!=o.record.Facility&&(o.record.Facility.Id=null),r()}):r()},facilityCityChanged:function(i){void 0!==i&&null!=i||(i=new Function);var r=this,e=r.facilityCity;null!=r.record.Facility&&(r.record.Facility.Id=null),null!=e&&0<e?n.getFacilities({city:e}).then(function(e){var t=e.slice(0);a.sortByName(t),r.facilities=t,i()}):(r.facilities=r.regionFacilities,i())},resetFacility:function(){null!=this.record.Facility&&(this.record.Facility.Id=null)},addFacility:function(){this.addingNewFacility=!0},abortAddingFacility:function(){this.addingNewFacility=!1},resetGeneralErrorMessage:function(){this.generalErrorMessage=""}},watch:{record:{handler:function(){this.handleRecordChange()},deep:!0}}})});