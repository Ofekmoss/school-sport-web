define(["templates/registration","utils","dialog","consts"],function(e,l,n,t){var s={notLoaded:1,new:2,edit:3,import:4,loading:5},d=["א'","ב'","ג'","ד'","ה'","ו'","ז'","ח'","ט'","י'",'י"א','י"ב'];return Vue.extend({template:e["player-dialog"],data:function(){return{maxTeamPlayers:t.MaxTeamPlayers,idNumber:"",firstName:"",lastName:"",birthDate:"",birthDateText:"",grade:"",picture:"",idSlip:"",gender:null,medicalApproval:"",pictureLoaded:!1,idSlipLoaded:!1,medicalApprovalLoaded:!1,isIdValid:!1,state:s.notLoaded,states:s,external:!1,differentCity:!1,studentCityName:"",userCityName:"",needTransferRequest:!1,clubs:!1,team:"",status:null,existingTeamPlayers:[],availablePlayers:{selected:[],notSelected:[]},search:"",searchButtonState:{visible:!1,text:"",validId:!1,invalidId:!1},addingSinglePlayer:!1,playerAlreadyInTeam:!1,teamStatus:null,projectId:null,projectName:"",projectTeam:"",yearOfBirth:null,projectJoinDate:null,sportId:null,checkIfaService:!1,playerAlreadyInIFA:!1}},created:function(){this.files={picture:null,idSlip:null,medicalApproval:null}},mounted:function(){var i=this;if(null==i.projectId){var e="/api/v2/schools/possiblePlayers?";e+=this.clubs?"clubs=1":"league=1",Vue.http.get(e).then(function(e){var t=e.data,a=function(e){var t=e.split(" ").find(function(e){return 0<e.indexOf("-")||0<=d.indexOf(e)});if(t){t.indexOf("-")<0&&(t+="-"+t);var a=t.split("-");if(2===a.length){var i=d.indexOf(a[0]),r=d.indexOf(a[1]);if(0<=i&&i<=r)return{min:i,max:r}}}return null}(i.team);null!=a&&(t=t.filter(function(e){return e.grade>=a.min&&e.grade<=a.max})),i.availablePlayers.notSelected=t,i.availablePlayers.selected=[],i.state!=i.states.edit&&0===i.availablePlayers.notSelected.length&&(i.addingSinglePlayer=!0),null!=i.sportId&&Vue.http.get("/api/common/Sportsman").then(function(e){i.checkIfaService=0<=e.data.FootballSportFieldIds.indexOf(parseInt(i.sportId,10))})},function(e){console.log(e)})}else if(null==i.projectJoinDate){var t=new Date;i.projectJoinDate=l.formatDate(t,"YYYY-MM-DD")}if(null!=i.idNumber&&""!=i.idNumber&&(i.isIdValid=!0,i.state=s.edit),i.birthDate){var a=new Date(i.birthDate);i.birthDateText=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear()}null!=i.projectJoinDate&&"string"!=typeof i.projectJoinDate&&(i.projectJoinDate=l.formatDate(i.projectJoinDate,"yyyy-MM-DD"))},watch:{search:function(){this.searchTermChanged()}},methods:{searchTermChanged:function(){var t=this,e=t.availablePlayers.selected.concat(t.availablePlayers.notSelected),a=t.search.trim(),i=0;if(e.forEach(function(e){e.hidden=function(e,t,a){if(0===a.length)return!1;var i=a.split(" ").filter(function(e){return 0<e.length}),r=0,l=[t.idNumber.toString(),t.firstName||"",t.lastName||"",e.getGrade(t.grade),t.remarks||""];return i.forEach(function(e){for(var t=0;t<l.length;t++){var a=l[t];0<a.length&&0<=a.indexOf(e)&&r++}}),r!==i.length}(t,e,a),e.hidden||i++}),t.searchButtonState.visible=!1,t.searchButtonState.validId=!1,t.searchButtonState.invalidId=!1,1===i){var r=e.filter(function(e){return!e.hidden})[0];a==r.idNumber&&(t.searchButtonState.visible=!0,t.searchButtonState.text=r.selected?"הסרה מרשימת שחקנים":"הוספה אל רשימת שחקנים")}else 0===i&&8<=a.length&&!isNaN(parseInt(a,10))&&(l.isIdValid(a)?(t.searchButtonState.visible=!0,t.searchButtonState.validId=!0,t.searchButtonState.text="הוספת שחקן חדש"):t.searchButtonState.invalidId=!0)},validateYearOfBirth:function(){var e=this;if(e.state==e.states.notLoaded||e.state==e.states.loading)return!0;var t=e.yearOfBirth;if(null==t)return!1;var a=parseInt(t,10);if(isNaN(a))return!1;var i=new Date;return 1900<=a&&a<i.getFullYear()},searchButtonClicked:function(e){var t=this;if(t.searchButtonState.validId){var a=t.search.trim();t.addingSinglePlayer=!0,t.idNumber=a,window.setTimeout(function(){t.isIdValidCheck(),t.sendId()},200)}else{var i=t.availablePlayers.selected.concat(t.availablePlayers.notSelected).filter(function(e){return!e.hidden});if(1===i.length){var r=i[0];r.selected=!r.selected,t.search="",t.handleSelectionChange(r),t.searchTermChanged()}}},getGrade:function(e){return null!=e&&0<=e&&e<d.length?d[e]:""},handleSelectionChange:function(t){var e=this;t.selected?e.availablePlayers.selected.push(t):e.availablePlayers.notSelected.push(t),window.setTimeout(function(){t.selected?e.availablePlayers.notSelected=e.availablePlayers.notSelected.filter(function(e){return e.student!==t.student}):e.availablePlayers.selected=e.availablePlayers.selected.filter(function(e){return e.student!==t.student}),$("#pnlAvailablePlayers").scrollTop("0px"),e.searchTermChanged()},500)},transfer:function(){var e=this;e.grade<11&&e.external&&(e.availablePlayers.selected.push({external:e.external,differentCity:!0,student:e.student,idNumber:e.idNumber,grade:e.grade,selected:!0,remarks:"בקשת העברה"}),e.clearId(null))},confirm:function(){var e=this;if(!e.external||e.external&&!e.differentCity){var t={external:e.external,differentCity:e.differentCity,student:e.student,idNumber:e.idNumber,firstName:e.firstName,lastName:e.lastName,birthDate:e.birthDate,grade:e.grade,gender:e.gender,yearOfBirth:e.yearOfBirth,projectJoinDate:e.projectJoinDate,picture:e.files.picture,idSlip:e.files.idSlip,medicalApproval:e.files.medicalApproval};if(e.addingSinglePlayer){var a="";e.external?(a="בקשת העברה",e.differentCity||(a+=" (אותה רשות)")):a="חדש",t.remarks=a,t.selected=!0,e.availablePlayers.selected.push(t),e.clearId(null)}else this.$emit("close",t)}},cancel:function(){this.$emit("close")},sendSelectedPlayers:function(){0<this.availablePlayers.selected.length&&this.$emit("close",{players:this.availablePlayers.selected})},keyUp:function(e){13===e.keyCode&&$("#btnSend").click()},isIdValidCheck:function(){this.isIdValid=l.isIdValid(this.idNumber)},convertBirthDate:function(){this.birthDate=l.parseDate(this.birthDateText)},searchKeyDown:function(e){if(9===e.which){var t=this.availablePlayers.selected.concat(this.availablePlayers.notSelected).filter(function(e){return!e.hidden});1===t.length&&(this.search=t[0].idNumber.toString(),window.setTimeout(function(){e.target.focus()},200))}else 13===e.which&&(e.preventDefault(),this.searchButtonClicked(e))},sendId:function(e){function t(a){a.state=s.loading;var e={id:a.idNumber,projectId:a.projectId};Vue.http.post("/api/v2/registration/playerId",e).then(function(e){a.state=s.new;var t=e.body;a.student=t.student,a.firstName=t.firstName,a.lastName=t.lastName,a.birthDate=l.parseDate(t.birthDate),a.birthDateText=a.birthDate?a.birthDate.getDate()+"/"+(a.birthDate.getMonth()+1)+"/"+a.birthDate.getFullYear():"",a.grade=t.grade,a.gender=t.gender,a.pictureLoaded=null!=t.picture,a.idSlipLoaded=null!=t.idSlip,a.medicalApprovalLoaded=null!=t.medicalApproval,a.needTransferRequest=!0,!a.projectId&&t.external&&(a.external=!0,a.differentCity=t.differentCity,a.studentCityName=t.studentCity,a.userCityName=t.userCity,!t.differentCity&&t.grade<10&&(a.needTransferRequest=!1))},function(e){a.state=s.new,n.open("general/error-message",{caption:"פעולה נכשלה",message:"string"==typeof e.body?e.body:"כשלון בעדכון נתונים"})})}e&&e.preventDefault();var a=this;if(a.isIdValid){if(a.playerAlreadyInIFA=!1,a.existingTeamPlayers&&0<a.existingTeamPlayers.length){var i=a.existingTeamPlayers.find(function(e){return e.idNumber==a.idNumber});if(null!=i)return a.playerAlreadyInTeam=!0,a.firstName=i.firstName,a.lastName=i.lastName,void(a.grade=i.grade)}if(a.checkIfaService){var r="/api/common/ifa-register-status?id="+a.idNumber;Vue.http.get(r).then(function(e){0<=e.body.indexOf("<PlayerRegStatus>1</PlayerRegStatus>")?a.playerAlreadyInIFA=!0:t(a)},function(e){t(a)})}else t(a)}},clearId:function(e){e&&e.preventDefault(),this.state=s.notLoaded,this.isIdValid=!1,this.idNumber="",this.firstName="",this.lastName="",this.birthDate="",this.grade="",this.pictureLoaded=!1,this.idSlipLoaded=!1,this.medicalApprovalLoaded=!1,this.files.picture=null,this.files.idSlip=null,this.files.medicalApproval=null,this.external=!1,this.addingSinglePlayer=!1,this.search="",this.searchButtonState.visible=!1,this.searchButtonState.validId=!1,this.searchButtonState.invalidId=!1,this.playerAlreadyInTeam=!1,this.playerAlreadyInIFA=!1,this.searchTermChanged()},uploadPicture:function(){this.state==this.states.notLoaded||this.state==this.states.loading||this.external||$("#fiPicture").click()},uploadIdSlip:function(){this.state==this.states.notLoaded||this.state==this.states.loading||this.external||$("#fiIdSlip").click()},uploadMedicalApproval:function(){this.state==this.states.notLoaded||this.state==this.states.loading||this.external||$("#fiMedicalApproval").click()},handlePicture:function(){this.files.picture=$("#fiPicture")[0].files[0],this.pictureLoaded=!!this.files.picture},handleIdSlip:function(){this.files.idSlip=$("#fiIdSlip")[0].files[0],this.idSlipLoaded=!!this.files.idSlip},handleMedicalApproval:function(){this.files.medicalApproval=$("#fiMedicalApproval")[0].files[0],this.medicalApprovalLoaded=!!this.files.medicalApproval},isFormValid:function(){var e=this;if(2==e.status)return!0;if(null==e.firstName||0===e.firstName.length)return!1;if(null==e.lastName||0===e.lastName.length)return!1;if(null==e.projectId){if(null==e.birthDate||0===e.birthDate.length)return!1;if(null==e.grade||0==e.grade)return!1}else if(!e.validateYearOfBirth())return!1;return!0}}})});