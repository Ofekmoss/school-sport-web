define(["templates/registration","dialog","utils","consts"],function(t,e,m,l){function i(t,e){for(var i=0;i<t.length;i++){var a=t[i];if(a.id===e)return a}return null}function d(e,i,t){for(var a=["א","ב","ג","ד","ה","ו","ז","ח","ט","י",'י"א','י"ב','י"ג','י"ד','ט"ו','ט"ז','י"ז'],n=t.filter(function(t){return t.sport.id==e&&t.category.id==i}),r=n.length,s=a[r];n.find(function(t){return t.teamNumber==s});)s=a[++r];return s}function a(t){for(var e=!0,i=0;i<t.length;i++){var a=t[i];if(a&&a.day){var n=0;if(a.startTime&&a.endTime&&(n=a.endTime-a.startTime),n<180){e=!1;break}}}return e}return Vue.extend({template:t["club-team-dialog"],el:"#validated-form",data:function(){return{team:null,newTeam:!1,originalTeamJSON:"",teamDataChanged:!1,facilities:[],sports:[],championships:[],newFacilityName:"",newFacilityAddress:"",editingFacility:!1,sportIndex:null,categoryIndex:null,championshipIndex:null,teams:[],startHours:m.getStartHours(),activityEndHours:m.getEndHours(),hostingEndHours:m.getEndHours(),duplicate:!1,teamNumberExists:!1,coachCertifications:[]}},watch:{sportIndex:function(){this.team.sport=null==this.sportIndex?null:this.sports[this.sportIndex];var t=null;if(this.team.sport&&this.team.category)for(var e=0;e<this.team.sport.categories.length;e++){if(this.team.sport.categories[e].category===this.team.category.category){t=e;break}}this.categoryIndex=t},categoryIndex:function(){this.team.category=null==this.team.sport||null==this.categoryIndex?null:this.team.sport.categories[this.categoryIndex],(this.duplicate||this.newTeam)&&(this.team.teamNumber=null==this.team.sport||null==this.categoryIndex?null:d(this.team.sport.id,this.team.category.id,this.teams))},"team.facility":function(){this.editingFacility=!1,this.newFacilityName="",this.newFacilityAddress=""},team:{deep:!0,handler:function(){var t=this;if(0<t.originalTeamJSON.length){var e=JSON.stringify(t.team);t.teamDataChanged=e!==t.originalTeamJSON}}}},mounted:function(){var e=this,t=l.coachCertifications;if(e.coachCertifications=m.flattenComplexObject(t,!1,function(t,e){return{Id:t,Name:e}}),e.coachCertifications.sort(function(t,e){return t.Id-e.Id}),null==e.team?(e.newTeam=!0,e.team={coach:{},activity:[{}],hostingHours:[{}]}):(null!=e.team.activity&&e.team.activity.length||(e.team.activity=[{}]),null!=e.team.hostingHours&&e.team.hostingHours.length||(e.team.hostingHours=[{}])),!e.newTeam)for(var i=0;i<e.sports.length;i++){var a=e.sports[i];if(a.id===e.team.sport.id){e.sportIndex=i,e.team.sport=a;for(var n=0;n<a.categories.length;n++){var r=a.categories[n];if(r.id===e.team.category.id){e.team.category=r,e.categoryIndex=n;break}}break}}if(m.activityMethods.computeEndTime(e.team.activity),m.activityMethods.computeEndTime(e.team.hostingHours),e.duplicate&&(e.team.teamNumber=d(e.team.sport.id,e.team.category.id,e.teams)),e.team.sport&&e.team.sport.championships&&e.team.category){var s=e.team.category.championship,o=e.team.category.id,c=e.team.sport.championships.findIndex(function(t){return t.id===s});0<=c&&(e.championshipIndex=c,window.setTimeout(function(){0<=(c=e.team.sport.categories.findIndex(function(t){return t.id===o}))&&(e.categoryIndex=c)},200))}e.activityMethods=m.activityMethods,e.team.coach.certificationTypes||(e.team.coach.certificationTypes=[]),window.setTimeout(function(){var t=e.team.coach.name;e.team.coach.name="---",e.team.coach.name=t,e.originalTeamJSON=JSON.stringify(e.team)},500)},methods:{cancel:function(){this.$emit("close")},isHostingDayValid:function(t){return a(t)},editFacility:function(t){if(t){var e=i(this.facilities,this.team.facility);e&&(this.newFacilityName=e.name,this.newFacilityAddress=e.address)}this.editingFacility=t},confirm:function(){var a=this;if(a.teamNumberExists=!1,a.teams){var n=a.team.category.id,r=a.team.teamNumber.replace('"',"").replace("'","");if(0<a.teams.filter(function(t){var e=t.category.id===n,i=t.teamNumber?t.teamNumber.replace('"',"").replace("'",""):"";return t.id!==a.team.id&&e&&i===r}).length)return void(a.teamNumberExists=!0)}a.editingFacility||null==a.team.facility?0<a.newFacilityName.trim().length&&0<a.newFacilityAddress.trim().length?(a.editingFacility?Vue.http.put("/api/v2/facilities/-/"+encodeURIComponent(a.team.facility),{name:a.newFacilityName,address:a.newFacilityAddress}):Vue.http.post("/api/v2/facilities/-",{name:a.newFacilityName,address:a.newFacilityAddress})).then(function(t){if(a.editingFacility){(e=i(a.facilities,a.team.facility)).name=a.newFacilityName,e.address=a.newFacilityAddress}else{var e={id:t.body.id,name:a.newFacilityName,address:a.newFacilityAddress};a.facilities.push(e),a.team.facility=e.id}a.newFacilityName="",a.newFacilityAddress="",a.$emit("close",a.team)},function(t){e.open("general/error-message",{caption:"פעולה נכשלה",message:"string"==typeof t.body?t.body:"שגיאה בהגדרת מתקן"})}):a.team.sport.isGroup||this.$emit("close",this.team):this.$emit("close",this.team)},validateForm:function(){return!!(0==document.querySelectorAll("#validated-form :invalid").length&&this.team.sport&&this.team.category&&this.team.coach.phoneNumber&&this.team.coach.email&&function(t){for(var e=!0,i=0;i<t.length;i++)if(!(t[i]&&t[i].day&&t[i].startTime&&t[i].endTime)){e=!1;break}return e}(this.team.activity)&&a(this.team.hostingHours))}}})});