define(["templates/registration","services/access","services/products","dialog","consts","utils"],function(t,e,n,l,o,i){var r={};function d(t,e){return 81==e?1054:86==e?1053:t?101:100}function a(i,r){!function(r,s){Vue.http.get("/api/v2/registration/club/competitions").then(function(t){for(var e=0;e<t.body.sports.length;e++){for(var n=t.body.sports[e],a={},o=0;o<n.categories.length;o++){var i=n.categories[o];a[i.id]=i}n.categories=a,r.sports[n.id]=n}s()},function(t){s(t)})}(i,function(t){t||Vue.http.get("/api/v2/registration/club/teams").then(function(t){for(var e=[],n={},a=0;a<t.body.length;a++){var o=t.body[a];o.sport=i.sports[o.sport],o.sport&&(o.competition=o.sport.categories[o.competition],o.competition&&(o.sport.name.indexOf("כדורסל"),null!=o.payment?(o.sport.isOnePaymentPerCategory&&(n[o.competition.category]=!0),i.paidTeams.push(o)):(o.paymentIndex=0,e.push(o)),o.sport.isOnePaymentPerCategory&&(o.sport.name.indexOf("כדורסל"),n[o.competition.category]?o.removePayment=!0:n[o.competition.category]=!0)))}i.teams=e,r()},function(t){r(t)})})}function m(t,e){for(var n=0;n<t.details.items.length;n++){var a=t.details.items[n];if(a.teams)for(var o=0;o<a.teams.length;o++)if(a.teams[o]===e.id)return void(e.price=a.price)}}return Vue.extend({template:t["club-payment"],data:function(){return{user:e.user,payments:[],sports:{},email:null,coordinator:null,teams:[],paidTeams:[],orders:[],paying:!1,inactiveSeason:!1}},mounted:function(){var a=this;Vue.http.get("/api/v2/login").then(function(t){a.coordinator=o.coordinators[t.body.region]},function(t){console.log(t)}),n.get(function(t,e){if(t)console.log(t);else{for(var n in e)r[n]=e[n].price;a.reload()}}),a.inactiveSeason=i.inactiveSeason(a),a.inactiveSeason&&i.checkSeasonAuthorization(a.user,function(t,e){1==e&&(a.inactiveSeason=!1)})},computed:{canPay:function(){for(var t=0;t<this.teams.length;t++){var e=this.teams[t];if(null==e.paymentIndex||e.paymentIndex>=this.payments.length)return!1}for(t=0;t<this.payments.length;t++){var n=this.payments[t];if(null==n.method||null==n.payerName||0===n.payerName.length)return!1;for(var a=0;a<n.contacts.length;a++){var o=n.contacts[a];if(null==o.name||0===o.name.length)return!1}}return!0}},methods:{reload:function(){this.teams.splice(0,this.teams.length),this.payments.splice(0,this.payments.length),this.orders.splice(0,this.orders.length),this.paidTeams.splice(0,this.paidTeams.length);var n=this;a(n,function(t){t?console.log(t):(function(c){Vue.http.get("/api/v2/registration/club/payments").then(function(t){for(var e=0;e<t.body.length;e++){var n=t.body[e];n.teams=[],n.time=new Date(n.time),n.contacts=n.details.contacts;for(var a=0;a<c.paidTeams.length;a++){var o=c.paidTeams[a];o.payment===n.id&&(m(n,o),n.teams.push(o))}for(n.showChampionshipColumn=!1,a=0;a<n.teams.length;a++)if(0<=n.teams[a].sport.name.indexOf("ספיישל")){n.showChampionshipColumn=!0;break}for(var i=null,r=0;r<c.orders.length;r++){var s=c.orders[r];if(s.id===n.order){i=s;break}}i||(i={id:n.order,time:n.time,payments:[]},c.orders.push(i)),i.payments.push(n)}c.orders.sort(function(t,e){return e.id-t.id})},function(t){console.log(t)})}(n),Vue.http.get("/api/v2/registration/club/details").then(function(t){n.email=t.body.coordinator.email,n.name=t.body.coordinator.name,n.representative=t.body.representative;var e={payerName:t.body.school.name,contacts:[t.body.principal||{}]};e.contacts[0].role="מנהל",n.payments.push(e),n.paying=!1},function(t){console.log(t)}))})},getPaymentTotal:function(t){for(var e=0,n=0;n<this.teams.length;n++){var a=this.teams[n];a.paymentIndex!==t||a.removePayment||(e+=a.price)}return e},hasPaymentToPay:function(){return!0},addPayment:function(){this.payments.push({contacts:[{}]})},removePayment:function(t,e){this.payments.splice(e,1);for(var n=0;n<this.teams.length;n++){var a=this.teams[n];a.paymentIndex==e&&(a.paymentIndex=0)}},addContact:function(t){t.contacts.push({new:!0})},saveContactAndSendPayment:function(t,e){0<document.querySelectorAll("#add-contacts-form :invalid").length||(t.contacts[e].new=!1)},removeContact:function(t,e){t.contacts.splice(e,1)},isFormValid:function(){var t=this.payments,e=!0;for(var n in t){var a=t[n];for(var o in a.contacts){var i=a.contacts[o];if(!(i.role&&i.name&&i.phoneNumber&&i.email)){e=!1;break}}}return e},cancelOrder:function(n){var a=this;l.open("general/message-box",{cancelText:"בטל",message:"האם לבטל את דרישת התשלום?",caption:"ביטול דרישת תשלום"},function(t,e){e&&Vue.http.post("/api/v2/registration/club/payments/"+n.id+"/cancel").then(function(t){var e=a.orders.indexOf(n);0<=e&&a.orders.splice(e,1)})})},downloadPayment:function(t){i.downloadPayment(t.id)},next:function(){this.$emit("next",3)},commit:function(){for(var e=[],t=0;t<this.payments.length;t++){for(var n=[],a={},o=[],i=0;i<this.teams.length;i++){var r=this.teams[i];if(r.paymentIndex===t){var s=r.removePayment?0:r.price,c=a[s];c||(a[s]=c={product:d(r.hasTotoSupport,r.sport.id),price:s,quantity:0,teams:[]},o.push(c)),n.push(r.id),c.teams.push(r.id),c.quantity++}}var m=this.payments[t];m.teams=n;var p={payerName:m.payerName,method:m.method,totalAmount:o.reduce(function(t,e){return t+=e.price*e.quantity},0),details:{contacts:m.contacts,items:o}};e.push(p)}var u=this;u.paying=!0,Vue.http.post("/api/v2/registration/club/payment",e).then(function(t){u.reload(),l.open("general/message-box",{wide:!0,caption:"הרשמה נקלטה",message:"1. הרשמתך למועדוני ספורט בית ספריים נקלטה במערכת<br/>2. דרישת תשלום נשלחה למייל "+e.map(function(t){return t.details.contacts.map(function(t){return t.email}).join(", ")}).join(", ")+"<br/>3. מייל נשלח אל "+e.map(function(t){return t.details.contacts.map(function(t){return t.name}).join(", ")}).join(", ")+" – מנהל/ת בית הספר (בדקו גם בתיבת הספאם/דואר זבל) יש לוודא את אישורו/ה עבור הקבוצות בלינק המצורף בגוף המייל.<br />4. מייל נשלח אל "+u.representative.name+' – נציג/ה ברשות המקומית (בדקו גם בתיבת הספאם/דואר זבל) יש לוודא את אישורו/ה עבור הקבוצות בלינק המצורף בגוף המייל.<br />5. יש לוודא את אישור הקבוצות ע"י הפיקוח על החינוך הגופני מחוזכם.<br />6. אישור סופי של הקבוצות ישלח למייל '+u.email+"<br/>7. מספר אישור הרשמה "+t.body.order+"<br/>8. לשאלות בנוגע להרשמה ניתן לפנות לרכז/ת "+(u.coordinator?"מחוז "+u.coordinator.areaName+"<br/>&nbsp;&nbsp; במייל "+u.coordinator.mail+" <br/>&nbsp;&nbsp; בנייד "+u.coordinator.phone:"המחוז")},function(){0===u.teams.length&&u.$emit("next",3)})},function(t){u.paying=!1,l.open("general/error-message",{caption:"פעולה נכשלה",message:"string"==typeof t.body?t.body:"שגיאה בביצוע התשלום"})})}}})});