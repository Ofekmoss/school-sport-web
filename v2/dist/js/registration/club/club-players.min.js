define(["templates/registration","services/access","dialog","components/selectex","consts","utils"],function(e,t,s,n,a,o){function l(e){switch(e){case 1:return"רשום";case 2:return"מאושר";case 3:return"לא מאושר"}return""}function d(n){Vue.http.get("/api/v2/registration/club/teams/"+encodeURIComponent(n.id)+"/transfers").then(function(e){var t=e.body.map(function(e){return e.transfer=!0,e});0<(t=t.filter(function(t){return null==n.players.find(function(e){return e.idNumber==t.idNumber})})).length&&(n.players=n.players.concat(t))}).catch(function(e){console.log(e)})}function m(e,t){for(var n=0;n<e.length;n++){var a=e[n];if(a.id===t)return a}return null}function p(u,i){function c(e){return null!=e?{start:o.parseDate(e.rangeStart),end:o.parseDate(e.rangeEnd)}:null}void 0!==i&&null!=i||(i=new Function),function(a,r){Vue.http.get("/api/v2/registration/club/competitions").then(function(e){for(var t=[],n=0;n<e.body.sports.length;n++)t.push(e.body.sports[n]);a.sports=t,r()},function(e){r(e)})}(u,function(e){e?i():Vue.http.get("/api/v2/registration/club/teams").then(function(e){var t;t={},u.teams.forEach(function(e){t[e.id]=e.__panelOpen});var n=u.team?u.team.id:null;u.teams.splice(0,u.teams.length);for(var a=0;a<e.body.length;a++){var r=e.body[a];r.sport=m(u.sports,r.sport),r.sport&&(r.category=m(r.sport.categories,r.competition)),r.category&&(null!=r.payment&&u.paidTeams++,r.createdAt=new Date(r.createdAt),r.id===n&&(u.team=r),r.selectionCount=0,r.__panelOpen=t[r.id],u.teams.push(r)),r.players||(r.players=[]),r.maxStudentBirthday&&(r.maxStudentBirthday=new Date(r.maxStudentBirthday),r.players=r.players.map(function(e){return null!=e.birthDate&&new Date(e.birthDate)<r.maxStudentBirthday&&(e.aboveMaxAge=!0),e})),r.gotStudentWithoutGrade=0<r.players.filter(function(e){return 0===u.getGrade(e.grade).length}).length,d(r),r.sportsmanCount=0,r.players.forEach(function(e){e.parsedStatus=l(e.status),null!=e.birthDate&&new Date(e.birthDate).getFullYear()<1990&&(e.birthDate=null),e.sportsman&&r.sportsmanCount++}),r.gotStudentWithoutBirthday=0<r.players.filter(function(e){return null==e.birthDate}).length,i()}var p=u.user.season;o.readServerCache(["isf-overage","overage"],!0,function(e,t){if(e)console.log(e);else{var n=t["isf-overage"],a=t.overage,l=o.parseIsfOverageItems(n),s=o.parseIsfOverageItems(a);u.teams.forEach(function(e){if(e.players&&0<e.players.length){var t=e.sport.id,n=e.category.category,a=l.find(function(e){return e.season==p&&e.sport==t&&e.category==n}),r=s.find(function(e){return e.season==p&&(0==e.sport||e.sport==t)&&e.category==n});if(null!=a||null!=r){var i=c(a),o=c(r);e.players.forEach(function(e){if(null!=e.birthDate&&0<e.birthDate.toString().length){var t=new Date(e.birthDate);e.isfOverage=function(e,t){return null!=e&&t>=e.start&&t<=e.end}(i,t),e.aboveMaxAge=null!=o&&t<o.end}}),u.$forceUpdate()}}})}})},function(e){console.log(e),i()})})}function i(e){var t=new FormData;return t.append("student",JSON.stringify({student:e.student,idNumber:e.idNumber,firstName:e.firstName,lastName:e.lastName,birthDate:e.birthDate,grade:e.grade,gender:e.gender})),e.picture&&t.append("picture",e.picture),e.idSlip&&t.append("idSlip",e.idSlip),e.medicalApproval&&t.append("medicalApproval",e.medicalApproval),t}function r(t,e){var n=i(t);Vue.http.post("/api/v2/registration/club/teams/"+encodeURIComponent(e)+"/players",n).then(function(e){t.picture=e.data.picture,t.idSlip=e.data.idSlip,t.medicalApproval=e.data.medicalApproval})}function u(t,n){n.transfer?Vue.http.delete("/api/v2/registration/club/teams/"+encodeURIComponent(t.id)+"/transfers/"+encodeURIComponent(n.idNumber)).then(function(){for(var e=0;e<t.players.length;e++)if(t.players[e]===n){t.players.splice(e,1);break}},function(e){console.log(e)}):Vue.http.delete("/api/v2/registration/club/teams/"+encodeURIComponent(t.id)+"/players/"+encodeURIComponent(n.student)).then(function(){for(var e=0;e<t.players.length;e++)if(t.players[e]===n){t.players.splice(e,1);break}},function(e){console.log(e)})}return Vue.extend({template:e["club-players"],data:function(){return{user:t.user,sports:[],teams:[],team:null,selectionCount:0,maxTeamPlayers:a.MaxTeamPlayers,inactiveSeason:!1,loginTokenLinks:[]}},mounted:function(){var n=this;n.inactiveSeason=o.inactiveSeason(n),n.inactiveSeason&&o.checkSeasonAuthorization(n.user,function(e,t){1==t&&(n.inactiveSeason=!1)}),Vue.http.get("/api/v2/useChampionshipNameSportFields").then(function(e){var t=e.data||[];p(n,function(){n.teams.forEach(function(e){e.showChampionNameInsteadOfSport=0<=t.indexOf(e.sport.id)}),Vue.http.get("/api/v2/tokens").then(function(e){null!=e.body&&(n.loginTokenLinks=e.body)})})})},computed:{},methods:{loginTokenLinksClicked:function(){o.openLoginTokenDialog(this.loginTokenLinks,s)},getTeamName:function(e){var t="";return e.showChampionNameInsteadOfSport?t+=e.championship.name.replace("ליגת מועדונים",""):t+=e.sport.name,t+=" ",0<=e.sport.name.indexOf("ספיישל")&&(t+=e.championship.name.replace("ליגת מועדונים","")+" "),t+=e.category.name+" "+e.teamNumber},getGrade:function(e){var t=["א'","ב'","ג'","ד'","ה'","ו'","ז'","ח'","ט'","י'",'י"א','י"ב'];return null!=e&&0<=e&&e<t.length?t[e]:""},handleSelectionChange:function(e){for(var t=e.selectionCount=0;t<e.players.length;t++)e.players[t].selected&&e.selectionCount++},deletePlayers:function(n){var a=n.players.filter(function(e){return e.selected});if(a.length){a.filter(function(e){return 2==e.status});var e=[];0<a.length&&(e.push(1===a.length?"השחקן הבא יוסר מהקבוצה:":"השחקנים הבאים יוסרו מהקבוצה:"),e.push(a.map(function(e){return e.firstName+" "+e.lastName+" (ת.ז. "+e.idNumber+")"}).join("<br />"))),0<a.length&&e.push("האם להמשיך?");var t=e.join("<br />");s.open("general/message-box",{caption:"מחיקת שחקנים",message:t,alert:!0,confirmText:0<a.length?"כן":"חזרה למסך שחקנים",cancelText:0<a.length?"לא":null},function(e,t){!0===t&&0<a.length&&function(e,t){for(var n=0;n<t.length;n++)u(e,t[n])}(n,a)})}},newPlayer:function(l){var n=this;if(l.players.length>=a.MaxTeamPlayers)alert("קבוצה מכילה כמות שחקנים מקסימלית, לא ניתן להוסיף");else{var e={clubs:!0,team:n.getTeamName(l),existingTeamPlayers:l.players,sportId:l.sport.id};s.open("registration/player-dialog",e,function(e,t){null!=t&&t.players&&0<t.players.length&&!function n(a,r,i){if(i>=r.length)p(a);else{var e,t=r[i];t.external?e={external:!0,idNumber:t.idNumber}:((e=new FormData).append("student",JSON.stringify({student:t.student,idNumber:t.idNumber,firstName:t.firstName,lastName:t.lastName,birthDate:t.birthDate,grade:t.grade,gender:t.gender})),t.picture&&e.append("picture",t.picture),t.idSlip&&e.append("idSlip",t.idSlip),t.medicalApproval&&e.append("medicalApproval",t.medicalApproval));var o="/api/v2/registration/club/teams/"+encodeURIComponent(l.id)+"/players";Vue.http.post(o,e).then(function(e,t){n(a,r,i+1)},function(e){s.open("general/error-message",{caption:"פעולה נכשלה",message:"string"==typeof e.body?e.body:"שגיאה בעת הוספת שחקנים"})})}}(n,t.players,0)})}},uploadPicture:function(e,t){document.getElementById("t-"+(e.team||e.id)+"-picture-input"+t).click()},uploadIdSlip:function(e,t){document.getElementById("t-"+(e.team||e.id)+"-id-slip-input"+t).click()},uploadMedicalApproval:function(e,t){document.getElementById("t-"+(e.team||e.id)+"-medical-approval-input"+t).click()},handlePicture:function(e,t){var n=e.players[t],a=document.getElementById("t-"+(e.team||e.id)+"-picture-input"+t).files[0];0===a.type.toLowerCase().indexOf("image/")?(n.picture=a,r(n,e.id)):alert("ניתן להעלות קובץ תמונה בלבד, נא לא להעלות PDF או סוגי קבצים אחרים")},handleIdSlip:function(e,t){var n=e.players[t],a=document.getElementById("t-"+(e.team||e.id)+"-id-slip-input"+t);n.idSlip=a.files[0],r(n,e.id)},handleMedicalApproval:function(e,t){var n=e.players[t],a=document.getElementById("t-"+(e.team||e.id)+"-medical-approval-input"+t);n.medicalApproval=a.files[0],r(n,e.id)},editPlayer:function(a){var r=this,e=a.players.find(function(e){return 1==e.selected}),t=Object.assign({},e);t.state=3,t.clubs=!0,s.open("registration/player-dialog",t,function(e,t){var n;null!=t&&(n=t.external?{external:!0,idNumber:t.idNumber}:i(t),Vue.http.post("/api/v2/registration/club/teams/"+encodeURIComponent(a.id)+"/players",n).then(function(e,t){p(r)},function(e){s.open("general/error-message",{caption:"פעולה נכשלה",message:"string"==typeof e.body?e.body:"שגיאה בעדכון שחקן"})}))})},openPrint:function(e){var t=window.open("/api/v2/registration/club/teams/"+e.team+"/players/download/team-"+e.team+"-players.pdf");t.onload=function(){t.print()}},togglePanel:function(e){e.__panelOpen=!e.__panelOpen,this.teams=this.teams.slice()},validPlayersCount:function(e){var t=this,n=0;return null!=e.players&&(n=e.players.filter(function(e){return 2==e.status&&null!=e.birthDate&&0<t.getGrade(e.grade).length}).length),n}}})});