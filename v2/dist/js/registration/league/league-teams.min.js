define(["templates/registration","services/access","services/products","dialog","utils"],function(e,t,n,o,i){function a(e){var t=e%60;return("0"+(e-t)/60).slice(-2)+":"+("0"+t).slice(-2)}function s(e,t){for(var i=0;i<e.length;i++){var a=e[i];if(a.id===t)return a}return null}function c(n,t,i){void 0!==i&&null!=i||(i=new Function),function(i,a){i.sports.splice(0,i.sports.length),Vue.http.get("/api/v2/registration/league/competitions").then(function(e){for(var t=0;t<e.body.sports.length;t++)i.sports.push(e.body.sports[t]);a()},function(e){a(e)})}(n,function(e){e?i(e):Vue.http.get("/api/v2/registration/league/teams/"+encodeURIComponent(t)).then(function(e){var t=e.body;if(t.sport=s(n.sports,t.sport),t.sport&&(t.category=s(t.sport.categories,t.competition),t.category&&(n.team=t,n.originalTeamJSON=JSON.stringify(n.team))),0==t.activity.length&&t.activity.push({}),null==t.id)t.active=!0;else{var a="league-team-"+t.id;Vue.http.get("/api/v2/registration/school-confirmations").then(function(e){for(var t=0;t<e.body.length;t++){var i=e.body[t];if(i.Form===a){n.confirmationA=!0,n.confirmationB=!0,n.confirmationC=!0,n.confirmationD=!0,n.inactiveConfirmation=!0,n.confirmedAt=i.DateConfirmed;break}}},function(e){console.log(e)})}console.log(t),i(null,t)},function(e){console.log(e),i(e)})})}function r(i){var e=i.team,a={id:e.id,team:e.team,sport:e.sport,category:e.category,payment:e.payment,teamNumber:e.teamNumber,active:e.active,coach:{name:e.coach.name,phoneNumber:e.coach.phoneNumber,email:e.coach.email,certification:e.coach.certification},coachHelper:{name:e.coachHelper.name,phoneNumber:e.coachHelper.phoneNumber,email:e.coachHelper.email},manager:{name:e.manager.name,phoneNumber:e.manager.phoneNumber,email:e.manager.email},teacher:{name:e.teacher.name,phoneNumber:e.teacher.phoneNumber,email:e.teacher.email},facilityAlternative:{name:e.facilityAlternative.name,address:e.facilityAlternative.address},facility:e.facility,activity:e.activity.map(function(e){return{day:e.day,startTime:e.startTime,endTime:e.endTime}})};i.confirmedAt&&(a.confirmedAt=i.confirmedAt),(null==a.id?Vue.http.post("/api/v2/registration/league/teams",a):Vue.http.put("/api/v2/registration/league/teams/"+encodeURIComponent(a.id),a)).then(function(e){if(a.active?(i.$emit("disableNext",900),i.$emit("next",e.data.stage)):(i.inactiveConfirmation=!1,o.open("general/message-box",{caption:"הודעה",message:"קבוצה אינה פעילה"}),i.$emit("disableNext",e.data.stage)),a.id&&!i.confirmedAt){var t={Form:"league-team-"+a.id};Vue.http.post("/api/v2/registration/confirmation",t).then(function(e){i.confirmedAt=new Date},function(e){console.log(e)})}},function(e){o.open("general/error-message",{caption:"פעולה נכשלה",message:"string"==typeof e.body?e.body:"שגיאה בעריכת קבוצה"})})}return Vue.extend({template:e["league-teams"],data:function(){return{user:t.user,team:{sport:{},category:{},coach:{},teacher:{},manager:{},coachHelper:{},activity:[],facilityAlternative:{}},originalTeamJSON:"",teamDataChanged:!1,facilities:[],sports:[],newFacilityName:"",newFacilityAddress:"",editingFacility:!1,teamPrice:null,selectAll:!1,selectionCount:0,inactiveConfirmation:!1,confirmationA:!1,confirmationB:!1,confirmationC:!1,confirmationD:!1,startHours:[],days:["א'","ב'","ג'","ד'","ה'","ו'"],confirmedAt:null,seasonName:"",inactiveSeason:!1}},mounted:function(){var a=this;Vue.http.get("/api/common/season-data").then(function(e){a.seasonName=e.body.name;var i=window.location.hash.split("=")[1];n.getById(200,function(e,t){a.teamPrice=t.price,c(a,i,function(){!function(i){Vue.http.get("/api/v2/facilities?city="+i.team.school.cityId).then(function(e){i.facilities||(i.facilities=[]);for(var t=0;t<e.body.length;t++)i.facilities.push(e.body[t])},function(e){console.log(e)})}(a)})}),function(e){for(var t=13;t<=17;t++)e.startHours.push({value:60*t,text:("0"+t).slice(-2)+":00"}),17!=t&&(e.startHours.push({value:60*t+15,text:("0"+t).slice(-2)+":15"}),e.startHours.push({value:60*t+30,text:("0"+t).slice(-2)+":30"}),e.startHours.push({value:60*t+45,text:("0"+t).slice(-2)+":45"}))}(a)}),a.inactiveSeason=i.inactiveSeason(a),a.inactiveSeason&&i.checkSeasonAuthorization(a.user,function(e,t){1==t&&(a.inactiveSeason=!1)})},watch:{"team.facility":function(){this.editingFacility=!1,this.newFacilityName="",this.newFacilityAddress=""},team:{deep:!0,handler:function(){if(0<this.originalTeamJSON.length){var e=JSON.stringify(this.team);this.teamDataChanged=e!==this.originalTeamJSON}}}},methods:{handleSelectionChange:function(){for(var e=this.selectionCount=0;e<this.teams.length;e++)this.teams[e].selected&&this.selectionCount++;this.selectAll=this.selectionCount==this.teams.length},handleSelectAll:function(){if(this.selectAll){for(var e=0;e<this.teams.length;e++)this.teams[e].selected=!0;this.selectionCount=this.teams.length}else{for(e=0;e<this.teams.length;e++)this.teams[e].selected=!1;this.selectionCount=0}},getActivityText:function(e){return e.map(function(e){return null!=e.day?days[e.day]+(null!=e.startTime?" "+a(e.startTime):"")+(null!=e.endTime?"-"+a(e.endTime):""):""}).join("; ")},onTeamActiveChange:function(){null==this.team.id&&this.team.active&&this.editTeam()},editFacility:function(e){if(e){var t=s(this.facilities,this.team.facility);t&&(this.newFacilityName=t.name,this.newFacilityAddress=t.address)}this.editingFacility=e},saveAndNext:function(){var i=this;i.editingFacility||null==i.team.facility?0<i.newFacilityName.trim().length&&0<i.newFacilityAddress.trim().length&&(i.editingFacility?Vue.http.put("/api/v2/facilities/-/"+encodeURIComponent(i.team.facility),{name:i.newFacilityName,address:i.newFacilityAddress}):Vue.http.post("/api/v2/facilities/-",{name:i.newFacilityName,address:i.newFacilityAddress})).then(function(e){if(i.editingFacility){(t=s(i.facilities,i.team.facility)).name=i.newFacilityName,t.address=i.newFacilityAddress}else{var t={id:e.body.id,name:i.newFacilityName,address:i.newFacilityAddress};i.facilities.push(t),i.team.facility=t.id}i.newFacilityName="",i.newFacilityAddress="",r(i)},function(e){o.open("general/error-message",{caption:"פעולה נכשלה",message:"string"==typeof e.body?e.body:"שגיאה בהגדרת מתקן"})}):r(this)},getFacilityName:function(e){for(var t=0;t<this.facilities.length;t++){var i=this.facilities[t];if(i.id===e)return i.name}return null},getTotalPayment:function(){},stopTheEvent:function(e){e.stopPropagation()},isValid:function(){if(!this.team.active)return this.inactiveConfirmation;var e=document.querySelectorAll("#form :invalid");return this.confirmationA&&this.confirmationB&&this.confirmationC&&(!this.hasBasketballTeam()||this.confirmationD)&&0===e.length},hasBasketballTeam:function(){return 15==this.team.sport.id}}})});