define(["templates/registration","services/access","services/products","dialog","utils"],function(t,e,a,i,o){function n(n,e,a){!function(r,s){Vue.http.get("/api/v2/registration/league/competitions").then(function(t){for(var e=0;e<t.body.sports.length;e++){for(var n=t.body.sports[e],a={},o=0;o<n.categories.length;o++){var i=n.categories[o];a[i.id]=i}n.categories=a,r.sports[n.id]=n}s()},function(t){s(t)})}(n,function(t){t||Vue.http.get("/api/v2/registration/league/teams/"+encodeURIComponent(e)).then(function(t){var e=t.body;e.sport=n.sports[e.sport],e.sport&&(e.competition=e.sport.categories[e.competition],e.competition&&(n.team=e)),a()},function(t){a(t)})})}return Vue.extend({template:t["league-payment"],data:function(){return{user:e.user,payment:null,sports:{},teamId:null,teamPrice:null,team:null,paying:!1,inactiveSeason:!1}},mounted:function(){var n=this;n.teamId=window.location.hash.split("=")[1],a.getById(200,function(t,e){n.teamPrice=e.price,n.reload()}),n.inactiveSeason=o.inactiveSeason(n),n.inactiveSeason&&o.checkSeasonAuthorization(n.user,function(t,e){1==e&&(n.inactiveSeason=!1)})},computed:{canPay:function(){if(null==this.payment||null!=this.payment.order||null==this.payment.method||null==this.payment.payerName||0===this.payment.payerName.length)return!1;for(var t=0;t<this.payment.contacts.length;t++){var e=this.payment.contacts[t];if(null==e.name||0===e.name.length)return!1}return!0}},methods:{reload:function(){var e=this;n(e,e.teamId,function(t){t?console.log(t):(function(a){a.team&&Vue.http.get("/api/v2/registration/league/payments").then(function(t){for(var e=0;e<t.body.length;e++){var n=t.body[e];if(n.time=new Date(n.time),n.id===a.team.payment){a.payment=n,a.payment.contacts=n.details.contacts;break}}},function(t){console.log(t)})}(e),null==e.team.payment&&Vue.http.get("/api/v2/registration/league/details").then(function(t){e.representative=t.body.representative,e.payment={payerName:t.body.school.name,contacts:[t.body.principal||{}]},e.payment.contacts[0].role="מנהל",e.paying=!1},function(t){console.log(t)}))})},addContact:function(t){console.log("adding"),t.contacts.push({new:!0})},saveContactAndSendPayment:function(t,e){0<document.querySelectorAll("#add-contacts-form :invalid").length||(t.contacts[e].new=!1)},removeContact:function(t,e){t.contacts.splice(e,1)},next:function(){this.$emit("next",3)},commit:function(){if(this.team&&null==this.team.payment&&this.team.active&&null==this.payment.order){var a=[{payerName:this.payment.payerName,method:this.payment.method,totalAmount:this.teamPrice,details:{contacts:this.payment.contacts,items:[{product:200,price:this.teamPrice,quantity:1,teams:[this.team.id]}]}}],o=this;o.paying=!0,Vue.http.post("/api/v2/registration/league/payment",a).then(function(t){var e=a.map(function(t){return t.details.contacts.map(function(t){return t.email}).join(", ")}).join(", "),n=a.map(function(t){return t.details.contacts.map(function(t){return t.name}).join(", ")}).join(", ");i.open("general/message-box",{wide:!0,caption:"הרשמה נקלטה",message:"1. הרשמתך לליגת התיכוניים נקלטה במערכת<br/>2. דרישת תשלום נשלחה למייל "+e+"<br/>3. מייל נשלח אל "+n+" – מנהל/ת בית הספר (בדקו גם בתיבת הספאם/דואר זבל) יש לוודא את אישורו/ה עבור הקבוצות בלינק המצורף בגוף המייל.<br />4. מייל נשלח אל "+o.representative.name+' – נציג/ה ברשות המקומית (בדקו גם בתיבת הספאם/דואר זבל) יש לוודא את אישורו/ה עבור הקבוצות בלינק המצורף בגוף המייל.<br />5. יש לוודא את אישור הקבוצות ע"י הפיקוח על החינוך הגופני מחוזכם<br />6. אישור סופי של הקבוצות ישלח למייל '+o.team.teacher.email+"<br/>7. מספר אישור הרשמה "+t.body.order+"<br/>8. לשאלות בנוגע להרשמה ניתן לפנות לרכזת אליפות התיכוניים <br/>&nbsp;&nbsp; במייל orit@schoolsport.org.il <br/>&nbsp;&nbsp; בנייד 054-4590173"},function(){o.next()})},function(t){o.paying=!1,i.open("general/error-message",{caption:"פעולה נכשלה",message:"string"==typeof t.body?t.body:"שגיאה בביצוע התשלום"})})}},cancelPayment:function(){var n=this;i.open("general/message-box",{cancelText:"בטל",message:"האם לבטל את דרישת התשלום?",caption:"ביטול דרישת תשלום"},function(t,e){e&&Vue.http.post("/api/v2/registration/league/payments/"+n.payment.order+"/cancel").then(function(t){n.reload()})})},downloadPayment:function(){o.downloadPayment(this.payment.order)}}})});