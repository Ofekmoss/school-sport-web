define(["templates/registration","services/access","dialog","consts","utils"],function(e,t,l,a,r){var n={notLoaded:1,new:2,edit:3,import:4,loading:5};function i(e){var t=new FormData;return t.append("student",JSON.stringify({student:e.student,idNumber:e.idNumber,firstName:e.firstName,lastName:e.lastName,birthDate:e.birthDate,grade:e.grade,gender:e.gender})),e.picture&&t.append("picture",e.picture),e.idSlip&&t.append("idSlip",e.idSlip),e.medicalApproval&&t.append("medicalApproval",e.medicalApproval),t}function o(t,e){var n=i(t);Vue.http.post("/api/v2/registration/league/teams/"+encodeURIComponent(e)+"/players",n).then(function(e){t.picture=e.data.picture,t.idSlip=e.data.idSlip,t.medicalApproval=e.data.medicalApproval})}function s(e,t){for(var n=0;n<e.length;n++){var a=e[n];if(a.id===t)return a}return null}function u(a,t,r){function n(){a.teams.splice(0,a.teams.length),function(n,a){n.sports.splice(0,n.sports.length),Vue.http.get("/api/v2/registration/league/competitions").then(function(e){for(var t=0;t<e.body.sports.length;t++)n.sports.push(e.body.sports[t]);a()},function(e){a(e)})}(a,function(e){e?r(e):Vue.http.get("/api/v2/registration/league/teams/"+encodeURIComponent(t)).then(function(e){var n=e.body;n.selectionCount=0,n.sport=s(a.sports,n.sport),n.sport&&(n.category=s(n.sport.categories,n.competition)),n.players||(n.players=[]),n.maxStudentBirthday&&(n.maxStudentBirthday=new Date(n.maxStudentBirthday),n.players=n.players.map(function(e){return null!=e.birthDate&&new Date(e.birthDate)<n.maxStudentBirthday&&(e.aboveMaxAge=!0),e})),n.category&&a.teams.push(n),n.players.forEach(function(e){e.parsedStatus=function(e){switch(e){case 1:return"רשום";case 2:return"מאושר";case 3:return"לא מאושר"}return""}(e.status),null!=e.birthDate&&new Date(e.birthDate).getFullYear()<1990&&(e.birthDate=null)}),n.gotStudentWithoutGrade=0<n.players.filter(function(e){return 0===a.getGrade(e.grade).length}).length,n.gotStudentWithoutBirthday=0<n.players.filter(function(e){return null==e.birthDate}).length,function(e,t){Vue.http.get("/api/v2/registration/league/teams/"+encodeURIComponent(e)+"/transfers").then(function(e){t(null,e.body)}).catch(function(e){t(e)})}(n.id,function(e,t){e?r(e):(0<(t=t.filter(function(t){return null==n.players.find(function(e){return e.idNumber==t.idNumber})}).map(function(e){return e.transfer=!0,e})).length&&(n.players=n.players.concat(t)),n.players=n.players.filter(function(e){return!e.transfer||e.transfer&&e.grade<12}),a.transfers=t,r(null,""))})},function(e){console.log(e),r(e)})})}void 0!==r&&null!=r||(r=new Function),void 0!==t&&null!=t&&t?(Vue.http.post("/api/v2/cache",{key:"latest-league-team",value:t}),n()):Vue.http.get("/api/v2/cache?key=latest-league-team").then(function(e){null!=(t=e.body.Value)?(window.location.hash="#/registration/league/league?team="+t,n()):console.log("read teams called without team id")})}function p(t,n){n.transfer?Vue.http.delete("/api/v2/registration/league/teams/"+encodeURIComponent(t.id)+"/transfers/"+encodeURIComponent(n.idNumber)).then(function(){for(var e=0;e<t.players.length;e++)if(t.players[e]===n){t.players.splice(e,1);break}},function(e){console.log(e)}):Vue.http.delete("/api/v2/registration/league/teams/"+encodeURIComponent(t.id)+"/players/"+encodeURIComponent(n.student)).then(function(){for(var e=0;e<t.players.length;e++)if(t.players[e]===n){t.players.splice(e,1);break}},function(e){console.log(e)})}return Vue.extend({template:e["league-players"],data:function(){return{user:t.user,sports:[],teams:[],teamId:null,states:n,maxTeamPlayers:a.MaxTeamPlayers,inactiveSeason:!1,loginTokenLinks:[]}},mounted:function(){function p(e){return null!=e?{start:r.parseDate(e.rangeStart),end:r.parseDate(e.rangeEnd)}:null}this.teamId=window.location.hash.split("=")[1];var c=this;Vue.http.get("/api/v2/login").then(function(e){c.region=e.data.region,u(c,c.teamId,function(){if(c.teams&&0<c.teams.length){var u=c.user.season;r.readServerCache(["isf-overage","overage"],!0,function(e,t){if(e)console.log(e);else{var n=t["isf-overage"],a=t.overage,l=r.parseIsfOverageItems(n),s=r.parseIsfOverageItems(a);c.teams.forEach(function(e){if(e.players&&0<e.players.length){var t=e.sport.id,n=e.category.category,a=l.find(function(e){return e.season==u&&e.sport==t&&e.category==n}),r=s.find(function(e){return e.season==u&&(0==e.sport||e.sport==t)&&e.category==n});if(null!=a||null!=r){var i=p(a),o=p(r);e.players.forEach(function(e){if(null!=e.birthDate&&0<e.birthDate.toString().length){var t=new Date(e.birthDate);e.isfOverage=function(e,t){return null!=e&&t>=e.start&&t<=e.end}(i,t),e.aboveMaxAge=null!=o&&t<o.end}}),c.$forceUpdate()}}}),Vue.http.get("/api/v2/tokens").then(function(e){null!=e.body&&(c.loginTokenLinks=e.body)})}})}})},function(e){console.log(e)}),c.inactiveSeason=r.inactiveSeason(c),c.inactiveSeason&&r.checkSeasonAuthorization(c.user,function(e,t){1==t&&(c.inactiveSeason=!1)})},methods:{loginTokenLinksClicked:function(){r.openLoginTokenDialog(this.loginTokenLinks,l)},getTeamName:function(e){return e.sport.name+" "+e.category.name+" "+e.teamNumber},getGrade:function(e){var t=["א'","ב'","ג'","ד'","ה'","ו'","ז'","ח'","ט'","י'",'י"א','י"ב'];return null!=e&&0<=e&&e<t.length?t[e]:""},handleSelectionChange:function(e){for(var t=e.selectionCount=0;t<e.players.length;t++)e.players[t].selected&&e.selectionCount++},deletePlayers:function(n){var a=n.players.filter(function(e){return e.selected});if(a.length){a.filter(function(e){return 2==e.status});var e=[];0<a.length&&(e.push(1===a.length?"השחקן הבא יוסר מהקבוצה:":"השחקנים הבאים יוסרו מהקבוצה:"),e.push(a.map(function(e){return e.firstName+" "+e.lastName+" (ת.ז. "+e.idNumber+")"}).join("<br />"))),0<a.length&&e.push("האם להמשיך?");var t=e.join("<br />");l.open("general/message-box",{caption:"מחיקת שחקנים",message:t,alert:!0,confirmText:0<a.length?"כן":"חזרה למסך שחקנים",cancelText:0<a.length?"לא":null},function(e,t){!0===t&&function(e,t){for(var n=0;n<t.length;n++)p(e,t[n])}(n,a)})}},newPlayer:function(o){var n=this;if(o.players.length>=a.MaxTeamPlayers)alert("קבוצה מכילה כמות שחקנים מקסימלית, לא ניתן להוסיף");else{var e={clubs:!1,team:n.getTeamName(o),teamStatus:o.adminStatus,sportId:o.sport.id,existingTeamPlayers:o.players};l.open("registration/player-dialog",e,function(e,t){null!=t&&t.players&&0<t.players.length&&!function n(a,r,i){if(i>=r.length)u(a,a.teamId);else{var e,t=r[i];t.external?e={external:!0,idNumber:t.idNumber}:((e=new FormData).append("student",JSON.stringify({student:t.student,idNumber:t.idNumber,firstName:t.firstName,lastName:t.lastName,birthDate:t.birthDate,grade:t.grade,gender:t.gender})),t.picture&&e.append("picture",t.picture),t.idSlip&&e.append("idSlip",t.idSlip),t.medicalApproval&&e.append("medicalApproval",t.medicalApproval)),Vue.http.post("/api/v2/registration/league/teams/"+encodeURIComponent(o.id)+"/players",e).then(function(e,t){n(a,r,i+1)},function(e){l.open("general/error-message",{caption:"פעולה נכשלה",message:"string"==typeof e.body?e.body:"שגיאה בעדכון שחקן"})})}}(n,t.players,0)})}},uploadPicture:function(e){document.getElementById("picture-input"+e).click()},uploadIdSlip:function(e){document.getElementById("id-slip-input"+e).click()},uploadMedicalApproval:function(e){document.getElementById("medical-approval-input"+e).click()},handlePicture:function(e){var t=this.teams[0].players[e],n=document.getElementById("picture-input"+e).files[0];0===n.type.toLowerCase().indexOf("image/")?(t.picture=n,o(t,this.teams[0].id)):alert("ניתן להעלות קובץ תמונה בלבד, נא לא להעלות PDF או סוגי קבצים אחרים")},handleIdSlip:function(e){var t=this.teams[0].players[e],n=document.getElementById("id-slip-input"+e);t.idSlip=n.files[0],o(t,this.teams[0].id)},handleMedicalApproval:function(e){var t=this.teams[0].players[e],n=document.getElementById("medical-approval-input"+e);t.medicalApproval=n.files[0],o(t,this.teams[0].id)},editPlayer:function(a){var r=this,e=a.players.find(function(e){return 1==e.selected}),t=Object.assign({},e);t.state=3,l.open("registration/player-dialog",t,function(e,t){var n;null!=t&&(n=t.external?{external:!0,idNumber:t.idNumber}:i(t),Vue.http.post("/api/v2/registration/league/teams/"+encodeURIComponent(a.id)+"/players",n).then(function(e,t){u(r,r.teamId)},function(e){l.open("general/error-message",{caption:"פעולה נכשלה",message:"string"==typeof e.body?e.body:"שגיאה בעדכון שחקן"})}))})},openPrint:function(e){var t=window.open("/api/v2/registration/league/teams/"+e.team+"/players/download/team-"+e.team+"-players.pdf");t.onload=function(){t.print()}},validPlayersCount:function(e){var t=this,n=0;return null!=e.players&&(n=e.players.filter(function(e){return 2==e.status&&null!=e.birthDate&&0<t.getGrade(e.grade).length}).length),n}}})});