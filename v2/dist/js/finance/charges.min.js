define(["templates/finance","utils","dialog","services/access","consts","views","components/multiselect","generic/data-table"],function(e,g,i,c,t,a){function d(e){return null==e.account?0:e.account.id?parseInt(e.account.id,10):parseInt(e.account,10)}function h(o,t){function c(e){o.charges=e,g.autoSelect(),t()}void 0===t&&(t=new Function),o.charges=[];var r=d(o);if(null!=r&&0<r&&o.unlimitedDateRange)Vue.http.get("/api/v2/finance/charges?account="+r).then(function(e){for(var t=[],n=0;n<e.body.length;n++){var a=e.body[n];a.selected=!1,a.totalCharge=parseInt(a.totalCharge,10),t.push(a)}c(t)},function(e){o.charges=[],console.log(e),t()});else{var l=["region","type","sport","championship","category"];if(null==o.dateRange.start)return void window.setTimeout(function(){h(o,t)},200);var s="start="+g.formatDate(o.dateRange.start,"YYYY-MM-DD")+"&end="+g.formatDate(o.dateRange.end,"YYYY-MM-DD"),u=g.buildQuerystringByFilters(o,["region","type"]);u+=0===u.length?"?":"&",u+=s,Vue.http.get("/api/v2/finance/charges"+u).then(function(e){for(var a=[],t=0;t<e.body.length;t++){var n=e.body[t];n.selected=!1,n.totalCharge=parseInt(n.totalCharge,10),a.push(n)}!function(e,r){function t(n,e){void 0!==e&&null!=e||(e=[]);var t=[],a={};for(var i in r.forEach(function(e){var t=e[n];null!=t&&0<t.id&&(a[t.id.toString()]=t)}),a){var o=a[i],c={id:o.id,name:o.name};e.forEach(function(e){c[e]=o[e]}),t.push(c)}return t.sort(function(e,t){return e.name.localeCompare(t.name)}),t}void 0!==r&&null!=r||(r=e.charges),e.accounts=t("account",["region"]),e.sports=t("sport"),e.chargeChampionships=[];var n=parseInt(e.sport,10);!isNaN(n)&&0<n&&(e.chargeChampionships=t("championship",["sport"]).filter(function(e){return e.sport==n})),e.chargeCategories=[];var a=parseInt(e.championship,10);!isNaN(a)&&0<a&&(e.chargeCategories=t("category",["championship"]).filter(function(e){return e.championship==a}))}(o,a),r<=0&&(r=null);var i=g.buildQuerystringByFilters(o,l);(i+=0===i.length?"?":"&",i+=s,null!=r||i.length>u.length)?(i+=null!=r?"&account="+r:"",a=[],Vue.http.get("/api/v2/finance/charges"+i).then(function(e){for(var t=0;t<e.body.length;t++){var n=e.body[t];n.selected=!1,n.totalCharge=parseInt(n.totalCharge,10),a.push(n)}c(a)})):c(a)},function(e){o.charges=[],console.log(e),t()})}}return Vue.extend({template:e.charges,props:{region:{},account:{},sport:{},type:{},championship:{},category:{}},data:function(){return{tabName:"כספים",caption:"חיובים",image:"img/finance.svg",user:c.user,charges:[],columns:[{key:"id",name:"זיהוי",active:!1},{key:"date",name:"תאריך",type:"date",active:!0},{key:"account.name",name:"חשבון",active:!0},{key:"school.symbol",name:"סמל בית ספר",active:!0},{key:"region.name",name:"מחוז",active:!0},{key:"city.name",name:"רשות",active:!1},{key:"totalCharge",name:"סכום לחיוב",active:!0},{key:"product.name",name:"סוג חיוב",active:!0},{key:"sport.name",name:"ענף",active:!0},{key:"championship.name",name:"אליפות",active:!0},{key:"category.name",name:"קטגורייה",active:!0},{key:"order",name:"תעודת חיוב",type:"documentNumber",active:!0}],searchText:"",selectedRows:[],regions:[],allRegions:[],userRegion:null,accounts:[],initialAccount:null,city:null,cities:[],mounting:null,sports:[],chargeChampionships:[],chargeCategories:[],defaultStart:null,defaultEnd:null,cachedDateRange:!1,dateRange:{start:null,end:null},types:g.removeProjects(t.sportTypes),selectedRowCount:0,newEntityText:"הוספת חיוב",deleting:!1,deleteFailed:!1,unlimitedDateRange:!1}},mounted:function(){var o=this;o.userRegion=c.user.region,!0!==o.account&&"true"!==o.account||(o.account="-1"),o.mounting=!0,o.defaultEnd=new Date,o.defaultStart=new Date(o.defaultEnd.getTime()),o.defaultStart.setFullYear(o.defaultStart.getFullYear()-1),Vue.http.get("/api/v2/cache?key=charges-date-range").then(function(e){var t=e.body.Value;if("UNLIMITED"==t)null==o.account?o.resetDateRange():o.unlimitedDateRange=!0;else{if(null!=t&&0<t.length){var n=t.split(" - ");if(2===n.length){var a=parseInt(n[0],10),i=parseInt(n[1],10);!isNaN(a)&&0<a&&!isNaN(i)&&a<i&&(o.dateRange.start=new Date(a),o.dateRange.end=new Date(i),o.cachedDateRange=!0)}}null==o.dateRange.end&&(o.dateRange.start=o.defaultStart,o.dateRange.end=o.defaultEnd)}}),function(n,a){void 0===a&&(a=new Function),n.regions.splice(0,n.regions.length),Vue.http.get("/api/v2/manage/regions").then(function(e){n.regions=e.body.map(function(e){return{id:e.Id,name:e.Name}}),n.allRegions=[];for(var t=0;t<n.regions.length;t++)n.allRegions.push(n.regions[t]);c.user.region&&(n.region=c.user.region),a()},function(e){console.log(e),a()})}(o,function(){g.autoSelect(),g.filters.checkInitialSport(o,h,function(){o.mounting=!1,o.updateCaption()})})},watch:{region:function(){g.filters.regionChanged(this,this.charges,h)},city:function(){g.filters.cityChanged(this,this.charges)},account:function(){this.unlimitedDateRange&&null==this.account?this.resetDateRange():g.filters.accountChanged(this,this.charges,h)},type:function(){g.filters.typeChanged(this,h)},sport:function(){g.filters.sportChanged(this,h)},championship:function(){g.filters.championshipChanged(this,h)},category:function(){g.filters.categoryChanged(this,h)}},methods:{resetDateRange:function(){var e=this;e.dateRange.start=e.defaultStart,e.dateRange.end=e.defaultEnd,e.unlimitedDateRange=!1,e.cachedDateRange=!1,Vue.http.post("/api/v2/cache",{key:"charges-date-range",value:""}),e.account=null,e.sport=null,e.championship=null,e.category=null,h(e,function(){e.updateCaption()})},handleSelectionChange:function(){g.handleSelectionChange(this,this.charges)},handleSearchChange:function(){this.$forceUpdate()},updateCaption:function(){var e=this,t="חיובים";e.unlimitedDateRange||null==e.dateRange.start||null==e.dateRange.end||(t+=" - "+g.formatDate(e.dateRange.start,"dd/mm/yy")+" עד "+g.formatDate(e.dateRange.end,"dd/mm/yy"));var n=d(e);if(0<n){var a=e.accounts.find(function(e){return e.id===n});null!=a&&(t+=" - "+a.name),e.unlimitedDateRange&&(t+=" - ללא הגבלת זמן")}else{var i=g.filters.buildCaption(e,{championships:"chargeChampionships",categories:"chargeCategories"});0<i.length&&(t+=" - "+i.join(" - "))}e.caption=t},logout:function(){c.logout()},getAccountId:function(){return d(this)},sumAll:function(){return g.sumDataRows(this.charges,"totalCharge",this.selectedRows.length)},dateDisplay:function(e){return g.formatDate(e)},generateReceipt:function(){if(0!==this.selectedRows.length)if(1<this.selectedRows.length)console.log("More than one charge selected");else{var e=this.selectedRows[0],n=e.account;if(null!=n){var t=[{order:e.order}];t.forEach(function(e){e.expanded=!1,e.parsedOrder=g.parseDocumentNumber(e.order)}),i.open("finance/new-receipt",{account:n,region:e.region,paymentRequests:t,disableClickOutside:!0},function(e,t){void 0!==t&&null!=t&&t.id&&a.openView("finance/receipts",{account:n.id})})}else console.log("No matching account")}else console.log("No selected charge")},openDateSelection:function(){var a=this;i.open("general/date-range-selection",{maxDaysDiff:730,startDate:a.dateRange.start,endDate:a.dateRange.end,allowUnlimited:null!=a.account},function(e,t){if(null!=t){var n="";n=t.unlimited?(a.unlimitedDateRange=!0,"UNLIMITED"):(a.dateRange.start=t.start,a.dateRange.end=t.end,a.account=null,a.sport=null,a.championship=null,a.category=null,[a.dateRange.start.getTime(),a.dateRange.end.getTime()].join(" - ")),a.cachedDateRange=!0,Vue.http.post("/api/v2/cache",{key:"charges-date-range",value:n}),h(a,function(){a.updateCaption()})}})},editSelectedCharge:function(){var n=this;if(n.selectedRows.length<1)console.log("no selected rows");else if(1<n.selectedRows.length)console.log("more than one row selected");else{var e=n.selectedRows[0];i.open("finance/charge-dialog",{id:e.id,disableClickOutside:!0},function(e,t){null==e&&null!=t&&(n.selectedRows=[],h(n,function(){n.updateCaption()}))})}},deleteSelectedCharges:function(){var a=this;if(a.selectedRows.length<1)console.log("no selected rows");else if(5<a.selectedRows.length)console.log("can delete only up to 5 rows at a time");else{var e="מחיקת "+(1<a.selectedRows.length?"חיובים":"חיוב"),t=[];t.push("נא לאשר את מחיקת "+(1<a.selectedRows.length?"החיובים הבאים:":"החיוב הבא")),a.selectedRows.forEach(function(e){t.push(e.account.name+" מתאריך "+g.formatDate(e.date)+" על סך "+e.totalCharge+' ש"ח')});var n={caption:e,message:t.join("<br />"),alert:!0,confirmText:"אישור",cancelText:"ביטול"};i.open("general/message-box",n,function(e,t){if(t){a.deleting=!0,a.deleteFailed=!1;var n=a.selectedRows.map(function(e){return e.id});!function t(n,a,i){if(i>=a.length)return n.deleting=!1,void(n.selectedRows=[]);var o=a[i],e="/api/v2/finance/charge?id="+o;Vue.http.delete(e).then(function(e){n.charges=n.charges.filter(function(e){return e.id!=o}),t(n,a,i+1)},function(e){console.log(e),n.deleteFailed=!0,n.deleting=!1,window.setTimeout(function(){n.deleteFailed=!1},2500)})}(a,n,0)}})}},newCharge:function(){var c=this,e=g.intOrDefault(c.region),t=g.intOrDefault(c.account);if(null==e&&null!=t&&0<t){var n=c.accounts.find(function(e){return e.id==t});null!=n&&(e=n.region)}i.open("finance/charge-dialog",{region:e,account:t,disableClickOutside:!0},function(e,t){if(null==e&&null!=t){var n=new Date(t.creationDate),a=n.getFullYear();if(2e3<=a&&a<2100){var i=new Date(n.getTime()+864e5),o=new Date(i.getTime()-31536e6);c.dateRange.start=o,c.dateRange.end=i,c.selectedRows=[],h(c,function(){c.updateCaption()})}}})}}})});