define(["templates/finance","utils","dialog","services/access","consts","views","components/multiselect","generic/data-table"],function(e,l,o,a,n,t){function i(e){if(l.extractEntityId(e.region)<0){var n={};e.receipts.forEach(function(e){n[e.region.id.toString()]=!0}),e.regions=e.allRegions.filter(function(e){return!0===n[e.id]})}}function c(t,i){void 0===i&&(i=function(){}),t.regions.splice(0,t.regions.length),Vue.http.get("/api/v2/manage/regions").then(function(e){t.regions=e.body.map(function(e){return{id:e.Id,name:e.Name}}),t.allRegions=[];for(var n=0;n<t.regions.length;n++)t.allRegions.push(t.regions[n]);a.user.region&&(t.region=a.user.region),i()},function(e){console.log(e),i()})}function p(e){return null==e.account?0:e.account.id?parseInt(e.account.id,10):parseInt(e.account,10)}function s(a,n){function c(e){a.receipts=e,a.sports=l.filters.readAccountSports(a.receipts),a.mounting&&null==a.initialAccount&&i(a),function(e,n){e.accounts=[];var t={};for(var i in e.receipts.forEach(function(e){null!=e.account&&(t[e.account.id.toString()]=e.account)}),t){var o=t[i];e.accounts.push({id:o.id,name:o.name})}e.accounts.sort(function(e,n){return e.name.localeCompare(n.name)}),n()}(a,function(){l.autoSelect(),n()})}void 0===n&&(n=function(){}),a.receipts=[];var s=["region","season","type","sport","championship","category"],r=l.buildQuerystringByFilters(a,["region","season","type"]);a.receipts=[];var u=p(a);u<=0&&(u=null),null!=u&&(0===r.length?r+="?":r+="&",r+="account="+u),Vue.http.get("/api/v2/finance/receipts"+r).then(function(e){for(var i=[],n=0;n<e.body.length;n++){var t=e.body[n];t.selected=!1,i.push(t)}a.championships=[],a.categories=[];var o=l.buildQuerystringByFilters(a,s);null!=u&&(0===o.length?o+="?":o+="&",o+="account="+u),o.length>r.length?(i=[],Vue.http.get("/api/v2/finance/receipts"+o).then(function(e){for(var n=0;n<e.body.length;n++){var t=e.body[n];t.selected=!1,i.push(t)}c(i)})):c(i)},function(e){a.receipts=[],console.log(e),n()})}return Vue.extend({template:e.receipts,props:{region:{},account:{},sport:{},type:{},championship:{},category:{}},data:function(){return{tabName:"כספים",caption:"קבלות",image:"img/finance.svg",user:a.user,receipts:[],columns:[{key:"number",name:"מספר",active:!0},{key:"account.name",name:"חשבון",active:!0},{key:"region.name",name:"מחוז",active:!0},{key:"city.name",name:"רשות",active:!1},{key:"sum",name:"סכום",active:!0},{key:"date",name:"תאריך",type:"date",active:!0},{key:"remarks",name:"הערות",active:!0},l.dataTableButton("תשלומים","paymentCount",this.showPayments),l.dataTableButton("זיכוי חשבונות","creditedAccounts",this.showCreditedAccounts),l.dataTableButton("תעודות חיוב","paymentRequests",this.showPaymentRequests)],searchText:"",selectedRows:[],regions:[],allRegions:[],userRegion:null,season:null,seasons:[],accounts:[],initialAccount:null,city:null,cities:[],mounting:null,sports:[],championships:[],categories:[],types:l.removeProjects(n.sportTypes),selectedRowCount:0}},mounted:function(){this.userRegion=a.user.region;var e=this;!0!==e.account&&"true"!==e.account||(e.account="-1"),e.mounting=!0,function(t,i){void 0===i&&(i=function(){}),t.seasons.splice(0,t.seasons.length),Vue.http.get("/api/v2/manage/seasons").then(function(e){t.seasons=e.body.map(function(e){return{id:e.Id,name:e.Name}}),Vue.http.get("/api/v2/cache?key=season").then(function(e){var n=e.body.Value;null!=n?t.season=n:a.user.season&&(t.season=a.user.season),i()},function(e){i()})},function(e){console.log(e),i()})}(e,function(){c(e,function(){l.autoSelect(),l.filters.checkInitialSport(e,s,function(){e.mounting=!1,e.updateCaption()})})})},watch:{region:function(){l.filters.regionChanged(this,this.receipts,s)},season:function(){var e=this;e.mounting||(Vue.http.post("/api/v2/cache",{key:"season",value:e.season}),e.region=-1,c(e,function(){l.autoSelect(),s(e,function(){i(e)})}))},city:function(){l.filters.cityChanged(this,this.receipts)},account:function(){l.filters.accountChanged(this,this.receipts,s)},type:function(){l.filters.typeChanged(this,s)},sport:function(){l.filters.sportChanged(this,s)},championship:function(){l.filters.championshipChanged(this,s)},category:function(){l.filters.categoryChanged(this,s)}},methods:{handleSelectionChange:function(){l.handleSelectionChange(this,this.receipts)},handleSearchChange:function(){this.$forceUpdate()},printReceipt:function(e){if(1===this.selectedRows.length){var n="/api/v2/finance/receipt/"+this.selectedRows[0].id+"/print";e&&(n+="?pdf=1");var t=window.open(n,"_blank");t.onload=function(){e||t.print()}}else{var i=0===this.selectedRows.length?"לא נבחרה קבלה":"נבחרו מספר קבלות";o.open("general/message-box",{caption:"שגיאה",message:i})}},sumAll:function(){return l.sumDataRows(this.receipts,"sum",this.selectedRows.length)},updateCaption:function(){var e="קבלות",n=p(this);if(0<n){var t=this.accounts.find(function(e){return e.id===n});null!=t&&(e+=" - "+t.name)}else{var i=l.filters.buildCaption(this);0<i.length&&(e+=" - "+i.join(" - "))}this.caption=e},logout:function(){a.logout()},showPayments:function(e,n){var t="/api/v2/finance/receipt/"+e.id+"/payments";o.open("generic/data-dialog",{caption:"תשלומים עבור קבלה "+e.number,dataUrl:t},function(){})},showCreditedAccounts:function(e,n){var t="/api/v2/finance/receipt/"+e.id+"/credits";o.open("generic/data-dialog",{caption:"זיכוי חשבונות -  "+e.number,dataUrl:t},function(){})},showPaymentRequests:function(e,n){var t="/api/v2/finance/receipt/"+e.id+"/payment-requests",i="תעודות חיוב - "+e.number+", "+e.account.name;o.open("generic/data-dialog",{caption:i,hideSearch:!0,dataUrl:t},function(){})},getAccountId:function(){return p(this)}}})});