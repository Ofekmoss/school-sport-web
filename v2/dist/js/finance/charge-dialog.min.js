function getChargeDate(){var n=parseInt($("#ChargeCreationDate").text(),10);return!isNaN(n)&&0<n?new Date(n):new Date}define(["templates/finance","dialog","utils","components/selectex"],function(n,e,s){function t(i,t){void 0!==t&&null!=t||(t=new Function);var n=parseInt(i.region,10);if(isNaN(n)&&(n=-1),i.accounts=[],i.mounting||(i.account=null),0<=n){var e="/api/v2/finance/raw-accounts?region="+n;Vue.http.get(e).then(function(n){if(n.body.forEach(function(n,e){var t=n.name,o=" (בית ספר)";0<t.indexOf(o)&&(t=t.replace(o,""),n.symbol&&(t+=" (סמל מוסד "+n.symbol+")")),i.accounts.push({id:n.id,name:n.name,label:t,symbol:n.symbol,school:n.school})}),null!=i.account&&"number"==typeof i.account){var e=i.account;i.account=i.accounts.find(function(n){return n.id==e})}t()})}else t()}function o(t,e){void 0!==e&&null!=e||(e=new Function),t.schools=[],t.school=null;var n=parseInt(t.region,10);if(!isNaN(n)&&0<=n){var o={};t.accounts.forEach(function(n){n.school&&(o[n.school.toString()]=!0)});var i="/api/v2/manage/schools?region="+n;Vue.http.get(i).then(function(n){n.body.forEach(function(n){if(!o[n.Id.toString()]){var e=n.Name+" (סמל מוסד "+n.Symbol+")";t.schools.push({id:n.Id,name:n.Name,label:e})}}),e()},function(n){console.log(n),e()})}else e()}function i(a,c){void 0!==c&&null!=c||(c=new Function),a.sports=[],a.mounting||(a.sport=null);var e=s.intOrDefault(a.season);if(null!=e&&0<e){var u=[];Vue.http.get("/api/v2/manage/sports").then(function(n){n.body.forEach(function(n){u.push({id:n.Id,name:n.Name})}),Vue.http.get("/api/v2/manage/category-names?season="+e).then(function(n){var e={};for(var t in n.body.forEach(function(n){n.Sports&&n.Sports.forEach(function(n){e[n.toString()]=!0})}),e){var o=parseInt(t,10),i=u.find(function(n){return n.id==o});null!=i?a.sports.push({id:o,name:i.name}):console.log("sport "+o+" not found")}a.sports.sort(function(n,e){return n.name.localeCompare(e.name)}),c()},function(n){console.log(n),c()})},function(n){console.log(n),c()})}else c()}function a(t,o){void 0!==o&&null!=o||(o=new Function);var n=parseInt(t.season,10),e=parseInt(t.sport,10);if(isNaN(n)||n<=0||isNaN(e)||e<=0)o();else{t.championships=[],t.mounting||(t.championship=null);var i="/api/v2/manage/categories/season/"+n+"/sport/"+e;t.championshipStatus.loading=!0,t.championshipStatus.loaded=!1,t.championshipStatus.failed=!1,Vue.http.get(i).then(function(n){if(n.body.forEach(function(n){var e=n.Championship.Name+" "+n.Name;t.championships.push({id:n.Id,name:n.Name,label:e})}),t.mounting&&null!=t.category&&"number"==typeof t.category){var e=t.category;t.championship=t.championships.find(function(n){return n.id==e})}t.championshipStatus.loading=!1,t.championshipStatus.loaded=!0,window.setTimeout(function(){$(".selectex").css("margin-right","0px")},200),o()},function(n){console.log(n),t.championshipStatus.loading=!1,t.championshipStatus.failed=!0,o()})}}return Vue.extend({template:n["charge-dialog"],data:function(){return{expandableObjects:{newAccount:!1,paymentRequest:!1,championships:!1},newAccountExpanded:!1,charge:{id:null,creationDate:null,sum:0,new:!1,editing:!1},chargeProgress:{creating:!1,created:!1,failed:!1},accounts:[],account:null,regions:[],region:null,schools:[],school:null,products:[],product:null,paymentRequests:[],paymentRequest:null,seasons:[],season:null,sports:[],sport:null,championships:[],championship:null,category:null,newAccount:{name:null,school:null},championshipStatus:{loading:!1,loaded:!1,failed:!1},mounting:!1,existingAccountId:null,isValid:!0,changed:!1,confirmClosure:!1,overrideInvalidChargeReason:null,removeChampionship:!1,removePaymentRequest:!1,initialChampionship:null,initialPaymentRequest:null}},mounted:function(){var n=this;for(var e in n.charge)n.charge.hasOwnProperty(e)&&null!=n[e]&&(n.charge[e]=n[e]);null==n.charge.creationDate&&(n.charge.creationDate=new Date),n.charge.creationDate=s.formatDate(n.charge.creationDate,"YYYY-MM-DD"),null!=n.charge.id&&(n.charge.id=s.intOrDefault(n.charge.id)),n.charge.new=null==n.charge.id||n.charge.id<=0,n.charge.editing=null!=n.charge.id||0<n.charge.id,n.mounting=!0,function(t,o){void 0!==o&&null!=o||(o=new Function);var n=parseInt(t.charge.id,10);if(!isNaN(n)&&0<n){var e="/api/v2/finance/charge/"+n;Vue.http.get(e).then(function(n){var e=n.body;t.account=s.intOrDefault(e.account),t.paymentRequest=s.intOrDefault(e.paymentRequest),t.category=s.intOrDefault(e.category),t.championship=s.intOrDefault(e.championship),t.charge.creationDate=s.formatDate(e.date,"YYYY-MM-DD"),t.region=e.region,t.product=e.product,t.charge.sum=e.sum,t.season=e.season,t.sport=e.sport,o()},function(n){console.log(n),o()})}else o()}(n,function(){!function(e,t){void 0!==t&&null!=t||(t=new Function),e.regions=[],Vue.http.get("/api/v2/manage/regions").then(function(n){n.body.forEach(function(n){e.regions.push({id:n.Id,name:n.Name})}),t()},function(n){console.log(n),t()})}(n,function(){t(n,function(){o(n,function(){!function(e,t){void 0!==t&&null!=t||(t=new Function),e.products=[],e.mounting||(e.product=null),Vue.http.get("/api/v2/finance/products").then(function(n){n.body.forEach(function(n){e.products.push({id:n.id,name:n.name,price:n.price})}),e.products.sort(function(n,e){return n.name.localeCompare(e.name)}),t()},function(n){console.log(n),t()})}(n,function(){!function(n,e){null!=n.paymentRequest&&0<n.paymentRequest?n.togglePaymentRequestsPanel(e):e()}(n,function(){!function(n,e){null!=n.category&&0<n.category?n.toggleChampionshipsPanel(e):e()}(n,function(){n.initialChampionship=n.championship,n.initialPaymentRequest=n.paymentRequest,function(n){window.setTimeout(function(){n.mounting=!1,n.$forceUpdate()},500)}(n)})})})})})})}),window.setTimeout(function(){$(".selectex").css("margin-right","0px"),$(".selectex").css("width","85%")},200)},methods:{toggleExpanded:function(n){var e=null;if("string"==typeof n){var t=n;e=!this.expandableObjects[t],this.expandableObjects[t]=e}else null!=n&&(e=!n.expanded,n.expanded=e);return e},isExpanded:function(n){return!0===this.expandableObjects[n]},togglePaymentRequestsPanel:function(n){void 0!==n&&null!=n||(n=new Function);this.toggleExpanded("paymentRequest")?(0===this.paymentRequests.length?function(i,t){void 0!==t&&null!=t||(t=new Function),i.paymentRequests=[],i.mounting||(i.paymentRequest=null),Vue.http.get("/api/v2/finance/payment-requests").then(function(n){if(n.body.forEach(function(n){console.log(n);var e=n.Id||n.id,t=s.ParsePaymentOrder(e),o=n.PayerName||n.payerName;o||null==n.account||(o=n.account.name),o||(o=""),t+=" ("+(o=o.replace(" (בית ספר)",""))+")",i.paymentRequests.push({id:e,payerName:o,time:n.Time||n.time,label:t})}),i.mounting&&null!=i.paymentRequest&&"number"==typeof i.paymentRequest){var e=i.paymentRequest;i.paymentRequest=i.paymentRequests.find(function(n){return n.id==e})}t()},function(n){console.log(n),t()})}(this,n):n(),window.setTimeout(function(){$(".selectex").css("margin-right","0px")},200)):n()},toggleChampionshipsPanel:function(n){void 0!==n&&null!=n||(n=new Function);var e=this;e.toggleExpanded("championships")&&0===e.seasons.length?function(e,t){void 0!==t&&null!=t||(t=new Function),e.seasons=[],e.mounting||(e.season=null),Vue.http.get("/api/v2/manage/seasons").then(function(n){n.body.forEach(function(n){e.seasons.push({id:n.Id,name:n.Name})}),t()},function(n){console.log(n),t()})}(e,function(){i(e,function(){e.mounting&&null!=e.category&&0<e.category?a(e,n):n()})}):n()},resetSeason:function(){this.season=null},resetSport:function(){this.sport=null},chargeInvalidReason:function(){var n=this;if(null!=n.overrideInvalidChargeReason)return n.overrideInvalidChargeReason;if(null==n.product||n.product<=0)return"יש לבחור סוג חיוב";if(!s.isValidDate(n.charge.creationDate))return"יש להזין תאריך יצירת חיוב";if(n.charge.sum<=0)return"יש להזין סכום לחיוב";if(null==n.region||n.region<0)return"יש לבחור מחוז";if(n.newAccountExpanded){var e,t=n.newAccount.school;if(null!=t&&null!=(e=n.accounts.find(function(n){return n.school==t.id})))return n.existingAccountId=e.id,"כבר קיים חשבון עבור בית ספר זה";var o=(n.newAccount.name||"").trim();if(0===o.length)return"יש להזין שם חשבון חדש";var i=o+" (בית ספר)";if(null!=(e=n.accounts.find(function(n){return n.name===o||n.name===i})))return n.existingAccountId=e.id,"חשבון בעל שם זהה כבר קיים"}else if(null==n.account||!n.account.id)return"יש לבחור חשבון לחיוב";return null},dataChanged:function(n){this.mounting||(this.changed=!0)},newAccountNameChanged:function(){this.existingAccountId=null,this.dataChanged()},productChanged:function(){var e=this;if(e.dataChanged(),null!=e.product){var n=e.products.find(function(n){return n.id==e.product});null!=n&&(e.charge.sum=n.price)}},resetProduct:function(){this.product=null},regionChanged:function(){var n=this;t(n,function(){o(n)}),n.dataChanged()},resetRegion:function(){this.region=null,this.dataChanged()},seasonChanged:function(){var n=this;i(n,function(){a(n)})},sportChanged:function(){a(this)},addAccount:function(){this.newAccountExpanded=!0,window.setTimeout(function(){$(".selectex").css("margin-right","0px"),$("#txtNewAccountName").focus()},200)},cancelNewAccount:function(){this.newAccountExpanded=!1,window.setTimeout(function(){$(".selectex").css("margin-right","0px"),$(".selectex").css("width","85%")},200)},selectExistingAccount:function(){var e=this;null!=e.existingAccountId&&(e.cancelNewAccount(),e.account=e.accounts.find(function(n){return n.id==e.existingAccountId}),e.existingAccountId=null)},confirmButtonVisible:function(){var n=this.chargeInvalidReason();return!(null!=n&&0<n.length)&&(!0!==s.anyTrue(this.chargeProgress)&&!(this.charge.editing&&!this.changed))},cancelChampionship:function(){this.removeChampionship=!0,this.dataChanged()},cancelPaymentRequest:function(){this.removePaymentRequest=!0,this.dataChanged()},restoreChampionship:function(){this.removeChampionship=!1,this.dataChanged()},restorePaymentRequest:function(){this.removePaymentRequest=!1,this.dataChanged()},saveCharge:function(){function e(n,e){n.chargeProgress.creating=!1,n.chargeProgress.created=!0,window.setTimeout(function(){n.charge.id=e,n.confirm()},3e3)}function t(n,e){n.chargeProgress.creating=!1,n.chargeProgress.failed=!0,console.log(e),window.setTimeout(function(){n.chargeProgress.failed=!1},3e3)}var o=this,n={region:o.region,date:o.charge.creationDate,sum:o.charge.sum,product:o.product,paymentRequest:o.paymentRequest?o.paymentRequest.id:null,category:o.championship?o.championship.id:null,account:o.account?o.account.id:null,newAccount:o.newAccount?{name:o.newAccount.name,school:o.newAccount.school?o.newAccount.school.id:null}:null};o.chargeProgress.creating=!0,o.charge.editing?(n.id=o.charge.id,n.removeChampionship=o.removeChampionship,n.removePaymentRequest=o.removePaymentRequest,Vue.http.post("/api/v2/finance/charge",n).then(function(n){e(o,o.charge.id)},function(n){t(o,n)})):o.charge.new&&Vue.http.put("/api/v2/finance/charge",n).then(function(n){e(o,n.body.ChargeId)},function(n){t(o,n)})},cancel:function(){this.changed?this.confirmClosure=!0:this.$emit("close")},confirm:function(){this.$emit("close",this.charge)},reallyCancel:function(){this.$emit("close")},abortCancel:function(){this.confirmClosure=!1}},computed:{},watch:{}})});