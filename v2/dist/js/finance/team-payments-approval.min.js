define(["templates/finance","utils","dialog","services/access","consts","components/multiselect","generic/data-table"],function(e,t,n,a,s){function i(s){var e=1===parseInt(s.competitionType)?"clubs=1":"league=1";s.payments.splice(0,s.payments.length),Vue.http.get("/api/v2/finance/team-payments?"+e).then(function(e){for(var t=0;t<e.body.length;t++){var a=e.body[t];if(a.team&&a.details&&a.details.items){var n=a.details.items.find(function(e){return e.teams&&0<=e.teams.indexOf(a.team)});null!=n&&(a.totalAmount=n.price||0)}a.amountToPay=a.totalAmount-(a.paidAmount||0),isNaN(a.amountToPay)&&(a.amountToPay=0),s.payments.push(a)}},function(e){console.log(e)})}function o(e){return Vue.http.post("/api/v2/finance/payments/payment",e)}return Vue.extend({template:e["team-payments-approval"],data:function(){return{caption:"כספים",image:"img/finance.svg",user:a.user,competitionType:1,payments:[],columns:[{key:"payment",name:"מספר תעודת חיוב",type:"documentNumber",active:!0},{key:"championshipName",name:"אליפות",active:!0},{key:"categoryName",name:"קטגוריית גיל",active:!0},{key:"school.name",name:"בית ספר",active:!0},{key:"school.symbol",name:"סימול בית ספר",active:!1},{key:"school.region",name:"מחוז",active:!1},{key:"payerName",name:"גורם משלם",active:!1},{key:"details.contacts.name",name:"אנשי קשר",active:!1},{key:"totalAmount",name:"סכום",active:!0},{key:"createdAt",name:"תאריך יצירה",type:"date",active:!0},{key:"paidAmount",name:"שולם",active:!0},{key:"amountToPay",name:"נותר לתשלום",active:!0},{key:"order",name:"צפייה בתעודת חיוב",type:"openFile",active:!0},{name:"עדכון תשלום",key:"status",type:"button",active:!0,onclick:this.updatePayment,checkDisabled:this.checkDisabled}],searchText:"",isSelectAll:!1,statuses:[{id:1,name:"אושר"},{id:2,name:"לא אושר"},{id:3,name:"ממתין לאישור"}],selectedStatus:null,selectedPayments:[]}},mounted:function(){i(this)},watch:{competitionType:function(){i(this)}},methods:{handleSelectionChange:function(){this.selectedPayments.splice(0,this.selectedPayments.length),this.selectedStatus=null;for(var e=0;e<this.payments.length;e++){var t=this.payments[e];t.selected&&(0===this.selectedPayments.length?this.selectedStatus=t.status:this.selectedStatus!=t.status&&(this.selectedStatus=null),this.selectedPayments.push(t))}},changeStatus:function(e){},logout:function(){a.logout()},checkDisabled:function(e,t){return 0==e.paidAmount},updatePayment:function(a,e){n.open("finance/team-payments-dialog",{payment:a.totalAmount},function(e,t){void 0!==t&&null!=t&&t!=a.totalAmount&&o([{payment:a.payment,team:a.team,amount:t}]).then(function(e){a.paidAmount=t,a.amountToPay=a.totalAmount-t})})},payAll:function(){var t=this;o(this.selectedPayments.map(function(e){return{payment:e.payment,team:e.team}})).then(function(e){t.selectedPayments.forEach(function(e){e.paidAmount=e.totalAmount,e.amountToPay=0}),t.payments=t.payments.slice()})}}})});