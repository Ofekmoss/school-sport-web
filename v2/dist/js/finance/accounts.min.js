define(["templates/finance","utils","dialog","services/access","consts","views","components/multiselect","generic/data-table"],function(n,u,t,i,o,e){function a(e){if(!0!==e.sport&&"true"!==e.sport||(e.sport=null),!e.mounting||e.mounting&&null!=e.sport){var i=null!=e.sport;e.championships=[],e.championship=null,e.accounts.forEach(function(n){var t=!0,o=null;i&&null!=n.sports&&(t=null!=(o=n.sports.find(function(n){return n.id==e.sport}))),n.hidden=!t,null==o?(n.totalAmount=n.originalTotalAmount,n.paidAmount=n.originalPaidAmount,n.remainingAmount=n.originalRemainingAmount):(n.totalAmount=o.totalAmount,n.paidAmount=o.paidAmount,n.remainingAmount=o.remainingAmount,null!=o.championships&&o.championships.forEach(function(n){e.championships.push(n)}))}),e.updateCaption(),e.championships=u.distinctArray(e.championships,"id")}}function s(n){if(null==n.region){var t={};n.accounts.forEach(function(n){t[n.region.id.toString()]=!0}),n.regions=n.allRegions.filter(function(n){return!0===t[n.id]})}}function c(e,i){void 0===i&&(i=function(){}),e.accounts=[];var n=[];null!=e.type&&"true"!=e.type&&n.push("type="+e.type),null!=e.region&&n.push("region="+e.region),null!=e.season&&n.push("season="+e.season);var t=0<n.length?"?"+n.join("&"):"";Vue.http.get("/api/v2/finance/accounts"+t).then(function(n){e.accounts=[];for(var t=0;t<n.body.length;t++){var o=n.body[t];o.green=0===o.remainingAmount,o.selected=!1,o.originalTotalAmount=o.totalAmount,o.originalPaidAmount=o.paidAmount,o.originalRemainingAmount=o.remainingAmount,e.accounts.push(o)}e.mounting&&s(e),function(o){o.sports=[];var e={};o.accounts.forEach(function(n){n.sports&&n.sports.forEach(function(n){var t=n.id.toString();e[t]||(o.sports.push(n),e[t]=!0)})}),o.sports.sort(function(n,t){return n.name.localeCompare(t.name)})}(e),u.autoSelect(),e.accounts.sort(function(n,t){var o=n.region.name,e=t.region.name;if(o!==e)return o.localeCompare(e);var i=null==n.city?"תתת":n.city.name,a=null==t.city?"תתת":t.city.name;return i===a?n.name.localeCompare(t.name):i.localeCompare(a)}),e.mounting&&a(e),i()},function(n){e.accounts=[],console.log(n),i()})}return Vue.extend({template:n.accounts,props:{region:{},sport:{},type:{}},data:function(){return{tabName:"כספים",caption:"חשבונות",image:"img/finance.svg",user:i.user,accounts:[],columns:[{key:"name",name:"שם חשבון",active:!0},{key:"region.name",name:"מחוז",active:!0},{key:"school.symbol",name:"סמל בית ספר",active:!0,getter:function(n){var t=n.school?parseInt(n.school.symbol,10):0;return isNaN(t)||0===t?"":t}},{key:"city.name",name:"רשות",active:!0},{key:"totalAmount",name:"סכום",active:!0},{key:"paidAmount",name:"שולם",active:!0},{key:"remainingAmount",name:"נותר לתשלום",active:!0},{name:"תעודות חיוב",key:"paymentRequests",type:"button",active:!0,onclick:this.showPaymentRequests,checkDisabled:function(n,t){return 0==n.paymentRequestCount},getText:function(n,t){var o="תעודות חיוב";return 0<n.paymentRequestCount&&(o+=" ("+n.paymentRequestCount+")"),o},getter:function(n){return n.paymentRequestCount}},{name:"קבלות",key:"receipts",type:"button",active:!0,onclick:this.showReceipts,checkDisabled:function(n,t){return 0==n.receiptCount},getText:function(n,t){var o="קבלות";return 0<n.receiptCount&&(o+=" ("+n.receiptCount+")"),o},getter:function(n){return n.receiptCount}}],searchText:"",selectedRows:[],regions:[],allRegions:[],userRegion:null,season:null,seasons:[],city:null,cities:[],sports:[],championship:null,championships:[],category:null,categories:[],mounting:null,types:u.removeProjects(o.sportTypes)}},mounted:function(){this.userRegion=i.user.region;var n=this;n.mounting=!0,function(o,e){void 0===e&&(e=function(){}),o.seasons.splice(0,o.seasons.length),Vue.http.get("/api/v2/manage/seasons").then(function(n){o.seasons=n.body.map(function(n){return{id:n.Id,name:n.Name}}),Vue.http.get("/api/v2/cache?key=season").then(function(n){var t=n.body.Value;null!=t?o.season=t:i.user.season&&(o.season=i.user.season),e()},function(n){e()})},function(n){console.log(n),e()})}(n,function(){!function(o,e){void 0!==e&&null!=e||(e=new Function),o.regions=[],Vue.http.get("/api/v2/manage/regions").then(function(n){o.regions=n.body.map(function(n){return{id:n.Id,name:n.Name}}),o.allRegions=[];for(var t=0;t<o.regions.length;t++)o.allRegions.push(o.regions[t]);i.user.region&&(o.region=i.user.region),e()},function(n){console.log(n),e()})}(n,function(){u.autoSelect(),c(n,function(){n.mounting=!1,n.updateCaption()})})})},watch:{type:function(){var n=this;!0!==n.type&&"true"!==n.type||(n.type=null),n.mounting||c(n,function(){n.updateCaption()})},region:function(){var e=this;!0!==e.region&&"true"!==e.region||(e.region=null),e.mounting?e.updateCaption():c(e,function(){if(e.cities=[],(e.city=null)!=e.region){var t={};for(var n in e.accounts.forEach(function(n){null!=n.city&&(t[n.city.id.toString()]=n.city)}),t){var o=t[n];e.cities.push({id:o.id,name:o.name})}e.cities.sort(function(n,t){return n.name.localeCompare(t.name)})}a(e),e.updateCaption()})},season:function(){var n=this;n.mounting||(Vue.http.post("/api/v2/cache",{key:"season",value:n.season}),u.autoSelect(),c(n,function(){a(n),s(n)}))},city:function(){var o=this;if(!o.mounting){var e=null!=o.city;o.accounts.forEach(function(n){var t=!0;e&&null!=n.city&&(t=n.city.id==o.city),n.hidden=!t})}},sport:function(){a(this)},championship:function(){var i=this;if(null!=i.sport&&!i.mounting){var a=null!=i.championship;i.categories=[],i.category=null,i.accounts.forEach(function(n){var t=n.sports.find(function(n){return n.id==i.sport}),o=null,e=!1;null!=t?a&&null!=t.championships&&(e=null==(o=t.championships.find(function(n){return n.id==i.championship}))):e=!0,n.hidden=e,null==o?null!=t&&(n.totalAmount=t.totalAmount,n.paidAmount=t.paidAmount,n.remainingAmount=t.remainingAmount):(n.totalAmount=o.totalAmount,n.paidAmount=o.paidAmount,n.remainingAmount=o.remainingAmount,null!=o.categories&&o.categories.forEach(function(n){i.categories.push(n)}))}),i.categories=u.distinctArray(i.categories,"id")}},category:function(){var a=this;if(null!=a.sport&&null!=a.championship&&!a.mounting){var u=null!=a.category;a.accounts.forEach(function(n){var t=n.sports.find(function(n){return n.id==a.sport}),o=null==t?null:t.championships.find(function(n){return n.id==a.championship}),e=null,i=!1;null!=t&&null!=o?u&&null!=o.categories&&(i=null==(e=o.categories.find(function(n){return n.id==a.category}))):i=!0,n.hidden=i,null==e?null!=o&&(n.totalAmount=o.totalAmount,n.paidAmount=o.paidAmount,n.remainingAmount=o.remainingAmount):(n.totalAmount=e.totalAmount,n.paidAmount=e.paidAmount,n.remainingAmount=e.remainingAmount)})}}},methods:{handleSelectionChange:function(){this.selectedRows=this.accounts.filter(function(n){return 1==n.selected})},handleSearchChange:function(){this.$forceUpdate()},sumAll:function(n){return u.sumDataRows(this.accounts,n,this.selectedRows.length)},updateCaption:function(){var n=this,t="חשבונות",o=u.findById(n.seasons,n.season),e=u.findById(n.regions,n.region),i=u.findById(n.sports,n.sport);null!=o&&(t+=" - "+o.name),null!=e&&(t+=" - "+e.name),null!=i&&(t+=" - "+i.name),n.caption=t},logout:function(){i.logout()},showPaymentRequests:function(n,t){e.openView("finance/payment-requests",{account:n.id})},showReceipts:function(n,t){e.openView("finance/receipts",{account:n.id})}}})});