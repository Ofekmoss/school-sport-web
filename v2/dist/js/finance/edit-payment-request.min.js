define(["templates/finance","dialog","utils","components/selectex"],function(t,e,a){function n(n,t,e){if(n.accounts=[],0<=t){var a="/api/v2/finance/raw-accounts?region="+t;Vue.http.get(a).then(function(t){t.body.forEach(function(t,e){n.accounts.push({id:t.id,name:t.name,label:t.name})}),window.setTimeout(function(){},200),e&&e()})}}function i(e,n){e.paymentRequest.details=[],Vue.http.get("/api/v2/finance/payment-request-details/"+e.paymentRequest.order).then(function(t){e.paymentRequest.details=a.clone(t.body),e.paymentRequest.details.forEach(function(t){t.selected=!1;var e=parseInt(t.chargeOverride);isNaN(e)||0===e||(t.totalAmount=e)}),function(e,n){e.contacts=[],Vue.http.get("/api/v2/finance/payment-request-contacts/"+e.paymentRequest.order).then(function(t){e.contacts=a.clone(t.body),n&&n()})}(e,function(){n&&n()})})}return Vue.extend({template:t["edit-payment-request"],data:function(){return{paymentRequest:null,accounts:[],regions:[],loading:!1,paymentRequestAccount:null,paymentRequestRegion:null,changed:!1,confirmClosure:!1,mounting:!1,paymentRequestInitialAccount:{},paymentRequestProgress:{editing:!1,edited:!1,failed:!1},contacts:[],paymentRequestDetailsColumns:[{key:"teamId",name:"זיהוי",active:!1},{key:"championshipName",name:"אליפות",active:!0},{key:"teamNumber",name:"קבוצה",active:!0},{key:"createdAt",name:"תאריך יצירה",type:"date",active:!0},{key:"paidAmount",name:'סה"כ שולם',active:!0},{key:"totalAmount",name:"סכום לתשלום",editable:!0,type:"numeric",placeholder:"סכום",inputWidth:80,active:!0}]}},mounted:function(){var e=this;e.mounting=!0,e.paymentRequestRegion=e.paymentRequest.region.id,e.loading=!0,n(e,e.paymentRequest.region.id,function(){e.paymentRequestInitialAccount={value:e.paymentRequest.account.id,key:"id"},e.paymentRequestAccount=e.accounts.find(function(t){return t.id==e.paymentRequest.account.id}),null!=e.paymentRequestAccount&&(e.paymentRequestAccount.value=e.paymentRequestAccount.id),i(e,function(){e.loading=!1,e.$forceUpdate(),window.setTimeout(function(){e.mounting=!1},500)})})},methods:{anyTrue:a.anyTrue,isValidEmail:a.isValidEmail,isContactEmpty:function(t){var e=t.name.trim(),n=t.email.trim();return 0===e.length||0===n.length},isContactValid:function(t){return!this.isContactEmpty(t)&&a.isValidEmail(t.email,!1)},paymentRequestInvalidReason:function(){var t=this;return null==t.paymentRequestAccount||t.paymentRequestAccount.id<=0?"יש לבחור חשבון/גורם משלם":0===t.contacts.filter(t.isContactValid).length?"יש להגדיר לפחות נמען תקין אחד":null},setAccount:function(t){this.mounting||(this.changed=!0)},regionChanged:function(){var t=this;window.setTimeout(function(){t.paymentRequestAccount=null},500),n(t,t.paymentRequestRegion)},paymentRequestDetailsChanged:function(){this.mounting||(this.changed=!0)},contactChanged:function(t){this.mounting||(this.changed=!0)},removeContact:function(t){var e=this.contacts[t];this.isContactEmpty(e)?this.reallyRemoveContact(t):e.removing=!0,this.$forceUpdate()},reallyRemoveContact:function(t){var e=this,n=e.contacts[t],a=e.isContactEmpty(n);e.contacts.splice(t,1),a||e.contactChanged(t)},abortContactRemoval:function(t){this.contacts[t].removing=!1,this.$forceUpdate()},addNewContact:function(){this.contacts.push({name:"",phoneNumber:"",email:"",role:""})},savePaymentRequest:function(){var e=this,n={id:e.paymentRequest.order,region:e.paymentRequestRegion,account:e.paymentRequestAccount.id,accountName:e.paymentRequestAccount.name,totalAmount:a.sumAll(e.paymentRequest.details,"totalAmount"),contacts:e.contacts.filter(e.isContactValid),teamPayments:e.paymentRequest.details.map(function(t){return{team:t.teamId,amount:a.intOrDefault(t.totalAmount,0)}})};e.paymentRequestProgress.editing=!0,Vue.http.post("/api/v2/finance/payment-request",n).then(function(t){e.paymentRequestProgress.editing=!1,e.paymentRequestProgress.edited=!0,window.setTimeout(function(){e.confirm(n)},3e3)},function(t){e.paymentRequestProgress.editing=!1,e.paymentRequestProgress.failed=!0,console.log(t),window.setTimeout(function(){e.paymentRequestProgress.failed=!1},3e3)})},cancel:function(){var t=this;t.changed?t.confirmClosure=!0:t.$emit("close")},confirm:function(t){null==t&&(t=this.paymentRequest),this.$emit("close",t)},reallyCancel:function(){this.$emit("close")},abortCancel:function(){this.confirmClosure=!1}},computed:{},watch:{}})});