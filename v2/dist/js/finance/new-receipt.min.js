function getReceiptDate(){var e=parseInt($("#ReceiptCreationDate").text(),10);return!isNaN(e)&&0<e?new Date(e):new Date}define(["templates/finance","dialog","utils","components/selectex"],function(e,t,d){function a(n,e,t){if(n.accounts=[],0<=e){var i="/api/v2/finance/raw-accounts?region="+e;Vue.http.get(i).then(function(e){e.body.forEach(function(e,t){n.accounts.push({id:e.id,name:e.name,label:e.name})}),window.setTimeout(function(){n.creditedAccount=null},200),t&&t()})}}return Vue.extend({template:e["new-receipt"],data:function(){return{expandableObjects:{payments:!0,creditedAccounts:!1,paymentRequests:!0},creditedAccountsExpanded:!1,creditedAccountsEditMode:!1,receipt:{payments:[],remark:"",newPayment:{expanded:!0,type:-1,bank:-1,creditCardType:-1,creditCardExpireDate:-1}},paymentMethods:[d.Option(-1,"אמצעי תשלום..."),d.Option(0,"המחאה"),d.Option(1,"העברה בנקאית"),d.Option(2,"מזומן"),d.Option(3,"כרטיס אשראי")],banks:[d.Option(-1,"בנק..."),d.Option(4,"בנק יהב"),d.Option(9,"בנק הדואר"),d.Option(10,"בנק לאומי לישראל"),d.Option(11,"בנק דיסקונט"),d.Option(12,"בנק הפועלים"),d.Option(13,"בנק אגוד לישראל"),d.Option(14,"בנק אוצר החייל"),d.Option(17,"בנק מרכנתיל דיסקונט"),d.Option(20,"בנק מזרחי טפחות"),d.Option(26,"הבנק הבינלאומי הראשון"),d.Option(46,"בנק מסד"),d.Option(52,"בנק פועלי אגודת ישראל"),d.Option(54,"בנק ירושלים")],creditCardTypes:[d.Option(-1,"סוג כרטיס..."),d.Option(0,"ויזה"),d.Option(1,"מסטרקארד"),d.Option(2,"אמריקן אקספרס"),d.Option(3,"ישראכרט")],creditCardExpireDates:[d.Option(-1,"תוקף כרטיס...")],receiptProgress:{creating:!1,created:!1,failed:!1},account:null,region:null,paymentRequests:[],accounts:[],creditedAccounts:[],regions:[],creditedAccount:null,creditedAccountRegion:-1,creditedAccountSum:null,creditedAccountAlreadyExists:!1,isValid:!0,changed:!1,confirmClosure:!1,fullyPaidPaymentRequests:null,overrideInvalidReceiptReason:null,paymentRequestDetailsColumns:[{key:"championshipName",name:"אליפות",active:!0},{key:"teamNumber",name:"אינדקס קבוצה",active:!0},{key:"createdAt",name:"תאריך יצירה",type:"date",active:!0},{key:"remainingAmount",name:"נותר לתשלום",active:!0,getter:function(e){var t=parseInt(e.currentlyPaid,10);return isNaN(t)&&(t=0),e.remainingAmount-t}},{key:"currentlyPaid",name:"שולם בקבלה נוכחית",editable:!0,type:"numeric",placeholder:"סכום",inputWidth:80,active:!0}]}},mounted:function(){var e=this;e.receipt.creationDate=new Date,$("#ReceiptCreationDate").text(e.receipt.creationDate.getTime());for(var t=new Date,n=0;n<72;n++){var i=t.getMonth(),c=t.getFullYear(),r=(i+1).toString()+c.toString();e.creditCardExpireDates.push(d.Option(r,[i+1,c].join("/"),new Date(t.getTime()))),t.setMonth(i+1)}console.log(e.paymentRequests),a(e,e.creditedAccountRegion),function t(n,i){if(i>=n.paymentRequests.length){var e=n.paymentRequests.filter(function(e){return 0===e.details.length});if(0<e.length){var c=1===e.length,r=c?"תעודת חיוב":"תעודות חיוב";r+=" "+e.map(function(e){return e.parsedOrder}).join(", ")+" ",r+="כבר "+(c?"שולמה":"שולמו")+" ",r+=c?"במלואה":"במלואן",n.fullyPaidPaymentRequests=r,n.paymentRequests=n.paymentRequests.filter(function(e){return 0<e.details.length})}}else{var a=n.paymentRequests[i];Vue.http.get("/api/v2/finance/payment-request-details/"+a.order).then(function(e){a.details=d.clone(e.body),a.details=a.details.filter(function(e){return 0<e.remainingAmount}),0===a.details.length&&0<a.remainingAmount&&a.details.push({championshipName:"",championshipType:"",chargeOverride:0,createdAt:null,currentlyPaid:null,green:!1,order:a.order,paidAmount:0,payerName:"",remainingAmount:a.remainingAmount,schoolName:"",selected:!1,teamId:-1,teamNumber:"",totalAmount:a.remainingAmount}),a.details.forEach(function(e){e.selected=!1,e.currentlyPaid=null}),console.log(a.details),t(n,i+1)})}}(e,0)},methods:{toggleExpanded:function(e){if("string"==typeof e){var t=e;this.expandableObjects[t]=!this.expandableObjects[t]}else null!=e&&(e.expanded=!e.expanded)},isExpanded:function(e){return!0===this.expandableObjects[e]},setCreationDate:function(e){this.changed=!0,this.receipt.creationDate=e,$("#ReceiptCreationDate").text(this.receipt.creationDate.getTime())},receiptInvalidReason:function(){var e=this;if(null!=e.overrideInvalidReceiptReason)return e.overrideInvalidReceiptReason;var t=e.sumAllPayments();if(0===t)return"יש להזין לפחות תשלום אחד";if(e.creditedAccountsEditMode){if(0===e.creditedAccounts.length&&(null==e.creditedAccount||e.creditedAccount.id<=0))return"יש לבחור לפחות חשבון אחד לזיכוי";var n=d.sumAll(e.creditedAccounts,"sum");if(null!=e.creditedAccount&&0<e.creditedAccount.id&&(n+=d.intOrDefault(e.creditedAccountSum,0)),n<t)return"נותר סכום של "+(t-n)+" ללא זיכוי חשבון";if(t<n)return"קיים זיכוי חשבונות עודף בסכום "+(n-t)+' ש"ח'}var i=0;return e.paymentRequests.forEach(function(e){e.details&&e.details.forEach(function(e){var t=parseInt(e.currentlyPaid,10);isNaN(t)||(i+=t)})}),0===i?"יש לשייך לפחות לתעודת חיוב אחת":t<i?'סה"כ שולם עבור תעודות חיוב חורג ב-'+(i-t)+' ש"ח מסך כל התשלומים':null},creditedAccountInvalidReason:function(e){var t=this;if(t.creditedAccountsEditMode){var n=t.sumAllPayments();if(0===n)return"יש להזין תשלום כדי לשנות חשבון לזיכוי";var i=n-d.sumAll(t.creditedAccounts,"sum");if(i<=0)return"לא נותר תשלום לזכות";if(parseInt(t.creditedAccountRegion,10)<0)return"יש לבחור מחוז";if(null==t.creditedAccount||t.creditedAccount.id<=0)return"יש לבחור חשבון";if(t.creditedAccountAlreadyExists)return"חשבון כבר נמצא ברשימה";if(null==t.creditedAccountSum||0==t.creditedAccountSum)return"יש להזין סכום";if(t.creditedAccountSum>i)return"סכום גדול מסך כל תשלומים"}return null},paymentInvalidReason:function(e){var t={},n=0<=e?this.receipt.payments[e]:this.receipt.newPayment;if(null!=n){var i=parseInt(n.type,10);if(i<0)return"יש לבחור אמצעי תשלום";if(null==n.sum||""==n.sum)return"יש להזין סכום";if(0===i||1===i){if(parseInt(n.bank,10)<0)return"יש לבחור בנק";if(!d.validateNumericField(n.bankBranch,"סניף בנק",t))return t.message;if(!d.validateMaxLengthField(n.bankAccount,"מספר חשבון  בנק",15,t))return t.message;if(!d.validateDateField(n.dueDate,"תאריך פרעון",t))return t.message;if(!d.validateMaxLengthField(n.bankReference,"אסמכתא",-15,t))return t.message}else if(3===i){if(parseInt(n.creditCardType,10)<0)return"יש לבחור סוג כרטיס אשראי";if(!d.validateMinimumLengthField(n.fourLastDigits,"ארבע ספרות אחרונות",4,t))return t.message;if(parseInt(n.creditCardExpireDate,10)<0)return"יש לבחור תוקף כרטיס אשראי";if(!d.validateNumericField(n.installments,"מספר תשלומים",t))return t.message}}return null},addPayment:function(){var e=d.clone(this.receipt.newPayment);e.changed=!1,e.removing=!1,this.receipt.payments.push(e),this.receipt.newPayment={expanded:!0,type:-1,bank:-1,creditCardType:-1,creditCardExpireDate:-1}},removePayment:function(e){var t=this.receipt.payments[e];0<=t.type?t.removing=!0:this.reallyRemovePayment(e)},reallyRemovePayment:function(e){0<=e&&e<this.receipt.payments.length?this.receipt.payments.splice(e,1):(console.log("Invalid payment index: "+e),console.log(this.receipt.payments))},abortPaymentRemoval:function(e){this.receipt.payments[e].removing=!1},sumAllPayments:function(){var i=this,c=0;if(i.receipt.payments.forEach(function(e,t){if(null==i.paymentInvalidReason(t)){var n=parseInt(e.sum,10);isNaN(n)||(c+=n)}}),null==i.paymentInvalidReason(-1)){var e=parseInt(i.receipt.newPayment.sum,10);isNaN(e)||(c+=e)}return c},dataChanged:function(e){this.changed=!0,0<=e&&e<this.receipt.payments.length&&(this.receipt.payments[e].changed=!0)},editCreditedAccounts:function(){var e=this;e.creditedAccountsEditMode=!0,function(t,n){void 0===n&&(n=function(){}),t.regions=[{id:-1,name:"מחוז..."}],Vue.http.get("/api/v2/manage/regions").then(function(e){e.body.forEach(function(e){t.regions.push({id:e.Id,name:e.Name})}),n()},function(e){console.log(e),n()})}(e),e.creditedAccounts=[],e.creditedAccounts.push({id:e.account.id,name:e.account.name,sum:e.sumAllPayments(),expanded:!0,removing:!1})},creditedAccountRegionChanged:function(){a(this,this.creditedAccountRegion,function(){})},creditedAccountSumChanged:function(e){var t,n=this,i=n.sumAllPayments();if(e<0)null!=n.creditedAccounts&&1===n.creditedAccounts.length&&(t=i-d.intOrDefault(n.creditedAccountSum,0),n.creditedAccounts[0].sum=t);else if(t=i-d.intOrDefault(n.creditedAccounts[e].sum,0),n.creditedAccount&&0<n.creditedAccount.id&&!n.creditedAccountAlreadyExists)n.creditedAccountSum=t;else if(2===n.creditedAccounts.length){(0===e?n.creditedAccounts[1]:n.creditedAccounts[0]).sum=t}},setCreditedAccount:function(e){var t=this;(t.creditedAccountAlreadyExists=!1,null!=t.creditedAccount&&0<t.creditedAccount.id)&&(null==t.creditedAccounts.find(function(e){return e.id===t.creditedAccount.id})?1===t.creditedAccounts.length&&t.creditedAccounts[0].id===t.account.id&&(t.creditedAccounts[0].sum=null,t.creditedAccountSum=t.sumAllPayments()):t.creditedAccountAlreadyExists=!0)},addCreditedAccount:function(){var t=this;if(null!=t.creditedAccount&&0<t.creditedAccount.id&&0<t.creditedAccountSum){var e=t.creditedAccount.name;if(t.creditedAccountRegion!=t.region.id){var n=t.regions.find(function(e){return e.id==t.creditedAccountRegion});null!=n?e+=" ("+n.name+")":console.log("Credited account region "+t.creditedAccountRegion+" not found")}t.creditedAccounts.push({id:t.creditedAccount.id,name:e,sum:t.creditedAccountSum,expanded:!0,removing:!1}),t.creditedAccountAlreadyExists=!1,t.creditedAccountSum=null,t.creditedAccountRegion=-1,t.creditedAccount=null}},removeCreditedAccount:function(e){var t=this.creditedAccounts[e];0<t.sum?t.removing=!0:this.reallyRemoveCreditedAccount(e)},reallyRemoveCreditedAccount:function(e){var t=this;if(0<=e&&e<t.creditedAccounts.length){var n=t.creditedAccounts[e],i=d.intOrDefault(n.sum,0);t.creditedAccounts.splice(e,1),0<i&&0===t.creditedAccounts.length&&(t.creditedAccountSum=d.intOrDefault(t.creditedAccountSum,0)+i)}else console.log("Invalid credited account index: "+e),console.log(t.creditedAccounts)},abortCreditedAccountRemoval:function(e){this.creditedAccounts[e].removing=!1},paymentRequestDetailsChanged:function(e){console.log("details changed");var n=this.paymentRequests[e];n.totalCurrentlyPaid=0,console.log(this.paymentRequestDetailsColumns),n.details&&n.details.forEach(function(e){var t=parseInt(e.currentlyPaid,10);isNaN(t)&&(t=0),t<=0?e.selected=!1:(e.selected=!0,n.totalCurrentlyPaid+=t),e.green=e.remainingAmount-t<=0}),this.$forceUpdate()},isInFocus:function(e){return!0===(0<=e?this.receipt.payments[e]:this.receipt.newPayment).isFocused},dueDateFocused:function(e){(0<=e?this.receipt.payments[e]:this.receipt.newPayment).isFocused=!0,this.$forceUpdate()},dueDateBlurred:function(e){var t=this,n=0<=e?t.receipt.payments[e]:t.receipt.newPayment;window.setTimeout(function(){n.isFocused=!1,t.$forceUpdate()},500)},setDefaultDueDate:function(e){(0<=e?this.receipt.payments[e]:this.receipt.newPayment).dueDate=d.formatDate(new Date,"dd/mm/yyyy"),this.$forceUpdate()},anyTrue:d.anyTrue,saveReceipt:function(){var t=this,e=d.merge(t.receipt.newPayment,t.receipt.payments).filter(function(e){var t=parseInt(e.sum,10);return 0<=e.type&&!isNaN(t)&&0<t});if(0===e.length)return t.overrideInvalidReceiptReason="יש להזין לפחות תשלום לא ריק אחד",void window.setTimeout(function(){t.overrideInvalidReceiptReason=null},3e3);var n=e.map(function(e){return{type:parseInt(e.type,10),sum:parseInt(e.sum,10),bank:function(e){if("0"==e.type||"1"==e.type){var t=parseInt(e.bank,10);if(!isNaN(t)&&0<=t){var n=parseInt(e.bankBranch,10);return(isNaN(n)||n<=0)&&(n=null),{id:t,branch:n,account:e.bankAccount||"",reference:e.bankReference||""}}}return null}(e),creditCard:function(e,t){if("3"==t.type){var n=d.intOrDefault(t.creditCardType);if(null!=n)return{type:n,lastFourDigits:d.intOrDefault(t.fourLastDigits),expireDate:d.findTag(t.creditCardExpireDate,e.creditCardExpireDates),installments:d.intOrDefault(t.installments)}}return null}(t,e),dueDate:d.parseDate(e.dueDate)}}),i=function(e){return e.creditedAccountsEditMode?{id:e.creditedAccount&&0<e.creditedAccount.id?e.creditedAccount.id:-1,sum:e.creditedAccountSum}:{id:e.account.id,sum:e.sumAllPayments()}}(t),c=d.merge(i,t.creditedAccounts).filter(function(e){return 0<d.intOrDefault(e.sum,0)}).map(function(e){return{id:e.id,sum:parseInt(e.sum,10)}}),r=t.paymentRequests.map(function(e){var t=e.details.map(function(e){return{id:e.teamId,sum:d.intOrDefault(e.currentlyPaid,0)}}).filter(function(e){return 0<e.sum});return{id:e.id||e.Id||e.order,teams:t}}).filter(function(e){return 0<e.teams.length}),a={region:t.region.id,account:t.account.id,sum:d.sumAll(e,"sum"),date:t.receipt.creationDate,remarks:t.receipt.remark,payments:n,creditedAccounts:c,paymentRequests:r};t.receiptProgress.creating=!0,Vue.http.post("/api/v2/finance/receipt",a).then(function(e){t.receiptProgress.creating=!1,t.receiptProgress.created=!0,window.setTimeout(function(){t.receipt.id=e.body.ReceiptId,t.confirm()},3e3)},function(e){t.receiptProgress.creating=!1,t.receiptProgress.failed=!0,console.log(e),window.setTimeout(function(){t.receiptProgress.failed=!1},3e3)})},cancel:function(){this.changed?this.confirmClosure=!0:this.$emit("close")},confirm:function(){this.$emit("close",this.receipt)},reallyCancel:function(){this.$emit("close")},abortCancel:function(){this.confirmClosure=!1}},computed:{sumAll:function(){return this.sumAllPayments()}},watch:{sumAll:function(e,t){for(var n=this.sumAllPayments(),i=0;i<this.paymentRequests.length&&!(n<=0);i++){var c=this.paymentRequests[i];if(c.details)for(var r=0;r<c.details.length&&!(n<=0);r++){var a=c.details[r],d=a.remainingAmount;n<d&&(d=n),n-=a.currentlyPaid=d}}}}})});