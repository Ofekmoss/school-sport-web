define(["templates/finance","utils","dialog","services/access","consts","views","components/multiselect","generic/data-table"],function(e,r,n,o,t,i){function l(o,n){function s(e){o.paymentRequests=e,o.sports=r.filters.readAccountSports(o.paymentRequests),function(e,n){e.accounts=[];var t={};for(var i in e.paymentRequests.forEach(function(e){null!=e.account&&(t[e.account.id.toString()]=e.account)}),t){var o=t[i];e.accounts.push({id:o.id,name:o.name})}e.accounts.sort(function(e,n){return e.name.localeCompare(n.name)}),n()}(o,function(){null!=o.initialAccount&&(g(o),o.initialAccount=null),r.autoSelect(),n()})}if(void 0!==n&&null!=n||(n=new Function),o.season){o.paymentRequests.splice(0,o.paymentRequests.length);var a=["region","season","type","sport","championship","category"],u=r.buildQuerystringByFilters(o,["region","season","type"]),c=[];Vue.http.get("/api/v2/finance/payment-requests"+u).then(function(e){for(var n=0;n<e.body.length;n++){var t=e.body[n];t.green=0===t.remainingAmount,t.selected=!1,c.push(t)}o.championships=[],o.categories=[];var i=r.buildQuerystringByFilters(o,a);i.length>u.length?(c=[],Vue.http.get("/api/v2/finance/payment-requests"+i).then(function(e){for(var n=0;n<e.body.length;n++){var t=e.body[n];t.green=0===t.remainingAmount,t.selected=!1,c.push(t)}s(c)})):s(c)},function(e){console.log(e),n()})}else window.setTimeout(function(){l(o,n)},100)}function g(e){var t=a(e),i=0<t;e.paymentRequests.forEach(function(e){var n=!0;i&&null!=e.account&&(n=e.account.id===t),e.hidden=!n}),e.toggleFiltersClicked(),e.updateCaption()}function a(e){return null==e.account?0:e.account.id?e.account.id:parseInt(e.account,10)}function s(e){var n=parseInt(e.account,10);if(isNaN(n)||n<=0)for(var t=n=0;t<e.selectedRows.length;t++){var i=e.selectedRows[t];if(i.account){var o=parseInt(i.account.id,10);if(o!=n){if(0!==n){n=0;break}n=o}}}var s=null;return!isNaN(n)&&0<n&&(s=e.accounts.find(function(e){return e.id==n})),s}return Vue.extend({template:e["payment-requests"],props:{account:{},region:{},sport:{},type:{},championship:{},category:{}},data:function(){var n=this;return{tabName:"כספים",caption:"תעודות חיוב",image:"img/finance.svg",user:o.user,paymentRequests:[],columns:[{key:"order",name:"מספר תעודת חיוב",type:"documentNumber",active:!0},{key:"account.name",name:"חשבון / גורם משלם",active:!0},{key:"region.name",name:"מחוז",active:!0},{key:"totalAmount",name:"סכום",active:!0,getter:function(e){return r.filters.getAmount(n,e,"totalAmount")}},{key:"time",name:"תאריך יצירה",type:"date",active:!0},{key:"paidAmount",name:"שולם",active:!0,getter:function(e){return r.filters.getAmount(n,e,"paidAmount")}},{key:"remainingAmount",name:"נותר לתשלום",active:!0,getter:function(e){return r.filters.getAmount(n,e,"remainingAmount")}}],searchText:"",isSelectAll:!1,selectedRows:[],regions:[],allRegions:[],userRegion:null,season:null,seasons:[],mounting:null,accounts:[],initialAccount:null,sports:[],championships:[],categories:[],types:r.removeProjects(t.sportTypes),filtersOpen:!1,toggleFilterTimer:0}},mounted:function(){var e=this;e.userRegion=o.user.region,e.mounting=!0,null==e.sport&&null!=e.championship&&(e.championship=null),null==e.championship&&null!=e.category&&(e.category=null),function(t,i){void 0===i&&(i=function(){}),t.seasons.splice(0,t.seasons.length),Vue.http.get("/api/v2/manage/seasons").then(function(e){t.seasons=e.body.map(function(e){return{id:e.Id,name:e.Name}}),Vue.http.get("/api/v2/cache?key=season").then(function(e){var n=e.body.Value;null!=n?t.season=n:o.user.season&&(t.season=o.user.season),i()},function(e){i()})},function(e){console.log(e),i()})}(e,function(){!function(t,i){void 0===i&&(i=function(){}),t.regions.splice(0,t.regions.length),Vue.http.get("/api/v2/manage/regions").then(function(e){t.regions=e.body.map(function(e){return{id:e.Id,name:e.Name}}),t.allRegions=[];for(var n=0;n<t.regions.length;n++)t.allRegions.push(t.regions[n]);o.user.region&&(t.region=o.user.region),i()},function(e){console.log(e),i()})}(e,function(){r.filters.checkInitialSport(e,l,function(){e.mounting=!1,e.updateCaption()})})})},watch:{region:function(){var e=this;e.mounting||l(e,function(){e.toggleFiltersClicked()})},season:function(){var e=this;e.mounting||l(e,function(){e.toggleFiltersClicked()})},account:function(){var e=this;0===e.paymentRequests.length&&null!=e.account?e.initialAccount=e.account:g(e)},type:function(){r.filters.typeChanged(this,l)},sport:function(){r.filters.sportChanged(this,l)},championship:function(){r.filters.championshipChanged(this,l)},category:function(){r.filters.categoryChanged(this,l)}},methods:{handleSelectionChange:function(){var e=this;e.selectedRows=e.paymentRequests.filter(function(e){return 1==e.selected}),e.filtersOpen=0===e.selectedRows.length,e.$forceUpdate()},handleMoreInfo:function(e){i.openView("finance/payment-request-details",{paymentRequestId:e.order})},toggleFiltersClicked:function(){this.filtersOpen=!this.filtersOpen},toggleFiltersMouseOver:function(){var e=this;e.toggleFilterTimer&&window.clearTimeout(e.toggleFilterTimer),e.toggleFilterTimer=window.setTimeout(function(){e.toggleFiltersClicked()},5e3)},toggleFiltersMouseOut:function(){this.toggleFilterTimer&&window.clearTimeout(this.toggleFilterTimer)},searchChanged:function(){this.$forceUpdate()},sumAll:function(e){return r.filters.sumRows(this,this.paymentRequests,e)},updateCaption:function(){var e="תעודות חיוב",n=a(this),t=null;if(0<n&&null!=(t=this.accounts.find(function(e){return e.id===n}))&&(e+=" - "+t.name),null==t){var i=r.filters.buildCaption(this);0<i.length&&(e+=" - "+i.join(" - "))}this.caption=e},editPaymentRequest:function(){var o=this;if(null!=o.selectedRows&&1===o.selectedRows.length){var s=r.clone(o.selectedRows[0]);s.parsedOrder=r.parseDocumentNumber(s.order),n.open("finance/edit-payment-request",{paymentRequest:s,regions:o.regions,disableClickOutside:!0},function(e,n){if(void 0!==n&&null!=n)if(a(o)!=n.account){var t=o.accounts.find(function(e){return e.id==n.account});null==t&&(t={id:n.account,name:n.accountName},o.accounts.push(t),o.accounts.sort(function(e,n){return e.name.localeCompare(n.name)})),o.initialAccount=t,l(o)}else{var i=o.paymentRequests.find(function(e){return e.order==s.order});i.totalAmount=n.totalAmount,i.remainingAmount=i.totalAmount-i.paidAmount}})}},generateReceipt:function(){var t=s(this);if(null!=t){var e=r.clone(this.selectedRows);e.forEach(function(e){e.expanded=!1,e.parsedOrder=r.parseDocumentNumber(e.order)}),n.open("finance/new-receipt",{account:t,region:e[0].region,paymentRequests:e,disableClickOutside:!0},function(e,n){void 0!==n&&null!=n&&n.id&&i.openView("finance/receipts",{account:t.id})})}else console.log("No matching account")},receiptButtonDisabled:function(){return null==s(this)},logout:function(){o.logout()}}})});