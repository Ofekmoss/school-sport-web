define(["templates/project-supervisor","utils","dialog","services/access","components/multiselect","generic/data-table"],function(e,t,i,a){var o=1,l=2,s=[{id:1,name:"זוזו",link:"zuzu"},{id:2,name:'פכ"ל',link:"pcl"},{id:3,name:"פלא",link:"pele"}];function r(e,t){for(var a=0;a<e.length;a++){var n=e[a];if(n.id===t)return n}return null}function p(s,r){void 0===r&&(r=null);var e="/api/v2/admin/projects/"+s.project.id+"/teams?season="+s.season;Vue.http.get(e).then(function(e){s.teams=[];for(var t=0;t<e.body.length;t++){var a=e.body[t],n=Math.round(100*a.peleCount/a.players.length);a.isOk=a.activity&&1<a.activity.length&&9<a.players.length&&a.players.length<16&&20<=n&&n<=40,a.approvedByAdminAndSupervisor=0!=(a.approved&l)&&0!=(a.approved&o),s.teams.push(a)}s.teams.sort(function(e,t){return new Date(t.createdAt)-new Date(e.createdAt)}),s.totalTeams=s.teams.length,s.totalOkTeams=s.teams.filter(function(e){return e.isOk}).length,s.totalNotOkTeams=s.teams.filter(function(e){return!e.isOk}).length,s.totalApprovedTeams=s.teams.filter(function(e){return e.approvedByAdminAndSupervisor}).length,null!=r&&r()},function(e){console.log(e),null!=r&&r()})}return Vue.extend({template:e["project-teams-approval"],data:function(){return{user:a.user,isAdmin:!1,teams:[],seasons:[],season:null,mounting:!0,columns:[{key:"id",name:"זיהוי",active:!0},{key:"city.name",name:"רשות",active:!0},{key:"region.name",name:"מחוז",active:!0},{key:"item1.name",name:"ענף",getter:function(e){return e.item1?e.item1.name+(e.item1.team?" (קבוצתי)":""):null},active:!0},{key:"item1.gender",name:"מגדר",lookup:{1:"ספורטאים",2:"ספורטאיות",3:"מעורב"},active:!0},{key:"coach.certification",name:"הסמכת מאמן/ת מדריך/ה",lookup:{0:"מדריך/ה",1:"מאמן/ת"},active:!0},{name:"מספר אימונים בשבוע",getter:function(e){return e.activity?e.activity.length:""},active:!0},{name:'סה"כ ספורטאים',getter:function(e){return e.players.length},active:!0},{name:'סה"כ ספורטאי פל"א',key:"peleCount",active:!0},{name:'אחוז ספורטאי פל"א',getter:function(e){return e.players.length?Math.round(100*e.peleCount/e.players.length)+"%":"0%"},active:!0},{name:"תאריך תחילת פעילות",getter:function(e){return e.item3.startDate},active:!0},{name:"תאריך סיום פעילות",getter:function(e){return e.item3.endDate},active:!0},{name:"עומד בקריטריון כן/לא",getter:function(e){var t=Math.round(100*e.peleCount/e.players.length);return e.activity&&1<e.activity.length&&9<e.players.length&&e.players.length<16&&20<=t&&t<=40?"כן":"לא"},active:!0},{name:"אישור מנהל/ת פרוייקט",getter:function(e){if(0==(e.approved&o))return"";var t=e.approvals?e.approvals["project-team:"+o]:null;if(t){var a=new Date(t.time);return("0"+a.getDate()).slice(-2)+"/"+("0"+(a.getMonth()+1)).slice(-2)+"/"+("000"+a.getFullYear()).slice(-4)+" "+("0"+a.getHours()).slice(-2)+":"+("0"+a.getMinutes()).slice(-2)+" "+t.firstName+" "+t.lastName}return"אושר"},active:!0},{name:"אישור מפקח/ת מחוז",getter:function(e){if(0==(e.approved&l))return"";var t=e.approvals?e.approvals["project-team:"+l]:null;if(t){var a=new Date(t.time);return("0"+a.getDate()).slice(-2)+"/"+("0"+(a.getMonth()+1)).slice(-2)+"/"+("000"+a.getFullYear()).slice(-4)+" "+("0"+a.getHours()).slice(-2)+":"+("0"+a.getMinutes()).slice(-2)+" "+t.firstName+" "+t.lastName}return"אושר"},active:!0},{name:"האם הקבוצה מאושרת?",getter:function(e){return e.approvedByAdminAndSupervisor?" כן":"לא"},active:!0}],loggedUser:null,searchText:"",isSelectAll:!1,selectedTeams:[],selectedStatus:null,totalTeams:0,totalOkTeams:0,totalNotOkTeams:0,totalApprovedTeams:0,selectedTeamsCount:0}},mounted:function(){var a=this;a.isAdmin=0<=this.user.roles.indexOf("admin"),a.project=s[2],a.caption="קבוצות",a.project&&(a.caption+=" - "+a.project.name),a.seasons=[];function n(e){console.log(e),a.mounting=!1}Vue.http.get("/api/v2/manage/seasons").then(function(e){for(var t=0;t<e.body.length;t++)a.seasons.push(e.body[t]);Vue.http.get("/api/v2/season").then(function(e){var t=e.body.season;t&&(a.season=t),p(a,function(){a.mounting=!1})},n)},n)},watch:{season:function(){var e=this;e.mounting||(Vue.http.post("/api/v2/registration/season",{season:e.season}).then(function(e){},function(e){}),p(e))}},methods:{getUserApproval:function(){return 0<=a.user.roles.indexOf("admin")?o:0<=a.user.roles.indexOf("sport-admin")?l:void 0},handleSelectionChange:function(){var e=this.getUserApproval();if(e){this.selectedTeams.splice(0,this.selectedTeams.length),this.selectedStatus=null;for(var t=0;t<this.teams.length;t++){var a=this.teams[t];a.selected&&(0!=(a.approved&e)?null==this.selectedStatus&&(this.selectedStatus=1):this.selectedStatus=0,this.selectedTeams.push(a))}this.selectedTeamsCount=this.selectedTeams.length}},openTeamDetails:function(){var e=this;if(null!=e.selectedTeams&&1===e.selectedTeams.length){var t=e.selectedTeams[0],a="/api/v2/registration/project/"+e.project.id+"/teams?team="+t.id+"&players=1&season="+e.season;Vue.http.get(a).then(function(e){if(e.body&&0<e.body.length){var t=e.body[0];if(t.sport=JSON.parse(t.item1),t.association=JSON.parse(t.item2),t.item3){var a=JSON.parse(t.item3);t.alternativeFacility=a.alternativeFacility,t.startDate=a.startDate,t.endDate=a.endDate}if(t.approvedByAdminAndSupervisor=0!=(t.approved&l)&&0!=(t.approved&l),t.players)for(var n=0;n<t.players.length;n++){var s=t.players[n];if(s.item1){var r=JSON.parse(s.item1);r&&(s.isPele=r.isPele,s.peleJoinDate=r.peleJoinDate)}!s.yearOfBirth&&s.birthDate&&(s.yearOfBirth=new Date(s.birthDate).getFullYear())}i.open("project-supervisor/project-team-details",{team:t},function(e,t){})}else alert("שגיאה כללית, נא לנסות שוב מאוחר יותר")})}},approveTeams:function(){if(0!==this.selectedTeams.length){var n=this.getUserApproval();if(n){for(var e=[],t=0;t<this.selectedTeams.length;t++){var a=this.selectedTeams[t];1!=(a.approved&n)&&e.push(a.id)}var s=this;Vue.http.post("/api/v2/admin/projects/"+encodeURIComponent(this.project.id)+"/teams/approval",{teams:e,approve:n}).then(function(e){s.selectedStatus=1;for(var t=0;t<e.body.length;t++){var a=r(s.teams,e.body[t]);console.log(a),a&&(a.approved|=n,a.approvals["project-team:"+n]={time:new Date})}},function(e){console.log(e)})}}},clearTeamsApprove:function(){if(0!==this.selectedTeams.length){var n=this.getUserApproval();if(n){for(var e=[],t=0;t<this.selectedTeams.length;t++){var a=this.selectedTeams[t];0!=(a.approved&n)&&e.push(a.id)}var s=this;Vue.http.post("/api/v2/admin/projects/"+encodeURIComponent(this.project.id)+"/teams/approval",{teams:e,clear:n}).then(function(e){for(var t=s.selectedStatus=0;t<e.body.length;t++){var a=r(s.teams,e.body[t]);a&&(a.approved=(a.approved||0)&~n)}},function(e){console.log(e)})}}},logout:function(){a.logout()}}})});